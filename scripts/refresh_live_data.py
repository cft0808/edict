#!/usr/bin/env python3
import json, pathlib, datetime

BASE = pathlib.Path(__file__).parent.parent
DATA = BASE / 'data'


def read_json(path, default):
    try:
        return json.loads(path.read_text())
    except Exception:
        return default


def output_meta(path):
    p = pathlib.Path(path)
    if not p.exists():
        return {"exists": False, "lastModified": None}
    ts = datetime.datetime.fromtimestamp(p.stat().st_mtime).strftime('%Y-%m-%d %H:%M:%S')
    return {"exists": True, "lastModified": ts}


def main():
    officials = read_json(DATA / 'officials.json', [])
    # ä»»åŠ¡æºä¼˜å…ˆï¼štasks_source.jsonï¼ˆå¯å¯¹æ¥å¤–éƒ¨ç³»ç»ŸåŒæ­¥å†™å…¥ï¼‰
    tasks = read_json(DATA / 'tasks_source.json', [])
    if not tasks:
        tasks = read_json(DATA / 'tasks.json', [])

    sync_status = read_json(DATA / 'sync_status.json', {})

    org_map = {o['name']: o.get('org', '') for o in officials}

    now_ts = datetime.datetime.now(datetime.timezone.utc)
    for t in tasks:
        t['org'] = t.get('org') or org_map.get(t.get('official', ''), '')
        t['outputMeta'] = output_meta(t.get('output', ''))

        # å¿ƒè·³æ—¶æ•ˆæ£€æµ‹ï¼šå¯¹ Doing/Assigned çŠ¶æ€çš„ä»»åŠ¡æ ‡æ³¨æ´»è·ƒåº¦
        if t.get('state') in ('Doing', 'Assigned', 'Review'):
            updated_raw = t.get('updatedAt') or t.get('sourceMeta', {}).get('updatedAt')
            age_sec = None
            if updated_raw:
                try:
                    if isinstance(updated_raw, (int, float)):
                        updated_dt = datetime.datetime.fromtimestamp(updated_raw / 1000, tz=datetime.timezone.utc)
                    else:
                        updated_dt = datetime.datetime.fromisoformat(str(updated_raw).replace('Z', '+00:00'))
                    age_sec = (now_ts - updated_dt).total_seconds()
                except Exception:
                    pass
            if age_sec is None:
                t['heartbeat'] = {'status': 'unknown', 'label': 'âšª æœªçŸ¥', 'ageSec': None}
            elif age_sec < 180:
                t['heartbeat'] = {'status': 'active', 'label': f'ğŸŸ¢ æ´»è·ƒ {int(age_sec//60)}åˆ†é’Ÿå‰', 'ageSec': int(age_sec)}
            elif age_sec < 600:
                t['heartbeat'] = {'status': 'warn', 'label': f'ğŸŸ¡ å¯èƒ½åœæ» {int(age_sec//60)}åˆ†é’Ÿå‰', 'ageSec': int(age_sec)}
            else:
                t['heartbeat'] = {'status': 'stalled', 'label': f'ğŸ”´ å·²åœæ» {int(age_sec//60)}åˆ†é’Ÿ', 'ageSec': int(age_sec)}
        else:
            t['heartbeat'] = None

    today_done = sum(1 for t in tasks if t.get('state') == 'Done')
    in_progress = sum(1 for t in tasks if t.get('state') in ['Doing', 'Review', 'Next', 'Blocked'])
    blocked = sum(1 for t in tasks if t.get('state') == 'Blocked')

    history = []
    for t in tasks:
        if t.get('state') == 'Done':
            lm = t.get('outputMeta', {}).get('lastModified')
            history.append({
                'at': lm or 'æœªçŸ¥',
                'official': t.get('official'),
                'task': t.get('title'),
                'out': t.get('output'),
                'qa': 'é€šè¿‡' if t.get('outputMeta', {}).get('exists') else 'å¾…è¡¥æˆæœ'
            })

    payload = {
        'generatedAt': datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'taskSource': 'tasks_source.json' if (DATA / 'tasks_source.json').exists() else 'tasks.json',
        'officials': officials,
        'tasks': tasks,
        'history': history,
        'metrics': {
            'officialCount': len(officials),
            'todayDone': today_done,
            'inProgress': in_progress,
            'blocked': blocked
        },
        'syncStatus': sync_status,
        'health': {
            'syncOk': bool(sync_status.get('ok', False)),
            'syncLatencyMs': sync_status.get('durationMs'),
            'missingFieldCount': len(sync_status.get('missingFields', {})),
        }
    }

    (DATA / 'live_status.json').write_text(json.dumps(payload, ensure_ascii=False, indent=2))
    print('updated live_status.json')


if __name__ == '__main__':
    main()
