<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å†›æœºå¤„ Â· ä¸‰çœå…­éƒ¨æ€»æ§å°</title>
  <style>
    :root{
      --bg:#07090f;--panel:#0f1219;--panel2:#141824;--line:#1c2236;
      --text:#dde4f8;--muted:#5a6b92;--ok:#2ecc8a;--warn:#f5c842;--danger:#ff5270;
      --acc:#6a9eff;--acc2:#a07aff;--acc3:#ff9a6a;
      --r0:#a07aff;--r1:#6a9eff;--r2:#6aef9a;
      --r3:#f5c842;--r4:#ff9a6a;--r5:#ff5270;--r6:#c44;--r7:#44aaff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:"PingFang SC",Inter,-apple-system,"Segoe UI",sans-serif;min-height:100vh}
    ::-webkit-scrollbar{width:4px;height:4px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:#1e2538;border-radius:4px}

    /* â”€â”€ LAYOUT â”€â”€ */
    .wrap{max-width:1520px;margin:0 auto;padding:16px}

    /* â”€â”€ HEADER â”€â”€ */
    .hdr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--line)}
    .logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,#6a9eff,#a07aff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .sub{font-size:11px;color:var(--muted);margin-top:1px}
    .hdr-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{font-size:11px;padding:3px 9px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted)}
    .chip.ok{border-color:#2ecc8a44;color:var(--ok)}
    .chip.warn{border-color:#f5c84244;color:var(--warn)}
    .chip.err{border-color:#ff527044;color:var(--danger)}
    #next-refresh{font-size:11px;color:var(--muted)}

    /* â”€â”€ SEARCH â”€â”€ */
    .search-bar{display:flex;gap:8px;align-items:center;margin-bottom:14px}
    .search-input{flex:1;max-width:380px;background:var(--panel);border:1px solid var(--line);border-radius:8px;color:var(--text);padding:7px 12px;font-size:13px;outline:none}
    .search-input:focus{border-color:var(--acc)}
    .search-input::placeholder{color:var(--muted)}

    /* â”€â”€ TABS â”€â”€ */
    .tabs{display:flex;gap:2px;margin-bottom:18px;border-bottom:1px solid var(--line);overflow-x:auto;padding-bottom:0}
    .tab{font-size:13px;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;color:var(--muted);border:1px solid transparent;border-bottom:none;white-space:nowrap;position:relative;bottom:-1px;transition:all .15s;user-select:none}
    .tab:hover{color:var(--text);background:var(--panel)}
    .tab.active{color:var(--text);background:var(--panel);border-color:var(--line);font-weight:600}
    .tab-badge{font-size:10px;padding:1px 5px;border-radius:999px;background:#1a2040;color:var(--acc);margin-left:4px}
    .panel{display:none}.panel.active{display:block}

    /* â”€â”€ METRICS â”€â”€ */
    .metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:18px}
    .mcard{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:3px;cursor:default}
    .mcard .ml{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .mcard .mv{font-size:28px;font-weight:800;line-height:1}
    .mcard .ms{font-size:11px;color:var(--muted)}
    .mv.ok{color:var(--ok)}.mv.warn{color:var(--warn)}.mv.danger{color:var(--danger)}

    /* â”€â”€ OVERVIEW: 2-col layout â”€â”€ */
    .overview-grid{display:grid;grid-template-columns:1fr 340px;gap:14px;margin-bottom:18px}
    @media(max-width:900px){.overview-grid{grid-template-columns:1fr}}

    /* â”€â”€ AGENT HEALTH CARDS â”€â”€ */
    .agents-panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .ap-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;margin-bottom:12px}
    .agent-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;margin-bottom:4px;cursor:default}
    .agent-row:hover{background:var(--panel2)}
    .ag-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .ag-dot.active{background:var(--ok);box-shadow:0 0 6px var(--ok)}
    .ag-dot.warn{background:var(--warn)}
    .ag-dot.stalled{background:var(--danger);animation:pulse2 1.2s infinite}
    .ag-dot.idle{background:var(--muted)}
    @keyframes pulse2{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
    .ag-info{flex:1;min-width:0}
    .ag-name{font-size:12px;font-weight:600}
    .ag-model{font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ag-hb{font-size:10px;color:var(--muted);flex-shrink:0;text-align:right}

    /* â”€â”€ CHARTS â”€â”€ */
    .charts-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:18px}
    .chart-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .cc-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;margin-bottom:12px}
    .bar-chart{display:flex;flex-direction:column;gap:7px}
    .bar-row{display:flex;align-items:center;gap:8px;font-size:11px}
    .bar-label{min-width:55px;color:var(--muted);text-align:right}
    .bar-track{flex:1;background:#0e1320;border-radius:3px;height:14px;overflow:hidden}
    .bar-fill{height:100%;border-radius:3px;transition:width .5s ease}
    .bar-val{min-width:20px;text-align:right;color:var(--text);font-weight:600}
    .donut-wrap{display:flex;align-items:center;gap:14px}
    .donut-legend{display:flex;flex-direction:column;gap:5px}
    .dl-item{display:flex;align-items:center;gap:6px;font-size:11px}
    .dl-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

    /* â”€â”€ PIPELINE â”€â”€ */
    .pipe-wrap{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:18px}
    .pipe-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;margin-bottom:12px}
    .pipe{display:flex;align-items:center;gap:0;overflow-x:auto;padding-bottom:4px}
    .pipe-stage{display:flex;align-items:center;flex-shrink:0}
    .pn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 16px;border-radius:10px;min-width:90px;cursor:default}
    .pn.has-tasks{background:#1a2040;border:1px solid var(--acc)}
    .pn-icon{font-size:20px}
    .pn-label{font-size:10px;color:var(--muted)}
    .pn.has-tasks .pn-label{color:var(--acc)}
    .pn-count{font-size:11px;font-weight:700;color:var(--acc)}
    .pipe-arrow{color:#1c2236;font-size:16px;padding:0 4px;flex-shrink:0}

    /* â”€â”€ FILTER BAR â”€â”€ */
    .filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    .fb{font-size:12px;padding:4px 11px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted);cursor:pointer;user-select:none;transition:all .1s}
    .fb:hover{border-color:#2e3d6a;color:var(--text)}
    .fb.active{border-color:var(--acc);color:var(--acc);background:#0a1228}
    .fsep{width:1px;height:18px;background:var(--line);margin:0 4px}

    /* â”€â”€ KANBAN â”€â”€ */
    .kanban{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:10px;align-items:start}
    .k-col{background:var(--panel);border:1px solid var(--line);border-radius:11px;overflow:hidden}
    .k-hdr{display:flex;align-items:center;justify-content:space-between;padding:9px 13px;border-bottom:1px solid var(--line);background:var(--panel2)}
    .k-hdr .kn{font-size:11px;font-weight:700;letter-spacing:.04em}
    .k-hdr .kc{font-size:11px;padding:1px 6px;border-radius:999px;background:#0a0e1a;color:var(--muted)}
    .k-cards{padding:8px;display:flex;flex-direction:column;gap:7px;min-height:40px}
    .k-empty{font-size:11px;color:var(--muted);text-align:center;padding:12px 0;opacity:.4}

    /* â”€â”€ TASK CARD â”€â”€ */
    .tc{background:var(--panel2);border:1px solid var(--line);border-radius:9px;padding:11px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
    .tc:hover{border-color:#2e3d6a;box-shadow:0 2px 12px rgba(0,0,0,.3)}
    .tc .cid{font-size:10px;color:var(--acc);font-weight:700;letter-spacing:.03em;margin-bottom:2px}
    .tc .corg{display:inline-block;font-size:10px;padding:1px 6px;border-radius:4px;margin-bottom:3px;font-weight:600}
    .tc .ctitle{font-size:13px;font-weight:600;line-height:1.4;margin-bottom:6px}
    .tc .cmeta{font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:2px}
    .tc .cfoot{display:flex;justify-content:space-between;align-items:center;margin-top:7px;flex-wrap:wrap;gap:3px}
    .hb{font-size:10px;padding:2px 7px;border-radius:999px;border:1px solid var(--line)}
    .hb.active{border-color:#2ecc8a44;color:var(--ok)}
    .hb.warn{border-color:#f5c84244;color:var(--warn)}
    .hb.stalled{border-color:#ff527044;color:var(--danger);animation:pulse2 1.5s infinite}
    .hb.unknown{color:var(--muted)}

    /* STATE */
    .s-Inbox{border-color:#3a4a7a44;color:#7a9aff;background:#0a1028}
    .s-Zhongshu{border-color:#4a3a7a44;color:#a07aff;background:#110a28}
    .s-Menxia{border-color:#7a4a3a44;color:#ff9a6a;background:#280f0a}
    .s-Assigned{border-color:#3a6a4a44;color:#6aef9a;background:#0a2018}
    .s-Doing{border-color:#2a5aaa44;color:#7aafff;background:#0a1428}
    .s-Review{border-color:#7a6a2a44;color:#f5c842;background:#201a08}
    .s-Done{border-color:#2a7a5a44;color:var(--ok);background:#0a2018}
    .s-Blocked{border-color:#7a2a3a44;color:var(--danger);background:#200a10}
    .s-Next{border-color:#2a4a6a44;color:#4a9adf;background:#0a1424}

    /* ORG */
    .o-0{color:var(--r0);background:#1a0f38}
    .o-1{color:var(--r1);background:#0f1a38}
    .o-2{color:var(--r2);background:#0a2018}
    .o-3{color:var(--r3);background:#201a08}
    .o-4{color:var(--r4);background:#28100a}
    .o-5{color:var(--r5);background:#280a10}
    .o-6{color:#cc4444;background:#280808}
    .o-7{color:#44aaff;background:#081828}

    /* â”€â”€ HISTORY â”€â”€ */
    .hist-section{margin-bottom:16px}
    .dept-hdr{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--panel);border:1px solid var(--line);border-radius:10px 10px 0 0;cursor:pointer;user-select:none}
    .dept-hdr .dh-arrow{font-size:12px;color:var(--muted);transition:transform .2s;margin-left:auto}
    .dept-hdr.open .dh-arrow{transform:rotate(90deg)}
    .dept-body{display:none;background:var(--panel);border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px}
    .dept-body.open{display:block}
    .hist-row{display:grid;grid-template-columns:130px 1fr 90px 70px;gap:10px;padding:9px 14px;border-bottom:1px solid var(--line);font-size:12px;align-items:center;cursor:pointer}
    .hist-row:last-of-type{border-bottom:none}
    .hist-row:hover{background:var(--panel2)}
    .hr-time{color:var(--muted);font-size:11px}
    .hr-qa{text-align:center}
    .hr-link{color:var(--acc);font-size:11px}
    .flow-log-wrap{padding:12px 14px;background:var(--bg);border-top:1px solid var(--line);display:none}
    .flow-log-wrap.open{display:block}
    .fl-row{display:flex;gap:8px;padding:5px 0;font-size:11px;border-bottom:1px solid #0e1320}
    .fl-row:last-child{border-bottom:none}
    .fl-time{color:var(--muted);min-width:110px;flex-shrink:0}
    .fl-from{color:var(--acc);font-weight:600;min-width:55px}
    .fl-to{color:var(--acc2);font-weight:600;min-width:55px}
    .fl-sep{color:var(--muted)}
    .fl-rem{color:var(--text)}

    /* â”€â”€ TIMELINE â”€â”€ */
    .timeline{display:flex;flex-direction:column;gap:0;position:relative}
    .timeline::before{content:'';position:absolute;left:80px;top:0;bottom:0;width:1px;background:var(--line)}
    .tl-item{display:flex;gap:0;position:relative;padding:8px 0}
    .tl-time{min-width:80px;font-size:11px;color:var(--muted);text-align:right;padding-right:16px;flex-shrink:0;padding-top:2px}
    .tl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px;position:relative;z-index:1}
    .tl-content{padding-left:12px;flex:1;min-width:0}
    .tl-who{font-size:12px;font-weight:600;margin-bottom:2px}
    .tl-desc{font-size:11px;color:var(--muted);line-height:1.5}

    /* â”€â”€ MODEL CONFIG â”€â”€ */
    .model-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:12px;margin-bottom:20px}
    .mc-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;transition:border-color .15s}
    .mc-card:hover{border-color:#2e3d6a}
    .mc-top{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .mc-emoji{font-size:22px}
    .mc-name{font-size:15px;font-weight:700}
    .mc-role{font-size:11px;color:var(--muted)}
    .mc-cur{font-size:11px;color:var(--muted);margin-bottom:8px}
    .mc-cur span{color:var(--text);font-weight:500}
    .msel{width:100%;background:var(--panel2);border:1px solid var(--line);border-radius:7px;color:var(--text);padding:7px 10px;font-size:12px;outline:none;cursor:pointer}
    .msel:focus{border-color:var(--acc)}
    .mc-btns{display:flex;gap:6px;margin-top:8px}
    .btn{font-size:12px;padding:6px 14px;border-radius:7px;border:none;cursor:pointer;font-weight:600;transition:all .15s}
    .btn-p{background:var(--acc);color:#000}.btn-p:hover{background:#89b4ff}.btn-p:disabled{background:#2a3a6a;color:var(--muted);cursor:not-allowed}
    .btn-g{background:transparent;border:1px solid var(--line);color:var(--muted)}.btn-g:hover{border-color:#2e3d6a;color:var(--text)}
    .mc-status{font-size:11px;margin-top:6px;padding:4px 8px;border-radius:5px;display:none}
    .mc-status.ok{display:block;background:#0a2018;color:var(--ok);border:1px solid #2ecc8a44}
    .mc-status.err{display:block;background:#200a10;color:var(--danger);border:1px solid #ff527044}
    .mc-status.pending{display:block;background:#0a1228;color:var(--acc);border:1px solid #6a9eff44}
    .cl-wrap{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin-top:14px}
    .cl-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;margin-bottom:10px}
    .cl-row{display:flex;gap:10px;font-size:11px;padding:5px 0;border-bottom:1px solid var(--line)}
    .cl-row:last-child{border-bottom:none}
    .cl-t{color:var(--muted);min-width:115px}.cl-a{color:var(--acc);min-width:80px}.cl-c{color:var(--muted)}
    .cl-c b{color:var(--text)}

    /* â”€â”€ SKILLS â”€â”€ */
    .skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:12px}
    .sk-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .sk-hdr{display:flex;align-items:center;gap:9px;padding:11px 14px;background:var(--panel2);border-bottom:1px solid var(--line)}
    .sk-emoji{font-size:18px}.sk-name{font-size:14px;font-weight:700}.sk-cnt{font-size:11px;color:var(--muted);margin-left:auto}
    .sk-list{padding:10px}
    .sk-item{display:flex;gap:8px;padding:6px 8px;border-radius:7px;font-size:12px;margin-bottom:3px}
    .sk-item:hover{background:var(--panel2)}
    .si-name{font-weight:600;min-width:100px}.si-desc{color:var(--muted);flex:1;line-height:1.4}
    .sk-empty{font-size:12px;color:var(--muted);padding:12px;text-align:center;opacity:.6}

    /* â”€â”€ DRAWER â”€â”€ */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;backdrop-filter:blur(2px)}
    .overlay.open{display:block}
    .drawer{position:fixed;right:-540px;top:0;bottom:0;width:540px;background:var(--panel);border-left:1px solid var(--line);z-index:101;overflow-y:auto;transition:right .25s cubic-bezier(.4,0,.2,1)}
    .drawer.open{right:0}
    .dr-hdr{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;z-index:1}
    .dr-close{font-size:18px;cursor:pointer;color:var(--muted);width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px}
    .dr-close:hover{background:var(--panel2);color:var(--text)}
    .dr-body{padding:16px}
    .dr-id{font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:3px}
    .dr-title{font-size:17px;font-weight:700;line-height:1.4;margin-bottom:12px}
    .sec{margin-bottom:16px}
    .sec-lbl{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--line)}
    .drow{display:flex;gap:8px;font-size:12px;padding:5px 0;border-bottom:1px solid #0e1320}
    .drow:last-child{border-bottom:none}
    .dk{color:var(--muted);min-width:75px;flex-shrink:0}.dv{color:var(--text);word-break:break-all}
    .act-list{display:flex;flex-direction:column;gap:0}
    .act-i{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid #0e1320;font-size:11px}
    .act-i:last-child{border-bottom:none}
    .act-t{color:var(--muted);min-width:55px;flex-shrink:0}
    .ak{padding:1px 5px;border-radius:3px;font-size:10px;font-weight:600;flex-shrink:0;height:fit-content;margin-top:1px}
    .ak-tool{background:#0a1228;color:var(--acc)}.ak-assistant{background:#0a2018;color:var(--ok)}.ak-user{background:#200a10;color:var(--danger)}
    .act-tx{color:var(--text);line-height:1.5;word-break:break-all;flex:1}

    /* â”€â”€ TOAST â”€â”€ */
    #toaster{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:200}
    .toast{font-size:13px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.4);animation:tin .2s ease;max-width:320px}
    .toast.ok{border-color:#2ecc8a55;background:#0a1a10}.toast.err{border-color:#ff527055;background:#200a10}
    @keyframes tin{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}

    /* â”€â”€ MISC â”€â”€ */
    .sec-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:10px}
    .empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:13px}
    .tag{font-size:10px;padding:2px 7px;border-radius:4px;border:1px solid;display:inline-block;white-space:nowrap}
    .pill-ok{border-color:#2ecc8a44;color:var(--ok);background:#0a1a10}
    .pill-warn{border-color:#f5c84244;color:var(--warn);background:#1a1408}
    .pill-err{border-color:#ff527044;color:var(--danger);background:#200a10}
    code{font-size:11px;background:var(--panel2);padding:2px 6px;border-radius:4px;font-family:monospace}
  </style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="hdr">
    <div>
      <div class="logo">âš”ï¸ å†›æœºå¤„ Â· ä¸‰çœå…­éƒ¨æ€»æ§å°</div>
      <div class="sub">OpenClaw Multi-Agent Orchestration Dashboard</div>
    </div>
    <div class="hdr-right">
      <span class="chip" id="chip-sync">âŸ³ åŒæ­¥ä¸­</span>
      <span class="chip" id="chip-tasks">â€” ä»»åŠ¡</span>
      <span class="chip" id="chip-agents">â€” å®˜å‘˜</span>
      <span id="next-refresh"></span>
      <input type="text" class="search-input" id="search-input" placeholder="ğŸ” æœç´¢ä»»åŠ¡ ID / æ ‡é¢˜ / å®˜å‘˜â€¦" style="max-width:260px" oninput="onSearch(this.value)">
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="overview">ğŸ  æ€»è§ˆ</div>
    <div class="tab" data-tab="kanban">ğŸ“‹ ä»»åŠ¡çœ‹æ¿ <span class="tab-badge" id="tb-doing">0</span></div>
    <div class="tab" data-tab="history">ğŸ“Š å·¥ä½œè®°å½• <span class="tab-badge" id="tb-done">0</span></div>
    <div class="tab" data-tab="timeline">â±ï¸ æ—¶é—´çº¿</div>
    <div class="tab" data-tab="models">âš™ï¸ æ¨¡å‹é…ç½®</div>
    <div class="tab" data-tab="skills">ğŸ› ï¸ æŠ€èƒ½é…ç½®</div>
  </div>

  <!-- â•â• TAB: æ€»è§ˆ â•â• -->
  <div class="panel active" id="panel-overview">
    <div class="metrics" id="metrics-row"></div>
    <div class="overview-grid">
      <div>
        <!-- pipeline -->
        <div class="pipe-wrap">
          <div class="pipe-title">æµç¨‹ç®¡çº¿ Â· ä»»åŠ¡æµå‘</div>
          <div class="pipe" id="pipeline"></div>
        </div>
        <!-- charts -->
        <div class="charts-row" id="charts-row"></div>
      </div>
      <!-- agents health -->
      <div class="agents-panel">
        <div class="ap-title">Agent å¥åº·çŠ¶æ€</div>
        <div id="agents-health"></div>
      </div>
    </div>
  </div>

  <!-- â•â• TAB: ä»»åŠ¡çœ‹æ¿ â•â• -->
  <div class="panel" id="panel-kanban">
    <div class="filter-bar" id="filter-bar">
      <span class="fb active" data-f="all">å…¨éƒ¨</span>
      <span class="fsep"></span>
      <span class="fb" data-f="ä¸‰çœå…­éƒ¨">â›©ï¸ ä¸‰çœ</span>
      <span class="fb" data-f="å…­éƒ¨">ğŸ›ï¸ å…­éƒ¨</span>
      <span class="fsep"></span>
      <span class="fb" data-f="ä¸­ä¹¦çœ">ğŸ“œ ä¸­ä¹¦çœ</span>
      <span class="fb" data-f="é—¨ä¸‹çœ">ğŸ” é—¨ä¸‹çœ</span>
      <span class="fb" data-f="å°šä¹¦çœ">ğŸ“® å°šä¹¦çœ</span>
      <span class="fsep"></span>
      <span class="fb" data-f="ç¤¼éƒ¨">ğŸ“ ç¤¼éƒ¨</span>
      <span class="fb" data-f="æˆ·éƒ¨">ğŸ’° æˆ·éƒ¨</span>
      <span class="fb" data-f="å…µéƒ¨">âš”ï¸ å…µéƒ¨</span>
      <span class="fb" data-f="åˆ‘éƒ¨">âš–ï¸ åˆ‘éƒ¨</span>
      <span class="fb" data-f="å·¥éƒ¨">ğŸ”§ å·¥éƒ¨</span>
    </div>
    <div class="kanban" id="kanban-board"></div>
  </div>

  <!-- â•â• TAB: å·¥ä½œè®°å½• â•â• -->
  <div class="panel" id="panel-history">
    <div id="history-content"></div>
  </div>

  <!-- â•â• TAB: æ—¶é—´çº¿ â•â• -->
  <div class="panel" id="panel-timeline">
    <div class="chart-card" style="margin-bottom:14px">
      <div class="cc-title">å…¨å±€äº‹ä»¶æ—¶é—´çº¿ï¼ˆæœ€è¿‘å·²å®Œæˆä»»åŠ¡çš„æµè½¬è®°å½•ï¼‰</div>
      <div class="timeline" id="timeline-content"></div>
    </div>
  </div>

  <!-- â•â• TAB: æ¨¡å‹é…ç½® â•â• -->
  <div class="panel" id="panel-models">
    <div class="sec-title" style="margin-bottom:14px">
      å„çœéƒ¨ Â· æ¨¡å‹é…ç½®
      <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:var(--muted);margin-left:6px">æ›´æ”¹åè‡ªåŠ¨é‡å¯ Gateway ç”Ÿæ•ˆï¼ˆçº¦ 5 ç§’ï¼‰</span>
    </div>
    <div class="model-grid" id="model-grid"></div>
    <div class="cl-wrap">
      <div class="cl-title">å˜æ›´è®°å½•</div>
      <div id="cl-list"></div>
    </div>
  </div>

  <!-- â•â• TAB: æŠ€èƒ½é…ç½® â•â• -->
  <div class="panel" id="panel-skills">
    <div class="sec-title" style="margin-bottom:14px">å„çœéƒ¨ Â· Skills é…ç½®</div>
    <div class="skills-grid" id="skills-grid"></div>
  </div>
</div>

<!-- DRAWER -->
<div class="overlay" id="overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="dr-hdr">
    <span id="dr-hdr-id" style="font-size:13px;font-weight:700">ä»»åŠ¡è¯¦æƒ…</span>
    <span class="dr-close" onclick="closeDrawer()">âœ•</span>
  </div>
  <div class="dr-body" id="dr-body"></div>
</div>

<!-- TOAST -->
<div id="toaster"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API = 'http://127.0.0.1:7891/api';
let liveStatus = null, agentConfig = null;
let activeTab = 'overview', orgFilter = 'all', searchQ = '';
let refreshCountdown = 15;

const ORG_MAP = {'ä¸­ä¹¦çœ':'o-0','é—¨ä¸‹çœ':'o-1','å°šä¹¦çœ':'o-2','ç¤¼éƒ¨':'o-3','æˆ·éƒ¨':'o-4','å…µéƒ¨':'o-5','åˆ‘éƒ¨':'o-6','å·¥éƒ¨':'o-7'};
const ORG_EMOJI = {'ä¸­ä¹¦çœ':'ğŸ“œ','é—¨ä¸‹çœ':'ğŸ”','å°šä¹¦çœ':'ğŸ“®','ç¤¼éƒ¨':'ğŸ“','æˆ·éƒ¨':'ğŸ’°','å…µéƒ¨':'âš”ï¸','åˆ‘éƒ¨':'âš–ï¸','å·¥éƒ¨':'ğŸ”§'};
const ORG_COLOR = {'ä¸­ä¹¦çœ':'var(--r0)','é—¨ä¸‹çœ':'var(--r1)','å°šä¹¦çœ':'var(--r2)','ç¤¼éƒ¨':'var(--r3)','æˆ·éƒ¨':'var(--r4)','å…µéƒ¨':'var(--r5)','åˆ‘éƒ¨':'var(--r6)','å·¥éƒ¨':'var(--r7)'};
const STATE_LABEL = {Inbox:'æ”¶ä»¶ç®±',Zhongshu:'ä¸­ä¹¦è§„åˆ’',Menxia:'é—¨ä¸‹å®¡è®®',Assigned:'å·²æ´¾å‘',Doing:'æ‰§è¡Œä¸­',Review:'å¾…å®¡æŸ¥',Done:'å·²å®Œæˆ',Blocked:'é˜»å¡',Next:'å¾…æ‰§è¡Œ'};
const STATE_ORDER = ['Inbox','Zhongshu','Menxia','Assigned','Doing','Review','Done','Blocked','Next'];
const PIPE_STAGES = [
  {key:'Inbox',    label:'æ”¶ä»¶',   icon:'ğŸ“¥'},
  {key:'Zhongshu', label:'è§„åˆ’',   icon:'ğŸ“œ'},
  {key:'Menxia',   label:'å®¡è®®',   icon:'ğŸ”'},
  {key:'Assigned', label:'æ´¾å‘',   icon:'ğŸ“®'},
  {key:'Doing',    label:'æ‰§è¡Œ',   icon:'âš™ï¸'},
  {key:'Review',   label:'å®¡æŸ¥',   icon:'ğŸ”'},
  {key:'Done',     label:'å®Œæˆ',   icon:'âœ…'},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const esc = s => s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : '';
async function fetchJ(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw Error(`${r.status}`);return r.json()}
async function postJ(u,d){const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});return r.json()}
function toast(msg,type='ok',ms=3000){const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;document.getElementById('toaster').appendChild(el);setTimeout(()=>el.remove(),ms)}
function orgCls(org){return ORG_MAP[org]||'o-0'}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onSearch(q){searchQ=q.toLowerCase().trim();if(liveStatus)renderKanban(liveStatus.tasks||[])}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateHeader(s){
  const sync=s.syncStatus||{};
  const cs=document.getElementById('chip-sync');
  cs.textContent=sync.ok?'âœ… åŒæ­¥æ­£å¸¸':'âš ï¸ åŒæ­¥å¼‚å¸¸';
  cs.className=`chip ${sync.ok?'ok':'warn'}`;
  document.getElementById('chip-tasks').textContent=`${(s.tasks||[]).length} ä»»åŠ¡`;
  document.getElementById('chip-agents').textContent=`${(s.officials||[]).length} å®˜å‘˜`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   METRICS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMetrics(m,tasks){
  const stalled=(tasks||[]).filter(t=>t.heartbeat&&t.heartbeat.status==='stalled').length;
  const blocked=(tasks||[]).filter(t=>t.state==='Blocked').length;
  document.getElementById('metrics-row').innerHTML=`
    ${mc('æ‰§è¡Œä¸­',m.inProgress||0,'ä»»åŠ¡',m.inProgress>0?'warn':'')}
    ${mc('ä»Šæ—¥å®Œæˆ',m.todayDone||0,'ä»»åŠ¡','ok')}
    ${mc('é˜»å¡',blocked,'ä»»åŠ¡',blocked>0?'danger':'')}
    ${mc('å¿ƒè·³åœæ»',stalled,'ä¼šè¯',stalled>0?'danger':'')}
    ${mc('æ€»ä»»åŠ¡',(tasks||[]).length,'æ¡ç›®','')}
    ${mc('å®˜å‘˜æ•°',m.officialCount||0,'å·²ç¼–åˆ¶','')}
  `;
}
function mc(l,v,s,cls){return`<div class="mcard"><div class="ml">${l}</div><div class="mv ${cls}">${v}</div><div class="ms">${s}</div></div>`}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PIPELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPipeline(tasks){
  const counts={};
  (tasks||[]).forEach(t=>{if(!counts[t.state])counts[t.state]=0;counts[t.state]++});
  document.getElementById('pipeline').innerHTML=PIPE_STAGES.map((st,i)=>{
    const n=counts[st.key]||0;
    return `<div class="pipe-stage">
      <div class="pn ${n>0?'has-tasks':''}">
        <div class="pn-icon">${st.icon}</div>
        <div class="pn-label">${st.label}</div>
        ${n>0?`<div class="pn-count">${n}</div>`:''}
      </div>
      ${i<PIPE_STAGES.length-1?`<div class="pipe-arrow">â†’</div>`:''}
    </div>`
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderCharts(tasks){
  // chart 1: by org
  const byOrg={};
  (tasks||[]).forEach(t=>{const o=t.org||'å…¶ä»–';byOrg[o]=(byOrg[o]||0)+1});
  const maxOrg=Math.max(...Object.values(byOrg),1);
  const orgBars=Object.entries(byOrg).sort((a,b)=>b[1]-a[1]).slice(0,8).map(([org,n])=>`
    <div class="bar-row">
      <div class="bar-label">${esc(org)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.round(n/maxOrg*100)}%;background:${ORG_COLOR[org]||'var(--acc)'}"></div></div>
      <div class="bar-val">${n}</div>
    </div>`).join('');

  // chart 2: by state
  const byState={};
  (tasks||[]).forEach(t=>{const s=STATE_LABEL[t.state]||t.state;byState[s]=(byState[s]||0)+1});
  const stateColors={'æ‰§è¡Œä¸­':'var(--acc)','å·²å®Œæˆ':'var(--ok)','å¾…å®¡æŸ¥':'var(--warn)','é˜»å¡':'var(--danger)','å·²æ´¾å‘':'#6aef9a'};
  const stateEntries=Object.entries(byState).sort((a,b)=>b[1]-a[1]);
  const maxState=Math.max(...stateEntries.map(e=>e[1]),1);
  const stateBars=stateEntries.map(([s,n])=>`
    <div class="bar-row">
      <div class="bar-label" style="font-size:10px">${esc(s)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.round(n/maxState*100)}%;background:${stateColors[s]||'var(--muted)'}"></div></div>
      <div class="bar-val">${n}</div>
    </div>`).join('');

  document.getElementById('charts-row').innerHTML=`
    <div class="chart-card"><div class="cc-title">ä»»åŠ¡åˆ†å¸ƒ Â· çœ/éƒ¨</div><div class="bar-chart">${orgBars||'<div class="empty">æš‚æ— æ•°æ®</div>'}</div></div>
    <div class="chart-card"><div class="cc-title">ä»»åŠ¡åˆ†å¸ƒ Â· çŠ¶æ€</div><div class="bar-chart">${stateBars||'<div class="empty">æš‚æ— æ•°æ®</div>'}</div></div>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AGENTS HEALTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAgentsHealth(tasks){
  // ä»ä¼šè¯ç±»å‹ä»»åŠ¡ä¸­æå– agent çŠ¶æ€
  const agentMap={};
  (tasks||[]).forEach(t=>{
    const src=t.sourceMeta||{};
    if(src.agentId){
      const id=src.agentId;
      if(!agentMap[id]||src.updatedAt>agentMap[id].updatedAt){
        agentMap[id]={
          id,org:t.org,label:t.official||id,
          hb:t.heartbeat||{status:'unknown',label:'âšª æ— æ•°æ®'},
          model:(t.now||'').match(/æ¨¡å‹\s+([^\sÂ·]+)/)?.[1]||'â€”',
          updatedAt:src.updatedAt||0,
        }
      }
    }
  });
  // è¡¥å…… agentConfig æ•°æ®
  if(agentConfig&&agentConfig.agents){
    agentConfig.agents.forEach(ag=>{
      if(!agentMap[ag.id]){
        agentMap[ag.id]={id:ag.id,org:ag.label,label:ag.role,hb:{status:'idle',label:'âšª å¾…å‘½'},model:ag.model,updatedAt:0}
      } else {
        agentMap[ag.id].model=ag.model;
      }
    });
  }
  const rows=Object.values(agentMap);
  if(!rows.length){document.getElementById('agents-health').innerHTML='<div class="empty" style="padding:20px">æš‚æ— æ•°æ®</div>';return}
  document.getElementById('agents-health').innerHTML=rows.map(ag=>`
    <div class="agent-row">
      <div class="ag-dot ${ag.hb.status}"></div>
      <div class="ag-info">
        <div class="ag-name">${esc(ORG_EMOJI[ag.org]||'ğŸ›ï¸')} ${esc(ag.label||ag.id)}</div>
        <div class="ag-model">${esc(ag.model)}</div>
      </div>
      <div class="ag-hb">${esc(ag.hb.label)}</div>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KANBAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function filterTasks(tasks){
  let f=tasks;
  if(orgFilter!=='all'){
    if(orgFilter==='ä¸‰çœå…­éƒ¨')f=f.filter(t=>['ä¸­ä¹¦çœ','é—¨ä¸‹çœ','å°šä¹¦çœ'].includes(t.org));
    else if(orgFilter==='å…­éƒ¨')f=f.filter(t=>['ç¤¼éƒ¨','æˆ·éƒ¨','å…µéƒ¨','åˆ‘éƒ¨','å·¥éƒ¨'].includes(t.org));
    else f=f.filter(t=>t.org===orgFilter);
  }
  if(searchQ)f=f.filter(t=>{
    const hay=(t.id+t.title+t.official+t.org+t.now+t.block).toLowerCase();
    return hay.includes(searchQ);
  });
  return f;
}

function renderKanban(tasks){
  const filtered=filterTasks(tasks);
  const groups={};
  STATE_ORDER.forEach(s=>groups[s]=[]);
  filtered.forEach(t=>{(groups[t.state]||(groups[t.state]=[])).push(t)});
  const SHOW_EMPTY=['Doing','Review','Done'];
  const cols=STATE_ORDER.filter(s=>groups[s].length>0||SHOW_EMPTY.includes(s));
  document.getElementById('kanban-board').innerHTML=cols.map(state=>`
    <div class="k-col">
      <div class="k-hdr">
        <span class="kn tag s-${state}">${STATE_LABEL[state]||state}</span>
        <span class="kc">${(groups[state]||[]).length}</span>
      </div>
      <div class="k-cards">
        ${(groups[state]||[]).length===0?'<div class="k-empty">æš‚æ— </div>':(groups[state]||[]).map(t=>tcard(t)).join('')}
      </div>
    </div>`).join('');
  document.getElementById('tb-doing').textContent=tasks.filter(t=>['Doing','Assigned','Review'].includes(t.state)).length;
}

function tcard(t){
  const hb=t.heartbeat||{status:'unknown',label:'âšª'};
  return `<div class="tc" onclick='openTask(${JSON.stringify(t.id)})'>
    <div class="cid">${esc(t.id)}</div>
    <span class="corg tag ${orgCls(t.org)}">${esc(t.org||'â€”')}</span>
    <div class="ctitle">${esc(t.title||'æ— æ ‡é¢˜')}</div>
    <div class="cmeta">${t.official?`ğŸ‘¤ ${esc(t.official)}`:''}${t.eta&&t.eta!=='-'?` Â· ğŸ“… ${esc(t.eta)}`:''}`.trim()||'&nbsp;'}</div>
    <div class="cmeta" style="margin-bottom:4px">${t.now?esc(t.now.substring(0,60)):''}</div>
    <div class="cfoot">
      <span class="hb ${hb.status}">${esc(hb.label)}</span>
      ${t.block&&t.block!=='æ— '?`<span class="tag pill-err">ğŸš« ${esc(t.block)}</span>`:''}
    </div>
  </div>`
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderHistory(tasks){
  const done=(tasks||[]).filter(t=>t.state==='Done');
  document.getElementById('tb-done').textContent=done.length;
  const byOrg={};
  done.forEach(t=>{const o=t.org||'æœªçŸ¥';(byOrg[o]||(byOrg[o]=[])).push(t)});
  const el=document.getElementById('history-content');
  if(!done.length){el.innerHTML='<div class="empty">æš‚æ— å·²å®Œæˆä»»åŠ¡</div>';return}
  el.innerHTML=Object.entries(byOrg).map(([org,items])=>`
    <div class="hist-section">
      <div class="dept-hdr open" onclick="toggleDept(this)">
        <span style="font-size:18px">${ORG_EMOJI[org]||'ğŸ›ï¸'}</span>
        <span style="font-size:14px;font-weight:700">${esc(org)}</span>
        <span class="dh-arrow">â–¶</span>
      </div>
      <div class="dept-body open">
        ${items.map(t=>{
          const lm=(t.outputMeta&&t.outputMeta.lastModified)||t.updatedAt||'â€”';
          const qa=t.outputMeta&&t.outputMeta.exists?'<span class="tag pill-ok">âœ… é€šè¿‡</span>':'<span class="tag pill-warn">âš ï¸ å¾…è¡¥</span>';
          const hasFlow=t.flow_log&&t.flow_log.length>0;
          return `<div>
            <div class="hist-row" onclick="toggleFlow(this.nextElementSibling)">
              <span class="hr-time">${esc(String(lm).substring(0,16))}</span>
              <span style="font-weight:500">${esc(t.title||'')}</span>
              <span class="hr-qa">${qa}</span>
              <span class="hr-link" onclick="event.stopPropagation();openTask('${t.id}')">è¯¦æƒ… â†’</span>
            </div>
            ${hasFlow?`<div class="flow-log-wrap">${t.flow_log.map(fl=>`
              <div class="fl-row">
                <span class="fl-time">${fl.at?fl.at.substring(0,16).replace('T',' '):''}</span>
                <span class="fl-from">${esc(fl.from||'')}</span>
                <span class="fl-sep">â†’</span>
                <span class="fl-to">${esc(fl.to||'')}</span>
                <span class="fl-rem">${esc(fl.remark||'')}</span>
              </div>`).join('')}</div>`:''}
          </div>`
        }).join('')}
      </div>
    </div>`).join('');
}

function toggleDept(hdr){hdr.classList.toggle('open');hdr.nextElementSibling.classList.toggle('open')}
function toggleFlow(el){if(el&&el.classList)el.classList.toggle('open')}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTimeline(tasks){
  const events=[];
  (tasks||[]).forEach(t=>{
    (t.flow_log||[]).forEach(fl=>{
      events.push({at:fl.at,task:t.title,from:fl.from,to:fl.to,remark:fl.remark,org:t.org});
    });
  });
  events.sort((a,b)=>(b.at||'').localeCompare(a.at||''));
  const el=document.getElementById('timeline-content');
  if(!events.length){el.innerHTML='<div class="empty">æš‚æ— æµè½¬è®°å½•</div>';return}
  el.innerHTML=events.slice(0,60).map(e=>{
    const col=ORG_COLOR[e.from]||ORG_COLOR[e.org]||'var(--acc)';
    return `<div class="tl-item">
      <div class="tl-time">${e.at?e.at.substring(0,16).replace('T',' '):'â€”'}</div>
      <div class="tl-dot" style="background:${col};box-shadow:0 0 6px ${col}"></div>
      <div class="tl-content">
        <div class="tl-who"><span style="color:${col}">${esc(e.from||'')}</span> <span style="color:var(--muted)">â†’</span> <span style="color:var(--acc2)">${esc(e.to||'')}</span></div>
        <div class="tl-desc">[${esc(e.task||'')}] ${esc(e.remark||'')}</div>
      </div>
    </div>`
  }).join('')
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAWER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openTask(id){
  if(!liveStatus||!liveStatus.tasks)return;
  const t=liveStatus.tasks.find(x=>x.id===id);
  if(!t)return;
  document.getElementById('dr-hdr-id').textContent=t.id;
  document.getElementById('dr-body').innerHTML=`
    <div class="dr-id">${esc(t.id)}</div>
    <div class="dr-title">${esc(t.title||'')}</div>
    <div class="sec">
      <div class="sec-lbl">åŸºæœ¬ä¿¡æ¯</div>
      ${dr('çœ/éƒ¨',t.org)}${dr('å®˜å‘˜',t.official)}${dr('çŠ¶æ€',STATE_LABEL[t.state]||t.state)}
      ${dr('å½“å‰',t.now)}${dr('ETA',t.eta)}${dr('é˜»å¡',t.block)}${dr('äº§å‡º',t.output)}${dr('éªŒæ”¶',t.ac)}
    </div>
    ${t.flow_log&&t.flow_log.length?`
    <div class="sec">
      <div class="sec-lbl">æµè½¬æ—¥å¿—</div>
      ${t.flow_log.map(fl=>`<div class="fl-row">
        <span class="fl-time">${fl.at?fl.at.substring(0,16).replace('T',' '):''}</span>
        <span class="fl-from">${esc(fl.from||'')}</span>
        <span class="fl-sep">â†’</span>
        <span class="fl-to">${esc(fl.to||'')}</span>
        <span class="fl-rem">${esc(fl.remark||'')}</span>
      </div>`).join('')}
    </div>`:''}
    ${t.activity&&t.activity.length?`
    <div class="sec">
      <div class="sec-lbl">æœ€è¿‘æ´»åŠ¨ï¼ˆæœ€æ–°10æ¡ï¼‰</div>
      <div class="act-list">
        ${[...t.activity].reverse().slice(0,10).map(a=>`<div class="act-i">
          <span class="act-t">${a.at?a.at.substring(11,16):''}</span>
          <span class="ak ak-${a.kind||'tool'}">${a.kind||'tool'}</span>
          <span class="act-tx">${esc((a.text||'').substring(0,140))}</span>
        </div>`).join('')}
      </div>
    </div>`:''}
  `;
  document.getElementById('overlay').classList.add('open');
  document.getElementById('drawer').classList.add('open');
}
function dr(k,v){if(!v||v==='-'||v==='æ— ')return'';return`<div class="drow"><span class="dk">${k}</span><span class="dv">${esc(String(v))}</span></div>`}
function closeDrawer(){document.getElementById('overlay').classList.remove('open');document.getElementById('drawer').classList.remove('open')}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODEL CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const KNOWN_MODELS=[
  {id:'anthropic/claude-sonnet-4-6',l:'Claude Sonnet 4.6',p:'Anthropic'},
  {id:'anthropic/claude-opus-4-5',l:'Claude Opus 4.5',p:'Anthropic'},
  {id:'anthropic/claude-haiku-3-5',l:'Claude Haiku 3.5',p:'Anthropic'},
  {id:'openai/gpt-4o',l:'GPT-4o',p:'OpenAI'},
  {id:'openai/gpt-4o-mini',l:'GPT-4o Mini',p:'OpenAI'},
  {id:'openai-codex/gpt-5.3-codex',l:'GPT-5.3 Codex',p:'OpenAI Codex'},
  {id:'google/gemini-2.0-flash',l:'Gemini 2.0 Flash',p:'Google'},
  {id:'google/gemini-2.5-pro',l:'Gemini 2.5 Pro',p:'Google'},
];

function renderModels(cfg){
  if(!cfg||!cfg.agents){
    document.getElementById('model-grid').innerHTML='<div class="empty" style="grid-column:1/-1">æ— æ³•åŠ è½½é…ç½®ï¼Œè¯·ç¡®ä¿æœ¬åœ°æœåŠ¡å™¨å·²å¯åŠ¨</div>';return
  }
  const opts=KNOWN_MODELS.map(m=>`<option value="${m.id}">${m.l} (${m.p})</option>`).join('');
  document.getElementById('model-grid').innerHTML=cfg.agents.map(ag=>`
    <div class="mc-card" id="mc-${ag.id}">
      <div class="mc-top">
        <span class="mc-emoji">${ag.emoji||'ğŸ›ï¸'}</span>
        <div><div class="mc-name">${esc(ag.label)} <span style="font-size:11px;color:var(--muted)">${esc(ag.id)}</span></div><div class="mc-role">${esc(ag.role)} Â· ${esc(ag.duty)}</div></div>
      </div>
      <div class="mc-cur">å½“å‰: <span>${esc(ag.model)}</span></div>
      <select class="msel" id="sel-${ag.id}" onchange="onMC('${ag.id}')">${opts}</select>
      <div class="mc-btns">
        <button class="btn btn-p" id="btn-${ag.id}" onclick="applyModel('${ag.id}')" disabled>åº”ç”¨æ›´æ”¹</button>
        <button class="btn btn-g" onclick="resetMC('${ag.id}')">é‡ç½®</button>
      </div>
      <div class="mc-status" id="mcs-${ag.id}"></div>
    </div>`).join('');
  cfg.agents.forEach(ag=>{const s=document.getElementById(`sel-${ag.id}`);if(s)s.value=ag.model});
}
function onMC(id){
  const s=document.getElementById(`sel-${id}`),b=document.getElementById(`btn-${id}`);
  const ag=agentConfig&&agentConfig.agents?agentConfig.agents.find(a=>a.id===id):null;
  if(!ag||!s)return; b.disabled=s.value===ag.model;
}
function resetMC(id){
  const s=document.getElementById(`sel-${id}`),b=document.getElementById(`btn-${id}`);
  const ag=agentConfig&&agentConfig.agents?agentConfig.agents.find(a=>a.id===id):null;
  if(!ag||!s)return; s.value=ag.model; b.disabled=true;
}
async function applyModel(id){
  const s=document.getElementById(`sel-${id}`),b=document.getElementById(`btn-${id}`),st=document.getElementById(`mcs-${id}`);
  if(!s||!b)return; b.disabled=true;
  st.className='mc-status pending'; st.textContent='âŸ³ æäº¤å˜æ›´ä¸­â€¦';
  try{
    const r=await postJ(`${API}/set-model`,{agentId:id,model:s.value});
    if(r.ok){st.className='mc-status ok';st.textContent='âœ… å·²æäº¤ï¼ŒGateway é‡å¯ä¸­ï¼ˆçº¦5ç§’ç”Ÿæ•ˆï¼‰';toast(`${id} â†’ ${s.value.split('/').pop()}`,`ok`);setTimeout(()=>loadAgentConfig(),5500)}
    else{st.className='mc-status err';st.textContent=`âŒ ${r.error||'æœªçŸ¥é”™è¯¯'}`;b.disabled=false}
  }catch(e){st.className='mc-status err';st.textContent='âŒ æ— æ³•è¿æ¥æœ¬åœ°æœåŠ¡å™¨ï¼ˆpython3 server.py æœªè¿è¡Œï¼‰';b.disabled=false}
}

function renderCL(log){
  const el=document.getElementById('cl-list');
  if(!log||!log.length){el.innerHTML='<div style="font-size:12px;color:var(--muted);padding:8px 0">æš‚æ— å˜æ›´è®°å½•</div>';return}
  el.innerHTML=[...log].reverse().slice(0,20).map(e=>`
    <div class="cl-row">
      <span class="cl-t">${esc((e.at||'').substring(0,16).replace('T',' '))}</span>
      <span class="cl-a">${esc(e.agentId||'')}</span>
      <span class="cl-c"><b>${esc(e.oldModel||'')}</b> â†’ <b>${esc(e.newModel||'')}</b></span>
    </div>`).join('')
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKILLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSkills(cfg){
  if(!cfg||!cfg.agents){document.getElementById('skills-grid').innerHTML='<div class="empty">æ— æ³•åŠ è½½é…ç½®</div>';return}
  document.getElementById('skills-grid').innerHTML=cfg.agents.map(ag=>`
    <div class="sk-card">
      <div class="sk-hdr">
        <span class="sk-emoji">${ag.emoji||'ğŸ›ï¸'}</span>
        <span class="sk-name">${esc(ag.label)}</span>
        <span class="sk-cnt">${(ag.skills||[]).length} æŠ€èƒ½</span>
      </div>
      <div class="sk-list">
        ${!(ag.skills||[]).length?'<div class="sk-empty">æš‚æ— å·²å®‰è£…çš„ Skills</div>':(ag.skills||[]).map(sk=>`
          <div class="sk-item"><span class="si-name">ğŸ“¦ ${esc(sk.name)}</span><span class="si-desc">${esc(sk.description||'æ— æè¿°')}</span></div>`).join('')}
      </div>
    </div>`).join('')
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadLive(){
  try{
    liveStatus=await fetchJ(`${API}/live-status`);
    const tasks=liveStatus.tasks||[];
    renderMetrics(liveStatus.metrics||{},tasks);
    renderPipeline(tasks);
    renderCharts(tasks);
    renderAgentsHealth(tasks);
    renderKanban(tasks);
    renderHistory(tasks);
    renderTimeline(tasks);
    updateHeader(liveStatus);
  }catch(e){
    document.getElementById('chip-sync').textContent='âŒ æœåŠ¡å™¨æœªå¯åŠ¨';
    document.getElementById('chip-sync').className='chip err';
  }
}
async function loadAgentConfig(){
  try{
    agentConfig=await fetchJ(`${API}/agent-config`);
    renderModels(agentConfig);
    renderSkills(agentConfig);
    const log=await fetchJ(`${API}/model-change-log`).catch(()=>[]);
    renderCL(log);
  }catch(e){
    document.getElementById('model-grid').innerHTML=`<div style="grid-column:1/-1" class="empty">
      âš ï¸ è¯·å…ˆå¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼š<br><code style="margin-top:6px;display:inline-block">python3 server.py</code>
    </div>`;
  }
}
async function loadAll(){await loadLive();if(['models','skills'].includes(activeTab))await loadAgentConfig()}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  t.classList.add('active'); activeTab=t.dataset.tab;
  document.getElementById(`panel-${activeTab}`).classList.add('active');
  if(['models','skills'].includes(activeTab))loadAgentConfig();
}));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.fb').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.fb').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); orgFilter=b.dataset.f;
  if(liveStatus)renderKanban(liveStatus.tasks||[]);
}));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFRESH COUNTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startCounter(){
  refreshCountdown=15;
  const el=document.getElementById('next-refresh');
  const iv=setInterval(()=>{
    refreshCountdown--;
    el.textContent=`âŸ³ ${refreshCountdown}s`;
    if(refreshCountdown<=0){clearInterval(iv);el.textContent='';loadAll();startCounter()}
  },1000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeDrawer()});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadAll();
startCounter();
</script>
</body>
</html>
