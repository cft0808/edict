<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å†›æœºå¤„ Â· ä¸‰çœå…­éƒ¨æ€»æ§å°</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700;900&display=swap');
    :root{
      --bg:#07090f;--panel:#0f1219;--panel2:#141824;--line:#1c2236;
      --text:#dde4f8;--muted:#5a6b92;--ok:#2ecc8a;--warn:#f5c842;--danger:#ff5270;
      --acc:#6a9eff;--acc2:#a07aff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:"PingFang SC",Inter,-apple-system,"Segoe UI",sans-serif;min-height:100vh}
    ::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#1e2538;border-radius:4px}

    .wrap{max-width:1400px;margin:0 auto;padding:16px}

    /* HEADER */
    .hdr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--line)}
    .logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,#6a9eff,#a07aff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .sub{font-size:11px;color:var(--muted)}
    .hdr-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{font-size:11px;padding:3px 9px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted)}
    .chip.ok{border-color:#2ecc8a44;color:var(--ok)}.chip.warn{border-color:#f5c84244;color:var(--warn)}.chip.err{border-color:#ff527044;color:var(--danger)}
    .btn-refresh{font-size:11px;padding:4px 10px;border:1px solid var(--acc);border-radius:6px;background:transparent;color:var(--acc);cursor:pointer}
    .btn-refresh:hover{background:#0a1228}
    #cd{font-size:11px;color:var(--muted)}

    /* TABS */
    .tabs{display:flex;gap:2px;margin-bottom:18px;border-bottom:1px solid var(--line);overflow-x:auto}
    .tab{font-size:13px;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;color:var(--muted);border:1px solid transparent;border-bottom:none;white-space:nowrap;position:relative;bottom:-1px;transition:all .15s;user-select:none}
    .tab:hover{color:var(--text);background:var(--panel)}
    .tab.active{color:var(--text);background:var(--panel);border-color:var(--line);font-weight:600}
    .tbadge{font-size:10px;padding:1px 5px;border-radius:999px;background:#1a2040;color:var(--acc);margin-left:4px}
    .panel{display:none}.panel.active{display:block}

    /* â•â• æ—¨æ„çœ‹æ¿ â•â• */
    .edict-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px}
    .edict-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;cursor:pointer;transition:border-color .15s,transform .1s,box-shadow .15s}
    .edict-card:hover{border-color:var(--acc);transform:translateY(-2px);box-shadow:0 4px 20px rgba(106,158,255,.1)}

    /* pipeline strip on card */
    .ec-pipe{display:flex;align-items:center;gap:0;margin-bottom:14px;overflow-x:auto;padding-bottom:2px}
    .ep-node{display:flex;flex-direction:column;align-items:center;gap:1px;padding:5px 8px;border-radius:6px;flex-shrink:0;min-width:52px}
    .ep-node.done{background:#0a2018}
    .ep-node.active{background:#0f1a38;border:1px solid var(--acc)}
    .ep-node.pending{opacity:.3}
    .ep-icon{font-size:14px}
    .ep-name{font-size:9px;color:var(--muted);white-space:nowrap}
    .ep-node.done .ep-name{color:var(--ok)}
    .ep-node.active .ep-name{color:var(--acc);font-weight:700}
    .ep-arrow{font-size:10px;color:#1c2236;padding:0 1px;flex-shrink:0}

    .ec-id{font-size:10px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:5px}
    .ec-title{font-size:15px;font-weight:700;line-height:1.4;margin-bottom:10px;color:var(--text)}
    .ec-meta{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:8px}
    .tag{font-size:10px;padding:2px 7px;border-radius:4px;border:1px solid;display:inline-block;white-space:nowrap}

    /* state colors */
    .st-Inbox{border-color:#3a4a7a44;color:#7a9aff;background:#0a1028}
    .st-Zhongshu{border-color:#a07aff44;color:#a07aff;background:#110a28}
    .st-Menxia{border-color:#ff9a6a44;color:#ff9a6a;background:#280f0a}
    .st-Assigned,.st-Doing{border-color:#6a9eff44;color:#6a9eff;background:#0a1428}
    .st-Review{border-color:#f5c84244;color:#f5c842;background:#201a08}
    .st-Done{border-color:#2ecc8a44;color:var(--ok);background:#0a2018}
    .st-Blocked{border-color:#ff527044;color:var(--danger);background:#200a10}
    .st-Cancelled{border-color:#88888844;color:#888;background:#1a1a1a}
    .st-Next{border-color:#4a9adf44;color:#4a9adf;background:#0a1424}

    /* dept colors */
    .dt-ä¸­ä¹¦çœ{border-color:#a07aff44;color:#a07aff;background:#1a0f38}
    .dt-é—¨ä¸‹çœ{border-color:#6a9eff44;color:#6a9eff;background:#0f1a38}
    .dt-å°šä¹¦çœ{border-color:#6aef9a44;color:#6aef9a;background:#0a2018}
    .dt-ç¤¼éƒ¨{border-color:#f5c84244;color:#f5c842;background:#201a08}
    .dt-æˆ·éƒ¨{border-color:#ff9a6a44;color:#ff9a6a;background:#28100a}
    .dt-å…µéƒ¨{border-color:#ff527044;color:#ff5270;background:#280a10}
    .dt-åˆ‘éƒ¨{border-color:#cc444444;color:#cc4444;background:#280808}
    .dt-å·¥éƒ¨{border-color:#44aaff44;color:#44aaff;background:#081828}

    .ec-footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px;flex-wrap:wrap;gap:6px}
    .hb{font-size:10px;padding:2px 7px;border-radius:999px;border:1px solid var(--line)}
    .hb.active{border-color:#2ecc8a44;color:var(--ok)}.hb.warn{border-color:#f5c84244;color:var(--warn)}.hb.stalled{border-color:#ff527044;color:var(--danger);animation:pulse 1.5s infinite}.hb.unknown{color:var(--muted)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

    /* â•â• TASK DETAIL MODAL â•â• */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;backdrop-filter:blur(3px);overflow-y:auto}
    .modal-bg.open{display:flex;align-items:flex-start;justify-content:center;padding:40px 16px}
    .modal{background:var(--panel);border:1px solid var(--line);border-radius:18px;width:100%;max-width:760px;padding:28px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .modal-close{position:absolute;top:16px;right:16px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:18px;color:var(--muted)}
    .modal-close:hover{background:var(--panel2);color:var(--text)}
    .modal-id{font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:6px}
    .modal-title{font-size:22px;font-weight:800;line-height:1.3;margin-bottom:18px}

    /* full pipeline in modal */
    .m-pipe{display:flex;align-items:stretch;gap:0;overflow-x:auto;padding:16px;background:var(--panel2);border-radius:12px;margin-bottom:20px}
    .mp-stage{display:flex;align-items:center;flex-shrink:0}
    .mp-node{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 14px;border-radius:10px;min-width:80px;position:relative}
    .mp-node.done{background:#0a2018;border:1px solid #2ecc8a44}
    .mp-node.active{background:#0f1838;border:2px solid var(--acc);box-shadow:0 0 14px rgba(106,158,255,.2)}
    .mp-node.pending{opacity:.25;border:1px dashed var(--line)}
    .mp-icon{font-size:22px}
    .mp-dept{font-size:12px;font-weight:700;margin-top:2px}
    .mp-node.done .mp-dept{color:var(--ok)}
    .mp-node.active .mp-dept{color:var(--acc)}
    .mp-node.pending .mp-dept{color:var(--muted)}
    .mp-action{font-size:10px;color:var(--muted);margin-top:1px}
    .mp-node.active .mp-action{color:#6a9eff88}
    .mp-done-tick{position:absolute;top:-6px;right:-6px;width:16px;height:16px;background:var(--ok);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;color:#000;font-weight:700}
    .mp-arrow{color:#1c2236;font-size:18px;padding:0 6px;margin-top:-10px}

    /* current stage banner */
    .cur-stage{display:flex;align-items:center;gap:10px;padding:12px 16px;background:#0a1228;border:1px solid var(--acc);border-radius:10px;margin-bottom:18px}
    .cs-icon{font-size:24px}
    .cs-info .cs-dept{font-size:16px;font-weight:700;color:var(--acc)}
    .cs-info .cs-action{font-size:12px;color:var(--muted);margin-top:2px}
    .cs-hb{margin-left:auto}

    /* flow log */
    .m-section{margin-bottom:18px}
    .m-sec-label{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--line)}
    .fl-timeline{display:flex;flex-direction:column;gap:0;position:relative}
    .fl-timeline::before{content:'';position:absolute;left:60px;top:0;bottom:0;width:1px;background:var(--line)}
    .fl-item{display:flex;gap:0;position:relative;padding:8px 0}
    .fl-time{min-width:60px;font-size:10px;color:var(--muted);text-align:right;padding-right:14px;flex-shrink:0;padding-top:3px}
    .fl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:3px;position:relative;z-index:1}
    .fl-content{padding-left:12px;flex:1}
    .fl-who{font-size:12px;margin-bottom:2px}
    .fl-who .from{font-weight:700}
    .fl-who .to{font-weight:700}
    .fl-rem{font-size:11px;color:var(--muted);line-height:1.5}
    .fl-ok{color:var(--ok)}.fl-warn{color:var(--warn)}.fl-blue{color:var(--acc)}.fl-purple{color:var(--acc2)}

    /* meta rows */
    .m-rows{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .m-row{background:var(--panel2);border-radius:8px;padding:10px 12px}
    .mr-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
    .mr-val{font-size:13px;font-weight:600;word-break:break-all}

    /* â•â• çœéƒ¨è°ƒåº¦ tab â•â• */
    .duty-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:12px}
    .duty-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;transition:border-color .15s}
    .duty-card:hover{border-color:#2e3d6a}
    .duty-card.active-card{border-color:var(--acc)}
    .duty-card.blocked-card{border-color:#ff527055}

    .dc-hdr{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--panel2);border-bottom:1px solid var(--line)}
    .dc-emoji{font-size:22px}
    .dc-info{flex:1}
    .dc-name{font-size:14px;font-weight:800}
    .dc-role{font-size:10px;color:var(--muted)}
    .dc-status{display:flex;align-items:center;gap:5px;font-size:11px}
    .dc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .dc-dot.active{background:var(--ok)}.dc-dot.busy{background:var(--warn);animation:pulse 1.5s infinite}
    .dc-dot.blocked{background:var(--danger);animation:pulse 1s infinite}.dc-dot.idle{background:#2a3a5a}

    .dc-body{padding:14px 16px}

    /* å€™å‘½çŠ¶æ€ */
    .dc-idle{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;padding:6px 0}

    /* æ‰§è¡Œä¸­ä»»åŠ¡ */
    .dc-task{display:flex;flex-direction:column;gap:6px}
    .dc-task-id{font-size:10px;color:var(--acc);font-weight:700;letter-spacing:.04em}
    .dc-task-title{font-size:14px;font-weight:700;color:var(--text);line-height:1.3}
    .dc-task-now{font-size:12px;color:var(--muted);line-height:1.5;margin-top:2px}
    .dc-task-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px}

    .dc-footer{padding:8px 16px;border-top:1px solid var(--line);display:flex;align-items:center;gap:8px;background:var(--panel2)}
    .dc-model{font-size:10px;color:var(--muted)}.dc-la{font-size:10px;color:var(--muted);margin-left:auto}

    /* â•â• Model / Skills tabs â•â• */
    .model-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-bottom:18px}
    .mc-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
    .mc-top{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .mc-emoji{font-size:22px}
    .mc-name{font-size:15px;font-weight:700}.mc-role{font-size:11px;color:var(--muted)}
    .mc-cur{font-size:11px;color:var(--muted);margin-bottom:8px}.mc-cur b{color:var(--text)}
    .msel{width:100%;background:var(--panel2);border:1px solid var(--line);border-radius:7px;color:var(--text);padding:7px 10px;font-size:12px;outline:none;cursor:pointer}.msel:focus{border-color:var(--acc)}
    .mc-btns{display:flex;gap:6px;margin-top:8px}
    .btn{font-size:12px;padding:6px 14px;border-radius:7px;border:none;cursor:pointer;font-weight:600}
    .btn-p{background:var(--acc);color:#000}.btn-p:hover{filter:brightness(1.15)}.btn-p:disabled{background:#2a3a6a;color:var(--muted);cursor:not-allowed}
    .btn-g{background:transparent;border:1px solid var(--line);color:var(--muted)}.btn-g:hover{border-color:#2e3d6a;color:var(--text)}
    .mc-st{font-size:11px;margin-top:6px;padding:4px 8px;border-radius:5px;display:none}
    .mc-st.ok{display:block;background:#0a2018;color:var(--ok);border:1px solid #2ecc8a44}
    .mc-st.err{display:block;background:#200a10;color:var(--danger);border:1px solid #ff527044}
    .mc-st.pending{display:block;background:#0a1228;color:var(--acc);border:1px solid #6a9eff44}
    .cl-wrap{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
    .cl-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;margin-bottom:10px}
    .cl-row{display:flex;gap:10px;font-size:11px;padding:5px 0;border-bottom:1px solid var(--line)}.cl-row:last-child{border-bottom:none}
    .cl-t{color:var(--muted);min-width:115px}.cl-a{color:var(--acc);min-width:80px}.cl-c{color:var(--muted)}.cl-c b{color:var(--text)}

    .skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .sk-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .sk-hdr{display:flex;align-items:center;gap:9px;padding:11px 14px;background:var(--panel2);border-bottom:1px solid var(--line)}
    .sk-emoji{font-size:18px}.sk-name{font-size:14px;font-weight:700}.sk-cnt{font-size:11px;color:var(--muted);margin-left:auto}
    .sk-list{padding:10px}
    .sk-item{display:flex;gap:8px;padding:8px 10px;border-radius:7px;font-size:12px;margin-bottom:3px;cursor:pointer;border:1px solid transparent;transition:all .12s}
    .sk-item:hover{background:var(--panel2);border-color:var(--line)}
    .si-name{font-weight:600;min-width:100px}.si-desc{color:var(--muted);flex:1;line-height:1.4}
    .si-arrow{color:var(--muted);font-size:14px;opacity:.3;transition:opacity .12s}.sk-item:hover .si-arrow{opacity:1}
    .sk-empty{font-size:12px;color:var(--muted);padding:12px;text-align:center;opacity:.6}
    .sk-add{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;font-size:12px;color:var(--acc);cursor:pointer;border-top:1px solid var(--line);transition:background .12s}
    .sk-add:hover{background:var(--panel2)}

    /* skill detail modal */
    .sk-modal-body{max-height:70vh;overflow-y:auto}
    .sk-md{font-size:13px;line-height:1.7;color:var(--text)}
    .sk-md h1,.sk-md h2,.sk-md h3{margin:16px 0 8px;color:var(--text)}
    .sk-md h1{font-size:18px}.sk-md h2{font-size:15px;border-bottom:1px solid var(--line);padding-bottom:6px}.sk-md h3{font-size:13px}
    .sk-md p{margin:6px 0}
    .sk-md ul,.sk-md ol{padding-left:20px;margin:6px 0}
    .sk-md li{margin:3px 0}
    .sk-md code{font-size:11px;background:var(--panel2);padding:2px 6px;border-radius:4px;font-family:monospace}
    .sk-md pre{background:var(--panel2);border:1px solid var(--line);border-radius:8px;padding:12px;overflow-x:auto;margin:8px 0}
    .sk-md pre code{background:none;padding:0}
    .sk-md table{width:100%;border-collapse:collapse;font-size:12px;margin:8px 0}
    .sk-md th,.sk-md td{padding:6px 10px;border:1px solid var(--line);text-align:left}
    .sk-md th{background:var(--panel2)}
    .sk-md hr{border:none;border-top:1px solid var(--line);margin:14px 0}
    .sk-path{font-size:10px;color:var(--muted);padding:8px 0;word-break:break-all;border-top:1px solid var(--line);margin-top:12px}

    /* â•â• SESSIONS TAB â•â• */
    .sess-filters{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
    .sess-filter{font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:var(--panel);color:var(--muted);cursor:pointer;transition:all .12s}
    .sess-filter:hover{border-color:var(--acc);color:var(--text)}
    .sess-filter.active{border-color:var(--acc);color:var(--acc);background:#0a1228}
    .sess-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:10px}
    .sess-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;transition:border-color .12s}
    .sess-card:hover{border-color:#2e3d6a}
    .sc-top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .sc-emoji{font-size:20px}
    .sc-agent{font-size:13px;font-weight:700}
    .sc-org{font-size:11px;color:var(--muted)}
    .sc-title{font-size:13px;font-weight:600;margin-bottom:6px;line-height:1.4}
    .sc-now{font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:6px}
    .sc-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .sc-id{font-size:10px;color:var(--acc);font-weight:600}
    .sc-time{font-size:10px;color:var(--muted);margin-left:auto}

    /* â•â• TASK ACTIONS â•â• */
    .task-actions{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap}
    .btn-action{font-size:12px;padding:7px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:700;transition:all .15s}
    .btn-stop{background:#ff527022;color:#ff5270;border:1px solid #ff527044}.btn-stop:hover{background:#ff527044}
    .btn-cancel{background:#88888822;color:#888;border:1px solid #88888844}.btn-cancel:hover{background:#88888844}
    .btn-resume{background:#2ecc8a22;color:#2ecc8a;border:1px solid #2ecc8a44}.btn-resume:hover{background:#2ecc8a44}
    .btn-action:disabled{opacity:.4;cursor:not-allowed}

    /* card-level mini actions */
    .ec-actions{display:flex;gap:4px;margin-top:8px}
    .ec-actions .mini-act{font-size:10px;padding:3px 8px;border-radius:5px;border:1px solid var(--line);background:transparent;cursor:pointer;color:var(--muted);transition:all .12s}
    .ec-actions .mini-act:hover{border-color:var(--acc);color:var(--text)}
    .ec-actions .mini-act.danger:hover{border-color:#ff5270;color:#ff5270}

    /* â•â• ARCHIVE FILTER BAR â•â• */
    .archive-bar{display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap}
    .archive-bar .ab-label{font-size:12px;color:var(--muted);margin-right:4px}
    .archive-bar .ab-btn{font-size:11px;padding:4px 12px;border-radius:6px;border:1px solid var(--line);background:transparent;cursor:pointer;color:var(--muted);transition:all .15s;font-weight:600}
    .archive-bar .ab-btn:hover{border-color:var(--acc);color:var(--text)}
    .archive-bar .ab-btn.active{border-color:var(--acc);color:var(--acc);background:#0f1a38}
    .archive-bar .ab-count{font-size:10px;color:var(--muted);margin-left:auto}
    .archive-bar .ab-archive-all{font-size:11px;padding:4px 12px;border-radius:6px;border:1px solid #2ecc8a44;background:transparent;cursor:pointer;color:var(--ok);font-weight:600;transition:all .15s}
    .archive-bar .ab-archive-all:hover{background:#0a2018;border-color:var(--ok)}
    /* archived card styling */
    .edict-card.archived{opacity:.55;border-style:dashed}
    .edict-card.archived:hover{opacity:.85}

    /* â•â• TODO LIST â•â• */
    .todo-section{margin-bottom:18px}
    .todo-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .todo-progress{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .todo-bar{width:120px;height:6px;background:#0e1320;border-radius:3px;overflow:hidden}
    .todo-bar-fill{height:100%;border-radius:3px;background:var(--ok);transition:width .3s}
    .todo-list{display:flex;flex-direction:column;gap:4px}
    .todo-item{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--panel2);border-radius:8px;font-size:12px;transition:opacity .15s}
    .todo-item.done{opacity:.55}
    .todo-item .t-icon{font-size:14px;flex-shrink:0}
    .todo-item .t-id{color:var(--muted);font-size:10px;min-width:20px}
    .todo-item .t-title{flex:1;color:var(--text)}
    .todo-item.done .t-title{text-decoration:line-through;color:var(--muted)}
    .todo-item .t-status{font-size:10px;padding:2px 6px;border-radius:4px}
    .todo-item .t-status.s-done{color:var(--ok);background:#0a2018;border:1px solid #2ecc8a44}
    .todo-item .t-status.s-progress{color:var(--acc);background:#0a1228;border:1px solid #6a9eff44}
    .todo-item .t-status.s-notstarted{color:var(--muted);background:var(--panel);border:1px solid var(--line)}

    /* card todo mini-bar */
    .ec-todo-bar{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--muted);margin-top:6px}
    .ec-todo-track{flex:1;max-width:80px;height:4px;background:#0e1320;border-radius:2px;overflow:hidden}
    .ec-todo-fill{height:100%;background:var(--ok);border-radius:2px}

    /* â•â• SUBSCRIPTION CONFIG â•â• */
    .sub-config{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;margin-bottom:18px}
    .sub-section{margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--line)}
    .sub-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
    .sub-sec-title{font-size:13px;font-weight:700;margin-bottom:10px}
    .sub-cats{display:flex;flex-wrap:wrap;gap:8px}
    .sub-cat{display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:8px;border:1px solid var(--line);background:var(--panel2);cursor:pointer;transition:all .15s;user-select:none}
    .sub-cat:hover{border-color:var(--acc)}
    .sub-cat.active{border-color:var(--ok);background:#0a2018}
    .sub-cat .sc-check{width:16px;height:16px;border-radius:4px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .15s}
    .sub-cat.active .sc-check{background:var(--ok);border-color:var(--ok);color:#000}
    .sub-cat .sc-label{font-size:12px;font-weight:600}
    .sub-cat .sc-count{font-size:10px;color:var(--muted)}
    .sub-input{background:var(--panel2);border:1px solid var(--line);border-radius:7px;color:var(--text);padding:7px 10px;font-size:12px;outline:none;min-width:0}
    .sub-input:focus{border-color:var(--acc)}
    .sub-kw-list{display:flex;flex-wrap:wrap;gap:6px}
    .sub-kw{display:flex;align-items:center;gap:4px;padding:4px 8px 4px 10px;border-radius:999px;background:#0f1a38;border:1px solid #1e2e50;font-size:11px;color:var(--acc)}
    .sub-kw .kw-del{cursor:pointer;opacity:.5;font-size:13px;padding:0 2px}.sub-kw .kw-del:hover{opacity:1;color:var(--danger)}
    .sub-feed-list{display:flex;flex-direction:column;gap:4px}
    .sub-feed{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--panel2);border-radius:7px;font-size:12px}
    .sub-feed .sf-name{font-weight:600;min-width:80px;color:var(--acc)}
    .sub-feed .sf-url{flex:1;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .sub-feed .sf-cat{font-size:10px;padding:2px 6px;border-radius:4px;border:1px solid var(--line)}
    .sub-feed .sf-del{cursor:pointer;color:var(--muted);font-size:14px}.sub-feed .sf-del:hover{color:var(--danger)}

    /* â•â• CONFIRM DIALOG â•â• */
    .confirm-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;backdrop-filter:blur(3px)}
    .confirm-bg.open{display:flex;align-items:center;justify-content:center}
    .confirm-box{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:24px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .confirm-title{font-size:16px;font-weight:700;margin-bottom:8px}
    .confirm-msg{font-size:13px;color:var(--muted);margin-bottom:14px;line-height:1.5}
    .confirm-input{width:100%;background:var(--panel2);border:1px solid var(--line);border-radius:7px;color:var(--text);padding:8px 10px;font-size:12px;outline:none;margin-bottom:14px}
    .confirm-input:focus{border-color:var(--acc)}
    .confirm-btns{display:flex;gap:8px;justify-content:flex-end}

    /* TOAST */
    #toaster{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:300}
    .toast{font-size:13px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.4);animation:tin .2s;max-width:320px}
    .toast.ok{border-color:#2ecc8a55;background:#0a1a10}.toast.err{border-color:#ff527055;background:#200a10}
    @keyframes tin{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}

    /* â•â• OFFICIALS â•â• */
    /* activity bar */
    .off-activity{display:flex;align-items:center;gap:8px;padding:8px 14px;background:#0a1228;border:1px solid #1a2a4a;border-radius:10px;margin-bottom:14px;font-size:12px;flex-wrap:wrap}
    .act-label{color:var(--muted);flex-shrink:0}
    .act-dot{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;border-radius:999px;background:#0f1a38;border:1px solid #1e2e50;margin:2px}
    .act-dot.alive{border-color:#2ecc8a44;background:#0a2018;color:var(--ok)}
    .act-dot.warn{border-color:#f5c84244;background:#201a08;color:var(--warn)}
    .act-dot.idle{color:var(--muted)}

    /* summary row */
    .off-kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
    .kpi{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px 16px}
    .kpi-v{font-size:24px;font-weight:800;margin-bottom:3px}
    .kpi-l{font-size:11px;color:var(--muted)}
    .kpi-v.gold{color:#f5c842}.kpi-v.green{color:var(--ok)}.kpi-v.blue{color:var(--acc)}.kpi-v.warn{color:var(--warn)}

    /* main layout */
    .off-layout{display:grid;grid-template-columns:260px 1fr;gap:14px}
    @media(max-width:700px){.off-layout{grid-template-columns:1fr}.off-kpi{grid-template-columns:repeat(2,1fr)}}

    /* left: rank list */
    .off-ranklist{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .orl-hdr{padding:10px 14px;background:var(--panel2);border-bottom:1px solid var(--line);font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}
    .orl-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--line);transition:background .1s}
    .orl-item:last-child{border-bottom:none}
    .orl-item:hover{background:var(--panel2)}
    .orl-item.selected{background:#0a1228;border-left:3px solid var(--acc)}
    .orl-medal{font-size:16px;min-width:20px;text-align:center}
    .orl-emoji{font-size:18px}
    .orl-name{flex:1}.orl-role{font-size:12px;font-weight:700}.orl-org{font-size:10px;color:var(--muted)}
    .orl-score{font-size:11px;font-weight:700;color:var(--acc)}
    .orl-hbdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .orl-hbdot.active{background:var(--ok)}.orl-hbdot.warn{background:var(--warn)}.orl-hbdot.stalled{background:var(--danger);animation:pulse 1.2s infinite}.orl-hbdot.idle{background:#2a3a5a}

    /* right: detail */
    .off-detail{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:22px;min-height:400px}
    .od-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:13px;min-height:200px}

    .od-hero{display:flex;align-items:center;gap:16px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--line)}
    .od-emoji{font-size:40px}
    .od-name{font-size:22px;font-weight:800}
    .od-role{font-size:13px;color:var(--muted);margin-top:2px}
    .od-rank-badge{font-size:11px;padding:3px 9px;border-radius:999px;border:1px solid #f5c84244;color:#f5c842;background:#201a08;margin-top:4px;display:inline-block}
    .od-hb{margin-left:auto;text-align:right}

    .od-section{margin-bottom:18px}
    .od-sec-title{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:10px}

    /* stats 3-grid */
    .od-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .ods{background:var(--panel2);border-radius:8px;padding:10px;text-align:center}
    .ods-v{font-size:20px;font-weight:800}.ods-l{font-size:10px;color:var(--muted);margin-top:2px}

    /* token bars */
    .tbar{margin-bottom:7px}
    .tbar-hdr{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px}
    .tbar-label{color:var(--muted)}.tbar-val{font-weight:600}
    .tbar-track{height:6px;background:#0e1320;border-radius:3px;overflow:hidden}
    .tbar-fill{height:100%;border-radius:3px}

    /* cost row */
    .od-cost-row{display:flex;gap:10px;flex-wrap:wrap}
    .cost-chip{font-size:12px;padding:5px 12px;border-radius:8px;border:1px solid var(--line);background:var(--panel2)}
    .cost-chip b{font-size:15px}
    .cost-chip.hi{border-color:#ff527044}.cost-chip.md{border-color:#f5c84244}.cost-chip.lo{border-color:#2ecc8a44}

    /* edict list */
    .od-edict-list{display:flex;flex-direction:column;gap:5px}
    .oe-item{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--panel2);border-radius:7px;font-size:12px;cursor:pointer}
    .oe-item:hover{background:#141c30}
    .oe-id{font-size:10px;color:var(--acc);font-weight:700;min-width:110px}
    .oe-title{flex:1;color:var(--text)}
    .oe-state{font-size:10px}

    .off-grid{display:none} /* legacy, hidden */

    /* â•â• æ—©æœç®€æŠ¥ â•â• */
    .mn-hdr{display:flex;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:18px;padding:14px 18px;background:linear-gradient(135deg,#0a1228,#140e28);border:1px solid #1a2a4a;border-radius:14px}
    .mn-date{font-size:20px;font-weight:800;background:linear-gradient(135deg,#f5c842,#ff9a3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .mn-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .mn-hdr-r{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn-morning-refresh{font-size:12px;padding:6px 14px;border-radius:8px;background:linear-gradient(135deg,#f5c842,#ff9a3c);color:#000;border:none;cursor:pointer;font-weight:700}
    .btn-morning-refresh:hover{filter:brightness(1.1)}
    .mn-cats{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .mn-cat{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .mn-cat-hdr{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--panel2);border-bottom:1px solid var(--line)}
    .mn-cat-icon{font-size:20px}.mn-cat-name{font-size:15px;font-weight:800}.mn-cat-cnt{font-size:11px;color:var(--muted);margin-left:auto}
    .mn-items{padding:10px}
    .mn-item{display:flex;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px;cursor:pointer;border:1px solid transparent;transition:border-color .1s}
    .mn-item:hover{background:var(--panel2);border-color:var(--line)}
    .mn-item:last-child{margin-bottom:0}
    .mn-img{width:70px;height:52px;border-radius:6px;object-fit:cover;flex-shrink:0;background:var(--panel2);display:flex;align-items:center;justify-content:center;font-size:24px;overflow:hidden}
    .mn-img img{width:100%;height:100%;object-fit:cover}
    .mn-content{flex:1;min-width:0}
    .mn-title{font-size:12px;font-weight:700;line-height:1.4;margin-bottom:3px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .mn-summary{font-size:11px;color:var(--muted);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .mn-meta{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:10px;color:var(--muted)}
    .mn-source{color:var(--acc)}.mn-time{margin-left:auto}
    .mn-empty{text-align:center;padding:30px 20px;color:var(--muted);font-size:13px}
    .mn-loading{display:flex;align-items:center;justify-content:center;gap:10px;padding:40px;color:var(--muted);font-size:13px}

    /* â•â• MORNING BRIEF â•â• */
    .mb-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px}
    .mb-title{font-size:20px;font-weight:800;background:linear-gradient(135deg,#f5c842,#ff9a4a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .mb-sub{font-size:12px;color:var(--muted);margin-top:3px}

    .mb-cats{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
    .mb-cat{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .mb-cat-hdr{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--line)}
    .mb-cat-icon{font-size:20px}
    .mb-cat-name{font-size:14px;font-weight:800}
    .mb-cat-cnt{font-size:11px;color:var(--muted);margin-left:auto}

    .mb-news-list{padding:10px}
    .mb-card{display:flex;gap:12px;padding:10px 8px;border-radius:10px;margin-bottom:6px;cursor:pointer;transition:background .12s;border-bottom:1px solid var(--line)}
    .mb-card:last-child{border-bottom:none;margin-bottom:0}
    .mb-card:hover{background:var(--panel2)}

    .mb-img{width:72px;height:52px;border-radius:7px;object-fit:cover;flex-shrink:0;background:var(--panel2);display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
    .mb-img img{width:100%;height:100%;object-fit:cover;border-radius:7px}
    .mb-info{flex:1;min-width:0}
    .mb-headline{font-size:13px;font-weight:700;line-height:1.4;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .mb-summary{font-size:11px;color:var(--muted);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .mb-meta{display:flex;align-items:center;gap:8px;margin-top:5px}
    .mb-source{font-size:10px;color:var(--acc)}
    .mb-time{font-size:10px;color:var(--muted)}

    .mb-empty{text-align:center;padding:30px;color:var(--muted);font-size:13px}
    .mb-loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--muted);font-size:14px;gap:10px}

    /* MISC */
    .empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:13px}
    .sec-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:12px}
    code{font-size:11px;background:var(--panel2);padding:2px 6px;border-radius:4px;font-family:monospace}

    /* â•â• COURT CEREMONY â•â• */
    .ceremony-bg{position:fixed;inset:0;z-index:9999;background:#07090f;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;animation:crmFadeIn .6s ease forwards;cursor:pointer}
    .ceremony-bg.out{animation:crmFadeOut .5s ease forwards}
    .crm-glow{position:absolute;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(106,158,255,.08),transparent 70%);animation:crmPulse 3s ease-in-out infinite}
    .crm-line1{font-family:'Noto Serif SC',serif;font-size:52px;font-weight:900;color:#dde4f8;letter-spacing:.15em;opacity:0;transform:translateY(20px)}
    .crm-line2{font-family:'Noto Serif SC',serif;font-size:22px;font-weight:700;color:var(--acc);letter-spacing:.2em;margin-top:12px;opacity:0;transform:translateY(15px)}
    .crm-line3{font-size:14px;color:var(--muted);margin-top:24px;opacity:0;letter-spacing:.05em}
    .crm-date{font-size:12px;color:#2a3555;margin-top:40px;opacity:0;letter-spacing:.08em}
    .crm-skip{font-size:11px;color:#2a3555;margin-top:18px;opacity:0;animation:crmChar .4s 2.5s forwards}
    .crm-line1.in{animation:crmSlideUp .6s .3s ease forwards}
    .crm-line2.in{animation:crmSlideUp .5s 1.1s ease forwards}
    .crm-line3.in{animation:crmSlideUp .5s 1.6s ease forwards}
    .crm-date.in{animation:crmChar .4s 2s ease forwards}
    @keyframes crmFadeIn{to{opacity:1}}
    @keyframes crmFadeOut{to{opacity:0;pointer-events:none}}
    @keyframes crmSlideUp{to{opacity:1;transform:translateY(0)}}
    @keyframes crmChar{to{opacity:1}}
    @keyframes crmPulse{0%,100%{transform:scale(1);opacity:.5}50%{transform:scale(1.1);opacity:.8}}

    /* â•â• MEMORIAL TAB â•â• */
    .mem-list{display:flex;flex-direction:column;gap:8px}
    .mem-card{display:flex;gap:14px;align-items:flex-start;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px 16px;cursor:pointer;transition:border-color .12s}
    .mem-card:hover{border-color:var(--acc)}
    .mem-icon{font-size:28px;flex-shrink:0;margin-top:2px}
    .mem-info{flex:1;min-width:0}
    .mem-title{font-size:14px;font-weight:700;margin-bottom:4px}
    .mem-sub{font-size:11px;color:var(--muted);line-height:1.5}
    .mem-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
    .mem-tag{font-size:10px;padding:2px 8px;border-radius:4px;background:var(--panel2);color:var(--muted);border:1px solid var(--line)}
    .mem-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
    .mem-date{font-size:10px;color:var(--muted)}
    .mem-cost{font-size:10px;color:var(--acc)}
    .mem-empty{text-align:center;padding:40px;color:var(--muted);font-size:13px}

    /* memorial detail */
    .md-timeline{position:relative;padding-left:24px;margin:16px 0}
    .md-timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--line)}
    .md-tl-item{position:relative;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--line)}
    .md-tl-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
    .md-tl-dot{position:absolute;left:-20px;top:3px;width:10px;height:10px;border-radius:50%;background:var(--acc);border:2px solid var(--bg)}
    .md-tl-dot.green{background:var(--ok)}
    .md-tl-dot.yellow{background:var(--warn)}
    .md-tl-dot.red{background:var(--danger)}
    .md-tl-from{font-size:11px;font-weight:700;color:var(--acc)}
    .md-tl-to{font-size:11px;color:var(--muted)}
    .md-tl-remark{font-size:12px;margin-top:3px;line-height:1.5}
    .md-tl-time{font-size:10px;color:var(--muted);margin-top:2px}

    /* â•â• TEMPLATE TAB â•â• */
    .tpl-cats{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .tpl-cat{font-size:12px;padding:6px 14px;border-radius:999px;border:1px solid var(--line);background:var(--panel);color:var(--muted);cursor:pointer;transition:all .12s}
    .tpl-cat:hover{border-color:var(--acc);color:var(--text)}
    .tpl-cat.active{border-color:var(--acc);color:var(--acc);background:#0a1228}
    .tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px}
    .tpl-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;transition:border-color .12s;cursor:pointer;display:flex;flex-direction:column}
    .tpl-card:hover{border-color:var(--acc)}
    .tpl-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .tpl-icon{font-size:24px}
    .tpl-name{font-size:14px;font-weight:700}
    .tpl-pop{font-size:10px;color:var(--muted);margin-left:auto}
    .tpl-desc{font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:10px;flex:1}
    .tpl-footer{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .tpl-dept{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--panel2);color:var(--acc)}
    .tpl-est{font-size:10px;color:var(--muted);margin-left:auto}
    .tpl-go{font-size:11px;padding:5px 14px;border-radius:6px;background:var(--acc);color:#fff;border:none;cursor:pointer;font-weight:600;margin-left:8px;transition:opacity .12s}
    .tpl-go:hover{opacity:.85}
    .tpl-form{margin-top:18px}
    .tpl-field{margin-bottom:14px}
    .tpl-label{font-size:12px;font-weight:600;display:block;margin-bottom:6px}
    .tpl-input{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--line);border-radius:8px;color:var(--text);font-size:13px;outline:none}
  </style>
</head>
<body>
<!-- COURT CEREMONY -->
<div class="ceremony-bg" id="ceremony" style="display:none" onclick="skipCeremony()">
  <div class="crm-glow"></div>
  <div class="crm-line1" id="crm-l1">æ—©æœå¼€å§‹</div>
  <div class="crm-line2" id="crm-l2">å„éƒ¨å¬æ—¨</div>
  <div class="crm-line3" id="crm-l3"></div>
  <div class="crm-date" id="crm-date"></div>
  <div class="crm-skip">ç‚¹å‡»ä»»æ„å¤„è·³è¿‡</div>
</div>

<div class="wrap">

  <!-- HEADER -->
  <div class="hdr">
    <div>
      <div class="logo">âš”ï¸ å†›æœºå¤„ Â· ä¸‰çœå…­éƒ¨æ€»æ§å°</div>
      <div class="sub">çš‡ä¸Šè§†è§’ Â· å®æ—¶æ—¨æ„è¿½è¸ª</div>
    </div>
    <div class="hdr-r">
      <span class="chip" id="chip-sync">âŸ³ åŒæ­¥ä¸­</span>
      <span class="chip" id="chip-tasks">â€” æ—¨æ„</span>
      <button class="btn-refresh" onclick="loadAll()">âŸ³ ç«‹å³åˆ·æ–°</button>
      <span id="cd"></span>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="edicts">ğŸ“œ æ—¨æ„çœ‹æ¿ <span class="tbadge" id="tb-e">0</span></div>
    <div class="tab" data-tab="monitor">ğŸ”­ çœéƒ¨è°ƒåº¦ <span class="tbadge" id="tb-m">0</span></div>
    <div class="tab" data-tab="officials">ğŸ‘¥ å®˜å‘˜æ€»è§ˆ</div>
    <div class="tab" data-tab="models">âš™ï¸ æ¨¡å‹é…ç½®</div>
    <div class="tab" data-tab="skills">ğŸ› ï¸ æŠ€èƒ½é…ç½®</div>
    <div class="tab" data-tab="sessions">ğŸ’¬ å°ä»»åŠ¡ <span class="tbadge" id="tb-s">0</span></div>
    <div class="tab" data-tab="memorials">ğŸ“œ å¥æŠ˜é˜ <span class="tbadge" id="tb-mem">0</span></div>
    <div class="tab" data-tab="templates">ğŸ“œ æ—¨åº“</div>
    <div class="tab" data-tab="morning">ğŸ“° å¤©ä¸‹è¦é—»</div>
  </div>

  <!-- â•â• æ—¨æ„çœ‹æ¿ â•â• -->
  <div class="panel active" id="panel-edicts">
    <div class="archive-bar" id="archive-bar">
      <span class="ab-label">ğŸ“‹ ç­›é€‰ï¼š</span>
      <button class="ab-btn active" data-filter="active" onclick="setEdictFilter('active')">ğŸ”¥ è¿›è¡Œä¸­</button>
      <button class="ab-btn" data-filter="archived" onclick="setEdictFilter('archived')">ğŸ“¦ å·²å½’æ¡£</button>
      <button class="ab-btn" data-filter="all" onclick="setEdictFilter('all')">å…¨éƒ¨</button>
      <span class="ab-count" id="archive-count"></span>
      <button class="ab-archive-all" id="btn-archive-done" onclick="archiveAllDone()" style="display:none">ğŸ“¦ ä¸€é”®å½’æ¡£å·²å®Œæˆ</button>
    </div>
    <div id="edict-grid" class="edict-grid"></div>
  </div>

  <!-- â•â• çœéƒ¨è°ƒåº¦ â•â• -->
  <div class="panel" id="panel-monitor">
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px">å„çœéƒ¨å½“å‰æ‰¿æ¥æ—¨æ„ä¸æ‰§è¡ŒçŠ¶æ€ Â· æ¯5ç§’è‡ªåŠ¨åˆ·æ–°</div>
    <div class="duty-grid" id="duty-grid"></div>
  </div>

  <!-- â•â• å®˜å‘˜æ€»è§ˆ â•â• -->
  <div class="panel" id="panel-officials">
    <div id="off-activity" class="off-activity" style="display:none"></div>
    <div id="off-kpi" class="off-kpi"></div>
    <div class="off-layout">
      <div id="off-ranklist" class="off-ranklist"></div>
      <div id="off-detail" class="off-detail"><div class="od-empty">â† ç‚¹å‡»å·¦ä¾§å®˜å‘˜æŸ¥çœ‹è¯¦æƒ…</div></div>
    </div>
  </div>

  <!-- â•â• æ¨¡å‹é…ç½® â•â• -->
  <div class="panel" id="panel-models">
    <div class="sec-title" style="margin-bottom:14px">å„çœéƒ¨ Â· æ¨¡å‹é…ç½® <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:var(--muted)">â€” æ›´æ”¹åè‡ªåŠ¨é‡å¯ Gatewayï¼ˆçº¦5ç§’ï¼‰</span></div>
    <div class="model-grid" id="model-grid"></div>
    <div class="cl-wrap"><div class="cl-title">å˜æ›´è®°å½•</div><div id="cl-list"></div></div>
  </div>

  <!-- â•â• æŠ€èƒ½é…ç½® â•â• -->
  <div class="panel" id="panel-skills">
    <div class="sec-title" style="margin-bottom:14px">å„çœéƒ¨ Â· Skills é…ç½® <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:var(--muted)">â€” ç‚¹å‡»æŠ€èƒ½æŸ¥çœ‹è¯¦æƒ…ï¼Œåº•éƒ¨å¯æ·»åŠ æ–°æŠ€èƒ½</span></div>
    <div class="skills-grid" id="skills-grid"></div>
  </div>

  <!-- â•â• å°ä»»åŠ¡/ä¼šè¯ç›‘æ§ â•â• -->
  <div class="panel" id="panel-sessions">
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px">é£ä¹¦/Telegram ä¸­çš„æ—¥å¸¸å¯¹è¯ä¸å°ä»»åŠ¡ Â· éJJCåœ£æ—¨ç±»ä»»åŠ¡</div>
    <div class="sess-filters">
      <span style="font-size:11px;color:var(--muted)">ç­›é€‰ï¼š</span>
      <span class="sess-filter active" data-sf="all" onclick="filterSessions('all',this)">å…¨éƒ¨</span>
      <span class="sess-filter" data-sf="active" onclick="filterSessions('active',this)">è¿›è¡Œä¸­</span>
      <span class="sess-filter" data-sf="zhongshu" onclick="filterSessions('zhongshu',this)">ä¸­ä¹¦çœ</span>
      <span class="sess-filter" data-sf="shangshu" onclick="filterSessions('shangshu',this)">å°šä¹¦çœ</span>
      <span class="sess-filter" data-sf="libu" onclick="filterSessions('libu',this)">ç¤¼éƒ¨</span>
      <span class="sess-filter" data-sf="hubu" onclick="filterSessions('hubu',this)">æˆ·éƒ¨</span>
      <span class="sess-filter" data-sf="bingbu" onclick="filterSessions('bingbu',this)">å…µéƒ¨</span>
      <span class="sess-filter" data-sf="gongbu" onclick="filterSessions('gongbu',this)">å·¥éƒ¨</span>
    </div>
    <div id="sess-grid" class="sess-grid"></div>
  </div>

  <!-- â•â• å¥æŠ˜é˜ â•â• -->
  <div class="panel" id="panel-memorials">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div style="flex:1">
        <div class="sec-title" style="margin-bottom:2px">ğŸ“œ å¥æŠ˜é˜ Â· æ—¨æ„å­˜æ¡£</div>
        <div style="font-size:11px;color:var(--muted)">ä»»åŠ¡å®Œæˆåè‡ªåŠ¨ç”Ÿæˆå¥æŠ˜ï¼Œè®°å½•ä»ä¸‹æ—¨åˆ°å®Œæˆçš„å®Œæ•´è¿‡ç¨‹</div>
      </div>
      <select id="mem-filter" onchange="renderMemorials()" style="font-size:11px;padding:4px 10px;background:var(--panel2);border:1px solid var(--line);border-radius:6px;color:var(--text);outline:none">
        <option value="all">å…¨éƒ¨</option>
        <option value="Done">å·²å®Œæˆ</option>
        <option value="Cancelled">å·²å–æ¶ˆ</option>
      </select>
    </div>
    <div id="mem-list" class="mem-list"></div>
  </div>

  <!-- â•â• åœ£æ—¨æ¨¡æ¿åº“ â•â• -->
  <div class="panel" id="panel-templates">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div style="flex:1">
        <div class="sec-title" style="margin-bottom:2px">ğŸ“œ æ—¨åº“ Â· åœ£æ—¨æ¨¡æ¿</div>
        <div style="font-size:11px;color:var(--muted)">é€‰æ‹©æ¨¡æ¿ã€å¡«å†™å‚æ•°ã€ä¸€é”®ä¸‹æ—¨ â€” é™ä½ä½¿ç”¨é—¨æ§›ï¼Œå¿«é€Ÿå¯åŠ¨ä»»åŠ¡</div>
      </div>
    </div>
    <div class="tpl-cats" id="tpl-cats"></div>
    <div class="tpl-grid" id="tpl-grid"></div>
  </div>

  <!-- â•â• å¤©ä¸‹è¦é—» â•â• -->
  <div class="panel" id="panel-morning">
    <div class="mb-hdr">
      <div>
        <div class="mb-title">ğŸ“° å¤©ä¸‹è¦é—» Â· å¾¡è§ˆ</div>
        <div id="mb-subtitle" class="mb-sub">åŠ è½½ä¸­â€¦</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-g" onclick="toggleSubConfig()" style="font-size:12px;padding:6px 14px">âš™ è®¢é˜…ç®¡ç†</button>
        <button class="btn btn-g" id="mb-refresh-btn" onclick="refreshNews()" style="font-size:12px;padding:6px 14px">âŸ³ ç«‹å³é‡‡é›†</button>
      </div>
    </div>

    <!-- è®¢é˜…ç®¡ç†é¢æ¿ -->
    <div id="sub-config" class="sub-config" style="display:none">
      <div class="sub-section">
        <div class="sub-sec-title">ğŸ“‚ æ–°é—»åˆ†ç±» <span style="font-weight:400;font-size:11px;color:var(--muted)">â€” å‹¾é€‰å¯ç”¨ï¼Œå–æ¶ˆç¦ç”¨</span></div>
        <div id="sub-cats" class="sub-cats"></div>
      </div>
      <div class="sub-section">
        <div class="sub-sec-title">ğŸ”‘ è‡ªå®šä¹‰å…³æ³¨è¯ <span style="font-weight:400;font-size:11px;color:var(--muted)">â€” é¢å¤–å…³é”®è¯è¿‡æ»¤</span></div>
        <div id="sub-keywords" class="sub-kw-list"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <input id="new-kw" class="sub-input" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå¦‚ï¼šèŠ¯ç‰‡ã€SpaceXâ€¦" onkeydown="if(event.key==='Enter')addKeyword()">
          <button class="btn btn-p" onclick="addKeyword()" style="font-size:12px;padding:6px 14px">æ·»åŠ </button>
        </div>
      </div>
      <div class="sub-section">
        <div class="sub-sec-title">ğŸ“¡ è‡ªå®šä¹‰ RSS æº</div>
        <div id="sub-feeds" class="sub-feed-list"></div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <input id="new-feed-name" class="sub-input" placeholder="æºåç§°" style="max-width:120px">
          <input id="new-feed-url" class="sub-input" placeholder="RSS URL" style="flex:1">
          <select id="new-feed-cat" class="sub-input" style="max-width:130px"></select>
          <button class="btn btn-p" onclick="addFeed()" style="font-size:12px;padding:6px 14px">æ·»åŠ </button>
        </div>
      </div>
      <div class="sub-section">
        <div class="sub-sec-title">ğŸ”” é£ä¹¦æ¨é€</div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <input id="feishu-webhook" class="sub-input" placeholder="é£ä¹¦ Webhook URLï¼ˆç•™ç©ºåˆ™ä¸æ¨é€ï¼‰" style="flex:1">
          <button class="btn btn-p" onclick="saveSubConfig()" style="font-size:12px;padding:6px 14px">ä¿å­˜å…¨éƒ¨é…ç½®</button>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px">é‡‡é›†å®Œæˆåè‡ªåŠ¨æ¨é€ç®€æŠ¥é“¾æ¥åˆ°é£ä¹¦ç¾¤ã€‚<a href="https://open.feishu.cn/document/client-docs/bot-v3/add-custom-bot" target="_blank" style="color:var(--acc)">å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰æœºå™¨äººï¼Ÿ</a></div>
      </div>
      <div id="sub-status" style="font-size:12px;margin-top:8px;display:none"></div>
    </div>

    <div id="mb-body"></div>
  </div>
</div>

<!-- TASK DETAIL MODAL -->
<div class="modal-bg" id="modal-bg" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-close" onclick="closeModal()">âœ•</div>
    <div id="modal-body"></div>
  </div>
</div>

<!-- CONFIRM DIALOG -->
<div class="confirm-bg" id="confirm-bg">
  <div class="confirm-box">
    <div class="confirm-title" id="confirm-title"></div>
    <div class="confirm-msg" id="confirm-msg"></div>
    <input class="confirm-input" id="confirm-reason" placeholder="åŸå› ï¼ˆå¯é€‰ï¼‰"/>
    <div class="confirm-btns">
      <button class="btn btn-g" onclick="closeConfirm()">å–æ¶ˆ</button>
      <button class="btn btn-p" id="confirm-ok" onclick="doConfirm()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<div id="toaster"></div>

<script>
/* â•â• CONFIG â•â• */
const API = (location.origin === 'file://' ? 'http://127.0.0.1:7891' : location.origin) + '/api';
let liveStatus=null, agentConfig=null, activeTab='edicts', countdown=5;

/* â•â• PIPELINE DEFINITION â•â• */
const PIPE = [
  {key:'Inbox',    dept:'çš‡ä¸Š',   icon:'ğŸ‘‘', action:'ä¸‹æ—¨'},
  {key:'Zhongshu', dept:'ä¸­ä¹¦çœ', icon:'ğŸ“œ', action:'è§„åˆ’'},
  {key:'Menxia',   dept:'é—¨ä¸‹çœ', icon:'ğŸ”', action:'å®¡è®®'},
  {key:'Assigned', dept:'å°šä¹¦çœ', icon:'ğŸ“®', action:'æ´¾å‘'},
  {key:'Doing',    dept:'å…­éƒ¨',   icon:'âš™ï¸', action:'æ‰§è¡Œ'},
  {key:'Review',   dept:'å°šä¹¦çœ', icon:'ğŸ”', action:'æ±‡æ€»'},
  {key:'Done',     dept:'å›å¥',   icon:'âœ…', action:'å®Œæˆ'},
];
const PIPE_STATE_IDX = {Inbox:0,Zhongshu:1,Menxia:2,Assigned:3,Doing:4,Review:5,Done:6,Blocked:4,Cancelled:4,Next:3};

/* â•â• DEPT COLORS â•â• */
const DEPT_COLOR = {'ä¸­ä¹¦çœ':'#a07aff','é—¨ä¸‹çœ':'#6a9eff','å°šä¹¦çœ':'#6aef9a','ç¤¼éƒ¨':'#f5c842','æˆ·éƒ¨':'#ff9a6a','å…µéƒ¨':'#ff5270','åˆ‘éƒ¨':'#cc4444','å·¥éƒ¨':'#44aaff','çš‡ä¸Š':'#ffd700','å›å¥':'#2ecc8a'};
function deptColor(d){return DEPT_COLOR[d]||'#6a9eff'}

/* â•â• UTILS â•â• */
const esc=s=>s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
async function fetchJ(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw Error(r.status);return r.json()}
async function postJ(u,d){const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});return r.json()}
function toast(msg,type='ok',ms=3000){const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;document.getElementById('toaster').appendChild(el);setTimeout(()=>el.remove(),ms)}
const STATE_LABEL={Inbox:'æ”¶ä»¶',Zhongshu:'ä¸­ä¹¦è§„åˆ’',Menxia:'é—¨ä¸‹å®¡è®®',Assigned:'å·²æ´¾å‘',Doing:'æ‰§è¡Œä¸­',Review:'å¾…å®¡æŸ¥',Done:'å·²å®Œæˆ',Blocked:'é˜»å¡',Cancelled:'å·²å–æ¶ˆ',Next:'å¾…æ‰§è¡Œ'};
// æ ¹æ®è½®æ¬¡åŠ¨æ€ç”ŸæˆçŠ¶æ€æ ‡ç­¾
function stateLabel(t){
  const r = t.review_round||0;
  if(t.state==='Menxia' && r>1) return `é—¨ä¸‹å®¡è®®ï¼ˆç¬¬${r}è½®ï¼‰`;
  if(t.state==='Zhongshu' && r>0) return `ä¸­ä¹¦ä¿®è®¢ï¼ˆç¬¬${r}è½®ï¼‰`;
  return STATE_LABEL[t.state]||t.state;
}

/* â•â• TASK CLASSIFICATION â•â• */
// çš‡ä¸Šçš„æ—¨æ„ï¼šJJC-* å¼€å¤´ï¼Œæœ‰çœŸå®æ ‡é¢˜
function isEdict(t){ return /^JJC-/i.test(t.id||'') }
// ç³»ç»Ÿä¼šè¯ï¼šOC-* / MC-* å¼€å¤´
function isSession(t){ return /^(OC-|MC-)/i.test(t.id||'') }
// å½’æ¡£åˆ¤å®šï¼šDone/Cancelled æˆ–æ‰‹åŠ¨æ ‡è®° archived
function isArchived(t){ return t.archived || ['Done','Cancelled'].includes(t.state) }
let edictFilter = 'active';  // 'active' | 'archived' | 'all'
function setEdictFilter(f){
  edictFilter = f;
  document.querySelectorAll('.archive-bar .ab-btn').forEach(b=>b.classList.toggle('active',b.dataset.filter===f));
  if(liveStatus) renderEdicts(liveStatus.tasks||[]);
}

/* â•â• PIPE STATUS FOR A TASK â•â• */
function getPipeStatus(t){
  const stateIdx = PIPE_STATE_IDX[t.state] ?? 4;
  return PIPE.map((stage, i) => ({
    ...stage,
    status: i < stateIdx ? 'done' : i === stateIdx ? 'active' : 'pending'
  }));
}

/* â•â• CARD MINI PIPELINE â•â• */
function miniPipe(t){
  const stages = getPipeStatus(t);
  return `<div class="ec-pipe">
    ${stages.map((s,i) => `
      <div class="ep-node ${s.status}">
        <div class="ep-icon">${s.icon}</div>
        <div class="ep-name">${s.dept}</div>
      </div>
      ${i < stages.length-1 ? `<div class="ep-arrow">â€º</div>` : ''}
    `).join('')}
  </div>`;
}

/* â•â• EDICT CARDS â•â• */
function renderEdicts(tasks){
  const allEdicts = tasks.filter(isEdict);
  const activeEdicts = allEdicts.filter(t=>!isArchived(t));
  const archivedEdicts = allEdicts.filter(t=>isArchived(t));
  // Apply filter
  let edicts;
  if(edictFilter==='active') edicts = activeEdicts;
  else if(edictFilter==='archived') edicts = archivedEdicts;
  else edicts = allEdicts;
  edicts.sort((a,b) => {
    const order = {Doing:0,Review:1,Assigned:2,Menxia:3,Zhongshu:4,Inbox:5,Blocked:6,Next:7,Done:8,Cancelled:9};
    return (order[a.state]??9) - (order[b.state]??9);
  });
  // Tab badge = active count only
  document.getElementById('tb-e').textContent = activeEdicts.length;
  document.getElementById('chip-tasks').textContent = activeEdicts.length + ' é“æ—¨æ„';
  // Archive stats
  document.getElementById('archive-count').textContent = `æ´»è·ƒ ${activeEdicts.length} Â· å½’æ¡£ ${archivedEdicts.length} Â· å…± ${allEdicts.length}`;
  // Show "ä¸€é”®å½’æ¡£" button if there are un-archived Done/Cancelled tasks
  const unArchivedDone = allEdicts.filter(t=>!t.archived && ['Done','Cancelled'].includes(t.state));
  document.getElementById('btn-archive-done').style.display = unArchivedDone.length ? '' : 'none';
  const el = document.getElementById('edict-grid');
  if(!edicts.length){
    el.innerHTML='<div class="empty" style="grid-column:1/-1">æš‚æ— æ—¨æ„<br><small style="font-size:11px;margin-top:6px;display:block;color:var(--muted)">é€šè¿‡é£ä¹¦/Telegram å‘ä¸­ä¹¦çœå‘é€ä»»åŠ¡ï¼Œä»»åŠ¡IDæ ¼å¼ JJC-* å°†æ˜¾ç¤ºäºæ­¤</small></div>';
    return;
  }
  el.innerHTML = edicts.map(t => {
    const hb = t.heartbeat||{status:'unknown',label:'âšª'};
    const deptCls = 'dt-'+(t.org||'').replace(/\s/g,'');
    const stCls = 'st-'+(t.state||'');
    const isBlocked = t.block && t.block !== 'æ— ' && t.block !== '-';
    const curStage = PIPE.find((_,i) => getPipeStatus(t)[i].status === 'active');
    const todos = t.todos||[];
    const todoDone = todos.filter(x=>x.status==='completed').length;
    const todoTotal = todos.length;
    const canStop = !['Done','Blocked','Cancelled'].includes(t.state);
    const canResume = ['Blocked','Cancelled'].includes(t.state);
    const archCls = isArchived(t) ? ' archived' : '';
    return `
    <div class="edict-card${archCls}" onclick='openTask(${JSON.stringify(t.id)})'>
      ${miniPipe(t)}
      <div class="ec-id">${esc(t.id)}</div>
      <div class="ec-title">${esc(t.title||'(æ— æ ‡é¢˜)')}</div>
      <div class="ec-meta">
        <span class="tag ${stCls}">${stateLabel(t)}</span>
        ${t.org ? `<span class="tag ${deptCls}">${esc(t.org)}</span>` : ''}
        ${curStage ? `<span style="font-size:11px;color:var(--muted)">å½“å‰: <b style="color:${deptColor(curStage.dept)}">${curStage.dept} Â· ${curStage.action}</b></span>` : ''}
      </div>
      ${t.now && t.now !== '-' ? `<div style="font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:6px">${esc(t.now.substring(0,80))}</div>` : ''}
      ${(t.review_round||0)>0 ? `<div style="font-size:11px;margin-bottom:6px">
        ${Array.from({length:t.review_round||0},(_,i)=>`<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${i<(t.review_round||0)-1?'#1a3a6a':'var(--acc)'}22;border:1px solid ${i<(t.review_round||0)-1?'#2a4a8a':'var(--acc)'};font-size:9px;text-align:center;line-height:13px;margin-right:2px;color:${i<(t.review_round||0)-1?'#4a6aaa':'var(--acc)'}">${i+1}</span>`).join('')}
        <span style="color:var(--muted);font-size:10px">ç¬¬ ${t.review_round} è½®ç£‹å•†</span>
      </div>` : ''}
      ${todoTotal ? `<div class="ec-todo-bar">
        <span>ğŸ“‹ ${todoDone}/${todoTotal}</span>
        <div class="ec-todo-track"><div class="ec-todo-fill" style="width:${Math.round(todoDone/todoTotal*100)}%"></div></div>
        <span>${todoDone===todoTotal?'âœ… å…¨éƒ¨å®Œæˆ':'ğŸ”„ è¿›è¡Œä¸­'}</span>
      </div>` : ''}
      <div class="ec-footer">
        <span class="hb ${hb.status}">${esc(hb.label)}</span>
        ${isBlocked ? `<span class="tag" style="border-color:#ff527044;color:var(--danger);background:#200a10">ğŸš« ${esc(t.block)}</span>` : ''}
        ${t.eta && t.eta !== '-' ? `<span style="font-size:11px;color:var(--muted)">ğŸ“… ${esc(t.eta)}</span>` : ''}
      </div>
      <div class="ec-actions" onclick="event.stopPropagation()">
        ${canStop ? `<button class="mini-act" onclick="confirmAction('${esc(t.id)}','stop')">â¸ å«åœ</button>
        <button class="mini-act danger" onclick="confirmAction('${esc(t.id)}','cancel')">ğŸš« å–æ¶ˆ</button>` : ''}
        ${canResume ? `<button class="mini-act" onclick="taskAction('${esc(t.id)}','resume','æ¢å¤æ‰§è¡Œ')">â–¶ æ¢å¤</button>` : ''}
        ${isArchived(t) && !t.archived ? `<button class="mini-act" onclick="archiveTask('${esc(t.id)}')" title="ç§»å…¥å½’æ¡£">ğŸ“¦ å½’æ¡£</button>` : ''}
        ${t.archived ? `<button class="mini-act" onclick="unarchiveTask('${esc(t.id)}')" title="å–æ¶ˆå½’æ¡£">ğŸ“¤ å–æ¶ˆå½’æ¡£</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

/* â•â• DEPT MONITOR â•â• */
function renderMonitor(tasks){
  const DEPTS = [
    {id:'zhongshu',label:'ä¸­ä¹¦çœ',emoji:'ğŸ“œ',role:'ä¸­ä¹¦ä»¤',  rank:'æ­£ä¸€å“'},
    {id:'menxia',  label:'é—¨ä¸‹çœ',emoji:'ğŸ”',role:'ä¾ä¸­',    rank:'æ­£ä¸€å“'},
    {id:'shangshu',label:'å°šä¹¦çœ',emoji:'ğŸ“®',role:'å°šä¹¦ä»¤',  rank:'æ­£ä¸€å“'},
    {id:'libu',    label:'ç¤¼éƒ¨',  emoji:'ğŸ“',role:'ç¤¼éƒ¨å°šä¹¦',rank:'æ­£äºŒå“'},
    {id:'hubu',    label:'æˆ·éƒ¨',  emoji:'ğŸ’°',role:'æˆ·éƒ¨å°šä¹¦',rank:'æ­£äºŒå“'},
    {id:'bingbu',  label:'å…µéƒ¨',  emoji:'âš”ï¸',role:'å…µéƒ¨å°šä¹¦',rank:'æ­£äºŒå“'},
    {id:'xingbu',  label:'åˆ‘éƒ¨',  emoji:'âš–ï¸',role:'åˆ‘éƒ¨å°šä¹¦',rank:'æ­£äºŒå“'},
    {id:'gongbu',  label:'å·¥éƒ¨',  emoji:'ğŸ”§',role:'å·¥éƒ¨å°šä¹¦',rank:'æ­£äºŒå“'},
  ];

  // æ¯ä¸ªéƒ¨é—¨å½“å‰æ‰¿æ¥çš„æ—¨æ„ï¼šä» JJC ä»»åŠ¡é‡Œæ‰¾ org åŒ¹é…ä¸”é Done çš„
  const activeTasks = tasks.filter(t => isEdict(t) && t.state !== 'Done' && t.state !== 'Next');
  // å®˜å‘˜ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚å·²åŠ è½½ï¼‰
  const offMap = {};
  if(officialsData && officialsData.officials){
    officialsData.officials.forEach(o=>offMap[o.id]=o);
  }

  let activeCount = 0;
  const cards = DEPTS.map(d => {
    // è¯¥éƒ¨é—¨æ­£åœ¨å¤„ç†çš„æ—¨æ„
    const myTasks = activeTasks.filter(t => t.org === d.label);
    // ä¹Ÿä» flow_log ä¸­æ‰¾æœ€è¿‘å‚ä¸çš„æ—¨æ„
    const recentEdict = tasks.filter(t=>isEdict(t))
      .find(t=>(t.flow_log||[]).some(f=>f.from===d.label||f.to===d.label));

    const isActive = myTasks.some(t=>t.state==='Doing');
    const isBlocked = myTasks.some(t=>t.state==='Blocked');
    const off = offMap[d.id]||{};
    const hb = off.heartbeat||{status:'idle',label:'âšª'};
    if(isActive) activeCount++;

    const dotCls = isBlocked?'blocked':isActive?'busy':hb.status==='active'?'active':'idle';
    const statusText = isBlocked?'âš ï¸ é˜»å¡':isActive?'âš™ï¸ æ‰§è¡Œä¸­':hb.status==='active'?'ğŸŸ¢ æ´»è·ƒ':'âšª å€™å‘½';
    const cardCls = isBlocked?'blocked-card':isActive?'active-card':'';

    return `<div class="duty-card ${cardCls}">
      <div class="dc-hdr">
        <span class="dc-emoji">${d.emoji}</span>
        <div class="dc-info">
          <div class="dc-name">${d.label}</div>
          <div class="dc-role">${d.role} Â· ${d.rank}</div>
        </div>
        <div class="dc-status">
          <span class="dc-dot ${dotCls}"></span>
          <span>${statusText}</span>
        </div>
      </div>
      <div class="dc-body">
        ${myTasks.length ? myTasks.map(t=>`
          <div class="dc-task" onclick='openTask(${JSON.stringify(t.id)})' style="cursor:pointer;padding:6px;border-radius:8px;border:1px solid var(--line);margin-bottom:6px">
            <div class="dc-task-id">${esc(t.id)}</div>
            <div class="dc-task-title">${esc(t.title||'(æ— æ ‡é¢˜)')}</div>
            ${t.now&&t.now!=='-'?`<div class="dc-task-now">${esc(t.now.substring(0,70))}</div>`:''}
            <div class="dc-task-meta">
              <span class="tag st-${t.state}">${stateLabel(t)}</span>
              ${t.block&&t.block!=='æ— '?`<span class="tag" style="border-color:#ff527044;color:var(--danger)">ğŸš«${esc(t.block)}</span>`:''}
            </div>
          </div>`).join('') :
          `<div class="dc-idle">
            <span style="font-size:20px">ğŸª­</span>
            <span>å€™å‘½ä¸­ ${recentEdict?`Â· æœ€è¿‘å‚ä¸ <b style="color:var(--muted)">${esc(recentEdict.id)}</b>`:'Â· å°šæ— æ—¨æ„è®°å½•'}</span>
          </div>`}
      </div>
      <div class="dc-footer">
        <span class="dc-model">ğŸ¤– ${esc(off.model_short||'å¾…é…ç½®')}</span>
        ${off.last_active?`<span class="dc-la">â° ${esc(off.last_active)}</span>`:''}
      </div>
    </div>`;
  });

  document.getElementById('tb-m').textContent = activeCount + 'æ´»è·ƒ';
  document.getElementById('duty-grid').innerHTML = cards.join('');
}

/* â•â• TASK DETAIL MODAL â•â• */
function openTask(id){
  if(!liveStatus||!liveStatus.tasks)return;
  const t = liveStatus.tasks.find(x=>x.id===id);
  if(!t)return;
  const stages = getPipeStatus(t);
  const activeStage = stages.find(s=>s.status==='active');
  const hb = t.heartbeat||{status:'unknown',label:'âšª æ— æ•°æ®'};
  const flowLog = t.flow_log||[];
  const todos = t.todos||[];
  const todoDone = todos.filter(x=>x.status==='completed').length;
  const todoTotal = todos.length;
  const canStop = !['Done','Blocked','Cancelled'].includes(t.state);
  const canResume = ['Blocked','Cancelled'].includes(t.state);

  document.getElementById('modal-body').innerHTML = `
    <div class="modal-id">${esc(t.id)}</div>
    <div class="modal-title">${esc(t.title||'(æ— æ ‡é¢˜)')}</div>

    <!-- å½“å‰é˜¶æ®µæ¨ªå¹… -->
    ${activeStage ? `
    <div class="cur-stage">
      <div class="cs-icon">${activeStage.icon}</div>
      <div class="cs-info">
        <div class="cs-dept" style="color:${deptColor(activeStage.dept)}">${activeStage.dept}</div>
        <div class="cs-action">å½“å‰é˜¶æ®µï¼š${activeStage.action}</div>
      </div>
      <span class="hb ${hb.status} cs-hb">${esc(hb.label)}</span>
    </div>` : ''}

    <!-- æµç¨‹ç®¡çº¿ -->
    <div class="m-pipe">
      ${stages.map((s,i) => `
        <div class="mp-stage">
          <div class="mp-node ${s.status}">
            ${s.status==='done' ? '<div class="mp-done-tick">âœ“</div>' : ''}
            <div class="mp-icon">${s.icon}</div>
            <div class="mp-dept" style="${s.status==='active'?'color:var(--acc)':s.status==='done'?'color:var(--ok)':''}">${s.dept}</div>
            <div class="mp-action">${s.action}</div>
          </div>
          ${i < stages.length-1 ? `<div class="mp-arrow" style="${s.status==='done'?'color:var(--ok);opacity:.6':''}">â†’</div>` : ''}
        </div>
      `).join('')}
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="task-actions">
      ${canStop ? `<button class="btn-action btn-stop" onclick="confirmAction('${esc(t.id)}','stop')">â¸ å«åœä»»åŠ¡</button>
      <button class="btn-action btn-cancel" onclick="confirmAction('${esc(t.id)}','cancel')">ğŸš« å–æ¶ˆä»»åŠ¡</button>` : ''}
      ${canResume ? `<button class="btn-action btn-resume" onclick="taskAction('${esc(t.id)}','resume','æ¢å¤æ‰§è¡Œ')">â–¶ï¸ æ¢å¤æ‰§è¡Œ</button>` : ''}
    </div>

    <!-- Todo å­ä»»åŠ¡ -->
    ${todoTotal ? `
    <div class="todo-section">
      <div class="todo-header">
        <div class="m-sec-label" style="margin-bottom:0;border:none;padding:0">å­ä»»åŠ¡æ¸…å•ï¼ˆ${todoDone}/${todoTotal}ï¼‰</div>
        <div class="todo-progress">
          <div class="todo-bar"><div class="todo-bar-fill" style="width:${Math.round(todoDone/todoTotal*100)}%"></div></div>
          <span>${Math.round(todoDone/todoTotal*100)}%</span>
        </div>
      </div>
      <div class="todo-list">
        ${todos.map(td => {
          const ico = td.status==='completed'?'âœ…':td.status==='in-progress'?'ğŸ”„':'â¬œ';
          const stCls = td.status==='completed'?'s-done':td.status==='in-progress'?'s-progress':'s-notstarted';
          const stLabel = td.status==='completed'?'å·²å®Œæˆ':td.status==='in-progress'?'è¿›è¡Œä¸­':'å¾…å¼€å§‹';
          const itemCls = td.status==='completed'?'done':'';
          return `<div class="todo-item ${itemCls}">
            <span class="t-icon">${ico}</span>
            <span class="t-id">#${td.id||''}</span>
            <span class="t-title">${esc(td.title||'')}</span>
            <span class="t-status ${stCls}">${stLabel}</span>
          </div>`;
        }).join('')}
      </div>
    </div>` : ''}

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="m-section">
      <div class="m-rows">
        <div class="m-row"><div class="mr-label">çŠ¶æ€</div><div class="mr-val"><span class="tag st-${t.state}">${stateLabel(t)}</span>${(t.review_round||0)>0?`<span style="font-size:11px;color:var(--muted);margin-left:8px">å…±ç£‹å•† ${t.review_round} è½®</span>`:''}</div></div>
        <div class="m-row"><div class="mr-label">æ‰§è¡Œéƒ¨é—¨</div><div class="mr-val"><span class="tag dt-${(t.org||'').replace(/\s/g,'')}">${esc(t.org||'â€”')}</span></div></div>
        ${t.eta&&t.eta!=='-'?`<div class="m-row"><div class="mr-label">é¢„è®¡å®Œæˆ</div><div class="mr-val">${esc(t.eta)}</div></div>`:''}
        ${t.block&&t.block!=='æ— '&&t.block!=='-'?`<div class="m-row"><div class="mr-label" style="color:var(--danger)">é˜»å¡é¡¹</div><div class="mr-val" style="color:var(--danger)">${esc(t.block)}</div></div>`:''}
        ${t.now&&t.now!=='-'?`<div class="m-row" style="grid-column:1/-1"><div class="mr-label">å½“å‰è¿›å±•</div><div class="mr-val" style="font-weight:400;font-size:12px">${esc(t.now)}</div></div>`:''}
        ${t.ac?`<div class="m-row" style="grid-column:1/-1"><div class="mr-label">éªŒæ”¶æ ‡å‡†</div><div class="mr-val" style="font-weight:400;font-size:12px">${esc(t.ac)}</div></div>`:''}
      </div>
    </div>

    <!-- æµè½¬æ—¥å¿— -->
    ${flowLog.length ? `
    <div class="m-section">
      <div class="m-sec-label">æµè½¬æ—¥å¿—ï¼ˆ${flowLog.length} æ¡ï¼‰</div>
      <div class="fl-timeline">
        ${flowLog.map(fl => {
          const col = deptColor(fl.from||'');
          const isOk = (fl.remark||'').includes('âœ…')||fl.to==='çš‡ä¸Š';
          const dotCls = isOk ? 'fl-ok' : (fl.from==='çš‡ä¸Š'||fl.to==='çš‡ä¸Š') ? 'fl-purple' : 'fl-blue';
          return `<div class="fl-item">
            <div class="fl-time">${fl.at?fl.at.substring(11,16):''}</div>
            <div class="fl-dot" style="background:${col}"></div>
            <div class="fl-content">
              <div class="fl-who">
                <span class="from" style="color:${col}">${esc(fl.from||'')}</span>
                <span style="color:var(--muted)"> â†’ </span>
                <span class="to" style="color:${deptColor(fl.to||'')}">${esc(fl.to||'')}</span>
              </div>
              <div class="fl-rem ${dotCls}">${esc(fl.remark||'')}</div>
            </div>
          </div>`
        }).join('')}
      </div>
    </div>` : '<div style="font-size:12px;color:var(--muted);padding:8px 0">æš‚æ— æµè½¬è®°å½•ï¼ˆä»»åŠ¡å¯åŠ¨åè‡ªåŠ¨å¡«å……ï¼‰</div>'}

    <!-- äº§å‡ºç‰© -->
    ${t.output&&t.output!=='-'&&t.output!==''?`
    <div class="m-section">
      <div class="m-sec-label">äº§å‡ºç‰©</div>
      <code>${esc(t.output)}</code>
    </div>`:''}
  `;

  document.getElementById('modal-bg').classList.add('open');
}

function closeModal(e){
  if(e&&e.target!==document.getElementById('modal-bg')&&!e.target.classList.contains('modal-close'))return;
  document.getElementById('modal-bg').classList.remove('open');
}

/* â•â• MODEL CONFIG â•â• */
const KNOWN_MODELS=[
  {id:'anthropic/claude-sonnet-4-6',l:'Claude Sonnet 4.6',p:'Anthropic'},
  {id:'anthropic/claude-opus-4-5',l:'Claude Opus 4.5',p:'Anthropic'},
  {id:'anthropic/claude-haiku-3-5',l:'Claude Haiku 3.5',p:'Anthropic'},
  {id:'openai/gpt-4o',l:'GPT-4o',p:'OpenAI'},
  {id:'openai/gpt-4o-mini',l:'GPT-4o Mini',p:'OpenAI'},
  {id:'openai-codex/gpt-5.3-codex',l:'GPT-5.3 Codex',p:'OpenAI Codex'},
  {id:'google/gemini-2.0-flash',l:'Gemini 2.0 Flash',p:'Google'},
  {id:'google/gemini-2.5-pro',l:'Gemini 2.5 Pro',p:'Google'},
  {id:'copilot/claude-sonnet-4',l:'Claude Sonnet 4',p:'Copilot'},
  {id:'copilot/claude-opus-4.5',l:'Claude Opus 4.5',p:'Copilot'},
  {id:'github-copilot/claude-opus-4.6',l:'Claude Opus 4.6',p:'GitHub Copilot'},
  {id:'copilot/gpt-4o',l:'GPT-4o',p:'Copilot'},
  {id:'copilot/gemini-2.5-pro',l:'Gemini 2.5 Pro',p:'Copilot'},
  {id:'copilot/o3-mini',l:'o3-mini',p:'Copilot'},
];
function renderModels(cfg){
  if(!cfg||!cfg.agents){document.getElementById('model-grid').innerHTML='<div class="empty" style="grid-column:1/-1">è¯·ç¡®ä¿æœ¬åœ°æœåŠ¡å™¨å·²å¯åŠ¨</div>';return}
  const opts=KNOWN_MODELS.map(m=>`<option value="${m.id}">${m.l} (${m.p})</option>`).join('');
  document.getElementById('model-grid').innerHTML=cfg.agents.map(ag=>`
    <div class="mc-card">
      <div class="mc-top"><span class="mc-emoji">${ag.emoji||'ğŸ›ï¸'}</span>
        <div><div class="mc-name">${esc(ag.label)} <span style="font-size:11px;color:var(--muted)">${esc(ag.id)}</span></div><div class="mc-role">${esc(ag.role)}</div></div>
      </div>
      <div class="mc-cur">å½“å‰: <b>${esc(ag.model)}</b></div>
      <select class="msel" id="sel-${ag.id}" onchange="onMC('${ag.id}')">${opts}</select>
      <div class="mc-btns"><button class="btn btn-p" id="btn-${ag.id}" onclick="applyModel('${ag.id}')" disabled>åº”ç”¨</button><button class="btn btn-g" onclick="resetMC('${ag.id}')">é‡ç½®</button></div>
      <div class="mc-st" id="mcs-${ag.id}"></div>
    </div>`).join('');
  cfg.agents.forEach(ag=>{const s=document.getElementById('sel-'+ag.id);if(s)s.value=ag.model});
}
function onMC(id){const s=document.getElementById('sel-'+id),b=document.getElementById('btn-'+id),ag=agentConfig&&agentConfig.agents?agentConfig.agents.find(a=>a.id===id):null;if(!ag||!s)return;b.disabled=s.value===ag.model}
function resetMC(id){const s=document.getElementById('sel-'+id),b=document.getElementById('btn-'+id),ag=agentConfig&&agentConfig.agents?agentConfig.agents.find(a=>a.id===id):null;if(!ag||!s)return;s.value=ag.model;b.disabled=true}
async function applyModel(id){
  const s=document.getElementById('sel-'+id),b=document.getElementById('btn-'+id),st=document.getElementById('mcs-'+id);
  if(!s||!b)return;b.disabled=true;st.className='mc-st pending';st.textContent='âŸ³ æäº¤ä¸­â€¦';
  try{const r=await postJ(API+'/set-model',{agentId:id,model:s.value});
    if(r.ok){st.className='mc-st ok';st.textContent='âœ… å·²æäº¤ï¼ŒGateway é‡å¯ä¸­ï¼ˆçº¦5ç§’ï¼‰';toast(id+'æ¨¡å‹å·²æ›´æ”¹','ok');setTimeout(()=>loadAgentConfig(),5500)}
    else{st.className='mc-st err';st.textContent='âŒ '+( r.error||'é”™è¯¯');b.disabled=false}
  }catch(e){st.className='mc-st err';st.textContent='âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨';b.disabled=false}
}
function renderCL(log){
  const el=document.getElementById('cl-list');
  if(!log||!log.length){el.innerHTML='<div style="font-size:12px;color:var(--muted);padding:8px 0">æš‚æ— å˜æ›´</div>';return}
  el.innerHTML=[...log].reverse().slice(0,15).map(e=>`<div class="cl-row"><span class="cl-t">${esc((e.at||'').substring(0,16).replace('T',' '))}</span><span class="cl-a">${esc(e.agentId||'')}</span><span class="cl-c"><b>${esc(e.oldModel||'')}</b> â†’ <b>${esc(e.newModel||'')}</b></span></div>`).join('')
}

/* â•â• SKILLS â•â• */
function renderSkills(cfg){
  if(!cfg||!cfg.agents){document.getElementById('skills-grid').innerHTML='<div class="empty">æ— æ³•åŠ è½½</div>';return}
  document.getElementById('skills-grid').innerHTML=cfg.agents.map(ag=>`
    <div class="sk-card"><div class="sk-hdr"><span class="sk-emoji">${ag.emoji||'ğŸ›ï¸'}</span><span class="sk-name">${esc(ag.label)}</span><span class="sk-cnt">${(ag.skills||[]).length} æŠ€èƒ½</span></div>
    <div class="sk-list">${!(ag.skills||[]).length?'<div class="sk-empty">æš‚æ—  Skills</div>':(ag.skills||[]).map(sk=>`<div class="sk-item" onclick="openSkill('${esc(ag.id)}','${esc(sk.name)}')"><span class="si-name">ğŸ“¦ ${esc(sk.name)}</span><span class="si-desc">${esc(sk.description||'æ— æè¿°')}</span><span class="si-arrow">â€º</span></div>`).join('')}</div>
    <div class="sk-add" onclick="openAddSkillForm('${esc(ag.id)}','${esc(ag.label)}')">ï¼‹ æ·»åŠ æŠ€èƒ½</div></div>`).join('')
}

/* skill detail modal â€” å†™å…¥ modal-body (å¤ç”¨å·²æœ‰ modal) */
async function openSkill(agentId, skillName){
  document.getElementById('modal-body').innerHTML=`
    <div style="font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:4px">${esc(agentId.toUpperCase())}</div>
    <div style="font-size:20px;font-weight:800;margin-bottom:16px">ğŸ“¦ ${esc(skillName)}</div>
    <div id="sk-modal-content" class="sk-modal-body"><div style="color:var(--muted);font-size:12px;padding:24px;text-align:center">âŸ³ åŠ è½½ä¸­â€¦</div></div>`;
  document.getElementById('modal-bg').classList.add('open');
  try{
    const r = await fetchJ(API+'/skill-content/'+encodeURIComponent(agentId)+'/'+encodeURIComponent(skillName));
    const el = document.getElementById('sk-modal-content');
    if(!el) return;
    if(r.ok){
      const html = simpleMarkdown(r.content||'');
      el.innerHTML = `<div class="sk-md">${html}</div><div class="sk-path">ğŸ“‚ ${esc(r.path||'')}</div>`;
    } else {
      el.innerHTML = `<div style="color:#ff5270;font-size:13px;padding:16px">âŒ ${esc(r.error||'æ— æ³•è¯»å–')}</div>`;
    }
  }catch(e){
    const el = document.getElementById('sk-modal-content');
    if(el) el.innerHTML = `<div style="color:#ff5270;font-size:13px;padding:16px">âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥</div>`;
  }
}

/* simple markdown â†’ HTML */
function simpleMarkdown(md){
  let h = esc(md);
  h = h.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
  h = h.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  h = h.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  h = h.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  h = h.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
  h = h.replace(/\*(.+?)\*/g, '<i>$1</i>');
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  h = h.replace(/^---$/gm, '<hr>');
  h = h.replace(/^\|(.+)\|$/gm, (m,row)=>{
    const cells=row.split('|').map(c=>c.trim());
    return '<tr>'+cells.map(c=>`<td>${c}</td>`).join('')+'</tr>';
  });
  h = h.replace(/(<tr>.*<\/tr>\n?)+/g, '<table>$&</table>');
  h = h.replace(/^- (.+)$/gm, '<li>$1</li>');
  h = h.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
  h = h.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
  h = h.replace(/\n\n/g, '</p><p>');
  h = '<p>' + h + '</p>';
  h = h.replace(/<p><\/p>/g, '');
  h = h.replace(/<p>(<h[123]>)/g, '$1');
  h = h.replace(/(<\/h[123]>)<\/p>/g, '$1');
  h = h.replace(/<p>(<pre>)/g, '$1');
  h = h.replace(/(<\/pre>)<\/p>/g, '$1');
  h = h.replace(/<p>(<ul>)/g, '$1');
  h = h.replace(/(<\/ul>)<\/p>/g, '$1');
  h = h.replace(/<p>(<table>)/g, '$1');
  h = h.replace(/(<\/table>)<\/p>/g, '$1');
  h = h.replace(/<p>(<hr>)<\/p>/g, '$1');
  return h;
}

/* â•â• ADD SKILL FORM (è§„èŒƒåŒ–è¡¨å•) â•â• */
function openAddSkillForm(agentId, agentLabel){
  document.getElementById('modal-body').innerHTML=`
    <div style="font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:4px">ä¸º ${esc(agentLabel)} æ·»åŠ æŠ€èƒ½</div>
    <div style="font-size:20px;font-weight:800;margin-bottom:18px">ï¼‹ æ–°å¢ Skill</div>
    <div style="background:var(--panel2);border:1px solid var(--line);border-radius:10px;padding:14px;margin-bottom:18px;font-size:12px;line-height:1.7;color:var(--muted)">
      <b style="color:var(--text)">ğŸ“‹ Skill è§„èŒƒè¯´æ˜</b><br>
      â€¢ æŠ€èƒ½åç§°ä½¿ç”¨<b style="color:var(--text)">å°å†™è‹±æ–‡ + è¿å­—ç¬¦</b>ï¼Œå¦‚ <code style="background:var(--bg);padding:2px 6px;border-radius:4px">data-analysis</code>ã€<code style="background:var(--bg);padding:2px 6px;border-radius:4px">code-review</code><br>
      â€¢ åˆ›å»ºåä¼šåœ¨ <code style="background:var(--bg);padding:2px 6px;border-radius:4px">~/.openclaw/workspace-${esc(agentId)}/skills/{name}/SKILL.md</code> ç”Ÿæˆæ¨¡æ¿æ–‡ä»¶<br>
      â€¢ SKILL.md ä½¿ç”¨ <b style="color:var(--text)">YAML frontmatter</b> å¤´éƒ¨ï¼ˆname + descriptionï¼‰ï¼Œæ­£æ–‡ä¸º Markdown æ ¼å¼<br>
      â€¢ æŠ€èƒ½ä¼šåœ¨ agent æ”¶åˆ°ç›¸å…³ä»»åŠ¡æ—¶<b style="color:var(--text)">è‡ªåŠ¨æ¿€æ´»</b>ï¼Œæ— éœ€æ‰‹åŠ¨è§¦å‘
    </div>
    <form onsubmit="submitAddSkill(event,'${esc(agentId)}','${esc(agentLabel)}')" style="display:flex;flex-direction:column;gap:14px">
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px">æŠ€èƒ½åç§° <span style="color:#ff5270">*</span></label>
        <input id="ask-name" type="text" required placeholder="å¦‚ data-analysis, code-review, doc-writer"
          pattern="[a-z0-9][a-z0-9\\-]*[a-z0-9]" title="å°å†™è‹±æ–‡+è¿å­—ç¬¦ï¼Œè‡³å°‘2ä¸ªå­—ç¬¦"
          style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--line);border-radius:8px;color:var(--text);font-size:13px;outline:none"
          oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9\\-]/g,'')">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px">æŠ€èƒ½æè¿° <span style="color:var(--muted);font-weight:400">(ä¸€å¥è¯è¯´æ˜ç”¨é€”)</span></label>
        <input id="ask-desc" type="text" placeholder="å¦‚ï¼šè´Ÿè´£ä»£ç å®¡æŸ¥ä¸è´¨é‡æ£€æµ‹ï¼Œå‘ç°æ½œåœ¨Bugå’Œå®‰å…¨é£é™©"
          style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--line);border-radius:8px;color:var(--text);font-size:13px;outline:none">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px">è§¦å‘æ¡ä»¶ <span style="color:var(--muted);font-weight:400">(å¯é€‰ï¼Œä½•æ—¶æ¿€æ´»æ­¤æŠ€èƒ½)</span></label>
        <input id="ask-trigger" type="text" placeholder="å¦‚ï¼šå½“ä»»åŠ¡æ¶‰åŠä»£ç è´¨é‡ã€å®‰å…¨å®¡æŸ¥æ—¶æ¿€æ´»"
          style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--line);border-radius:8px;color:var(--text);font-size:13px;outline:none">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:4px">
        <button type="button" class="btn btn-g" onclick="closeModal()" style="padding:8px 20px;font-size:13px">å–æ¶ˆ</button>
        <button type="submit" id="ask-submit" class="btn" style="padding:8px 20px;font-size:13px;background:var(--acc);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600">ğŸ“¦ åˆ›å»ºæŠ€èƒ½</button>
      </div>
    </form>`;
  document.getElementById('modal-bg').classList.add('open');
  document.getElementById('ask-name').focus();
}

async function submitAddSkill(e, agentId, agentLabel){
  e.preventDefault();
  const name = document.getElementById('ask-name').value.trim();
  const desc = document.getElementById('ask-desc').value.trim();
  const trigger = document.getElementById('ask-trigger').value.trim();
  if(!name) return;
  const btn = document.getElementById('ask-submit');
  btn.disabled=true; btn.textContent='âŸ³ åˆ›å»ºä¸­â€¦';
  try{
    const r = await postJ(API+'/add-skill', {agentId, skillName:name, description:desc, trigger:trigger});
    if(r.ok){
      toast(`âœ… æŠ€èƒ½ ${name} å·²æ·»åŠ åˆ° ${agentLabel}`, 'ok');
      closeModal();
      loadAgentConfig();
    } else { toast(r.error||'æ·»åŠ å¤±è´¥','err'); btn.disabled=false; btn.textContent='ğŸ“¦ åˆ›å»ºæŠ€èƒ½'; }
  }catch(e){ toast('æœåŠ¡å™¨è¿æ¥å¤±è´¥','err'); btn.disabled=false; btn.textContent='ğŸ“¦ åˆ›å»ºæŠ€èƒ½'; }
}

/* â•â• DATA LOADING â•â• */
async function loadLive(){
  try{
    liveStatus=await fetchJ(API+'/live-status');
    const tasks=liveStatus.tasks||[];
    const sync=liveStatus.syncStatus||{};
    const cs=document.getElementById('chip-sync');
    cs.textContent=sync.ok?'âœ… åŒæ­¥æ­£å¸¸':'âš ï¸ åŒæ­¥å¼‚å¸¸';
    cs.className='chip '+(sync.ok?'ok':'warn');
    renderEdicts(tasks);
    renderMonitor(tasks);
    renderSessions(tasks);
  }catch(e){
    document.getElementById('chip-sync').textContent='âŒ æœåŠ¡å™¨æœªå¯åŠ¨';
    document.getElementById('chip-sync').className='chip err';
  }
}
async function loadAgentConfig(){
  try{
    agentConfig=await fetchJ(API+'/agent-config');
    renderModels(agentConfig);
    renderSkills(agentConfig);
    const log=await fetchJ(API+'/model-change-log').catch(()=>[]);
    renderCL(log);
  }catch(e){
    document.getElementById('model-grid').innerHTML='<div class="empty" style="grid-column:1/-1">âš ï¸ è¯·å…ˆå¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼š<code>python3 dashboard/server.py</code></div>';
  }
}
async function loadAll(){
  await loadLive();
  if(['models','skills'].includes(activeTab))await loadAgentConfig();
  if(activeTab==='sessions')renderSessions(liveStatus?liveStatus.tasks:[]);
  if(activeTab==='memorials')renderMemorials();
  if(activeTab==='templates')renderTemplates();
}

/* â•â• SESSIONS / å°ä»»åŠ¡ â•â• */
const AGENT_EMOJI_MAP = {};
const AGENT_LABEL_MAP = {};
let sessFilter = 'all';

// isEdict already defined above

/* ä» title å’Œ sourceMeta ä¸­æå–äººç±»å¯è¯»åç§° */
function humanTitle(t){
  let title = t.title||'';
  // "è¤šå‡¤å¤© ä¼šè¯" â†’ ok, keep
  // "agent:shangshu:main ä¼šè¯" â†’ "å°šä¹¦çœ ä¸»ä¼šè¯"
  // "agent:gongbu:subagent:xxx ä¼šè¯" â†’ "å·¥éƒ¨ å­ä»»åŠ¡"
  // "agent:shangshu:cron:xxx ä¼šè¯" â†’ "å°šä¹¦çœ å®šæ—¶ä»»åŠ¡"
  // "heartbeat ä¼šè¯" â†’ "å¿ƒè·³æ£€æµ‹"
  if(title==='heartbeat ä¼šè¯') return 'ğŸ’“ å¿ƒè·³æ£€æµ‹';
  const m = title.match(/^agent:(\w+):(\w+)/);
  if(m){
    const agLabel = AGENT_LABEL_MAP[m[1]] || m[1];
    if(m[2]==='main') return agLabel+' Â· ä¸»ä¼šè¯';
    if(m[2]==='subagent') return agLabel+' Â· å­ä»»åŠ¡æ‰§è¡Œ';
    if(m[2]==='cron') return agLabel+' Â· å®šæ—¶ä»»åŠ¡';
    return agLabel+' Â· '+m[2];
  }
  // "å…µéƒ¨ï¼šMission Control æ˜ å°„éªŒæ”¶" â€” already nice
  return title.replace(/ ä¼šè¯$/, '') || t.id;
}

/* æå–æ¥æºæ¸ é“ */
function channelLabel(t){
  const now = t.now||'';
  if(now.includes('feishu/direct')) return {icon:'ğŸ’¬', text:'é£ä¹¦å¯¹è¯'};
  if(now.includes('feishu'))        return {icon:'ğŸ’¬', text:'é£ä¹¦'};
  if(now.includes('webchat'))       return {icon:'ğŸŒ', text:'WebChat'};
  if(now.includes('cron'))          return {icon:'â°', text:'å®šæ—¶'};
  if(now.includes('direct'))        return {icon:'ğŸ“¨', text:'ç›´è¿'};
  return {icon:'ğŸ”—', text:'ä¼šè¯'};
}

/* æå–æœ€åä¸€æ¡æœ‰æ„ä¹‰çš„ assistant æ¶ˆæ¯ */
function lastMessage(t){
  const acts = t.activity||[];
  for(let i=acts.length-1;i>=0;i--){
    const a=acts[i];
    if(a.kind==='assistant'){
      let txt = a.text||'';
      if(txt.startsWith('NO_REPLY')) continue;
      if(txt.startsWith('Reasoning:')) continue;
      // æ¸…ç† markdown å’Œ [[reply_to_current]]
      txt = txt.replace(/\[\[.*?\]\]/g,'').replace(/\*\*/g,'').replace(/^#+\s/gm,'').trim();
      return txt.substring(0,120) + (txt.length>120?'â€¦':'');
    }
  }
  return '';
}

function renderSessions(tasks){
  if(!tasks) tasks=[];
  // build agent maps from agentConfig if available
  if(agentConfig && agentConfig.agents){
    agentConfig.agents.forEach(a=>{
      AGENT_EMOJI_MAP[a.id] = a.emoji||'ğŸ›ï¸';
      AGENT_LABEL_MAP[a.id] = a.label||a.id;
    });
  }
  const sessions = tasks.filter(t=>!isEdict(t));
  document.getElementById('tb-s').textContent = sessions.length;
  // apply filter
  let filtered = sessions;
  if(sessFilter === 'active') filtered = sessions.filter(t=>!['Done','Cancelled'].includes(t.state));
  else if(sessFilter !== 'all') filtered = sessions.filter(t=>extractAgent(t) === sessFilter);

  const grid = document.getElementById('sess-grid');
  if(!filtered.length){
    grid.innerHTML = '<div style="font-size:13px;color:var(--muted);padding:24px;text-align:center;grid-column:1/-1">æš‚æ— å°ä»»åŠ¡/ä¼šè¯æ•°æ®</div>';
    return;
  }

  grid.innerHTML = filtered.map(t=>{
    const agent = extractAgent(t);
    const emoji = AGENT_EMOJI_MAP[agent] || 'ğŸ›ï¸';
    const agLabel = AGENT_LABEL_MAP[agent] || t.org || agent;
    const hb = t.heartbeat||{};
    const sm = t.sourceMeta||{};
    const ch = channelLabel(t);
    const title = humanTitle(t);
    const msg = lastMessage(t);
    const totalTk = sm.totalTokens||0;
    const updatedAt = t.eta||''; // eta is actually the last update time in our data
    const hbDot = hb.status==='active'?'ğŸŸ¢':hb.status==='warn'?'ğŸŸ¡':hb.status==='stalled'?'ğŸ”´':'âšª';
    const hbText = hb.label ? hb.label.replace(/^[ğŸŸ¢ğŸŸ¡ğŸ”´âšª]\s*/,'') : 'æœªçŸ¥';
    const model = (t.now||'').match(/æ¨¡å‹\s*(\S+)/);
    const modelStr = model ? model[1] : '';
    const st = t.state||'Unknown';

    return `<div class="sess-card" onclick="openSessionDetail(${JSON.stringify(JSON.stringify(t))})">
      <div class="sc-top">
        <span class="sc-emoji">${emoji}</span>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:6px">
            <span class="sc-agent">${esc(agLabel)}</span>
            <span style="font-size:10px;color:var(--muted);background:var(--panel2);padding:2px 6px;border-radius:4px">${ch.icon} ${ch.text}</span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <span title="${esc(hbText)}">${hbDot}</span>
          <span class="tag st-${st}" style="font-size:10px">${STATE_LABEL[st]||st}</span>
        </div>
      </div>
      <div class="sc-title">${esc(title)}</div>
      ${msg?`<div style="font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:8px;border-left:2px solid var(--line);padding-left:8px;max-height:40px;overflow:hidden">${esc(msg)}</div>`:''}
      <div class="sc-meta">
        ${modelStr?`<span style="font-size:10px;color:var(--acc);font-weight:600">${esc(modelStr)}</span>`:''}
        ${totalTk?`<span style="font-size:10px;color:var(--muted)">ğŸª™ ${totalTk.toLocaleString()} tokens</span>`:''}
        ${updatedAt?`<span class="sc-time">${timeAgo(updatedAt)}</span>`:''}
      </div>
    </div>`;
  }).join('');
}

/* ä¼šè¯è¯¦æƒ…å¼¹çª— */
function openSessionDetail(jsonStr){
  const t = JSON.parse(jsonStr);
  const agent = extractAgent(t);
  const agLabel = AGENT_LABEL_MAP[agent] || t.org || agent;
  const emoji = AGENT_EMOJI_MAP[agent] || 'ğŸ›ï¸';
  const title = humanTitle(t);
  const ch = channelLabel(t);
  const hb = t.heartbeat||{};
  const sm = t.sourceMeta||{};
  const acts = t.activity||[];
  const model = (t.now||'').match(/æ¨¡å‹\s*(\S+)/);
  const st = t.state||'Unknown';

  document.getElementById('modal-body').innerHTML=`
    <div style="font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:4px">${esc(t.id)}</div>
    <div style="font-size:20px;font-weight:800;margin-bottom:6px">${emoji} ${esc(title)}</div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px;flex-wrap:wrap">
      <span class="tag st-${st}">${STATE_LABEL[st]||st}</span>
      <span style="font-size:11px;color:var(--muted)">${ch.icon} ${ch.text}</span>
      <span style="font-size:11px;color:var(--muted)">${esc(agLabel)}</span>
      ${model?`<span style="font-size:11px;color:var(--acc)">${esc(model[1])}</span>`:''}
      ${hb.label?`<span style="font-size:11px">${esc(hb.label)}</span>`:''}
    </div>

    <!-- ç»Ÿè®¡ -->
    <div style="display:flex;gap:14px;margin-bottom:18px;flex-wrap:wrap">
      ${sm.totalTokens?`<div style="background:var(--panel2);padding:10px 16px;border-radius:8px;font-size:12px"><div style="font-size:16px;font-weight:700;color:var(--acc)">${sm.totalTokens.toLocaleString()}</div><div style="color:var(--muted);font-size:10px">æ€» Tokens</div></div>`:''}
      ${sm.inputTokens!=null?`<div style="background:var(--panel2);padding:10px 16px;border-radius:8px;font-size:12px"><div style="font-size:16px;font-weight:700">${(sm.inputTokens||0).toLocaleString()}</div><div style="color:var(--muted);font-size:10px">è¾“å…¥</div></div>`:''}
      ${sm.outputTokens!=null?`<div style="background:var(--panel2);padding:10px 16px;border-radius:8px;font-size:12px"><div style="font-size:16px;font-weight:700">${(sm.outputTokens||0).toLocaleString()}</div><div style="color:var(--muted);font-size:10px">è¾“å‡º</div></div>`:''}
    </div>

    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <div style="font-size:12px;font-weight:700;margin-bottom:8px;color:var(--text)">ğŸ“‹ æœ€è¿‘æ´»åŠ¨ <span style="font-weight:400;color:var(--muted)">(${acts.length} æ¡)</span></div>
    <div style="max-height:350px;overflow-y:auto;border:1px solid var(--line);border-radius:10px;background:var(--panel2)">
      ${!acts.length?'<div style="padding:16px;color:var(--muted);font-size:12px;text-align:center">æš‚æ— æ´»åŠ¨è®°å½•</div>'
       :acts.slice(-15).reverse().map(a=>{
        const kind = a.kind||'';
        const kIcon = kind==='assistant'?'ğŸ¤–':kind==='tool'?'ğŸ”§':kind==='user'?'ğŸ‘¤':'ğŸ“';
        const kLabel = kind==='assistant'?'å›å¤':kind==='tool'?'å·¥å…·':kind==='user'?'ç”¨æˆ·':'äº‹ä»¶';
        let txt = (a.text||'').replace(/\[\[.*?\]\]/g,'').replace(/\*\*/g,'').trim();
        if(txt.length>200) txt=txt.substring(0,200)+'â€¦';
        const time = (a.at||'').substring(11,19);
        return `<div style="padding:8px 12px;border-bottom:1px solid var(--line);font-size:12px;line-height:1.5">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
            <span>${kIcon}</span>
            <span style="font-weight:600;font-size:11px">${kLabel}</span>
            <span style="color:var(--muted);font-size:10px;margin-left:auto">${time}</span>
          </div>
          <div style="color:var(--muted)">${esc(txt)}</div>
        </div>`;
      }).join('')}
    </div>

    ${t.output&&t.output!=='-'?`<div style="font-size:10px;color:var(--muted);margin-top:12px;word-break:break-all;border-top:1px solid var(--line);padding-top:8px">ğŸ“‚ ${esc(t.output)}</div>`:''}
  `;
  document.getElementById('modal-bg').classList.add('open');
}

function extractAgent(t){
  const m = (t.id||'').match(/^OC-(\w+)-/);
  if(m) return m[1];
  // MC-* or other prefixes: check sourceMeta
  const sm = t.sourceMeta||{};
  if(sm.agentId){
    // "mc-gateway-xxx" â†’ try to match known agents
    const known = ['zhongshu','menxia','shangshu','hubu','libu','bingbu','xingbu','gongbu','zaochao'];
    for(const k of known){ if(sm.agentId.includes(k)) return k; }
  }
  return (t.org||'').replace(/çœ|éƒ¨/g,'').toLowerCase();
}

function timeAgo(iso){
  if(!iso) return '';
  try{
    const d = new Date(iso.includes('T')?iso:iso.replace(' ','T')+'Z');
    if(isNaN(d.getTime())) return '';
    const diff = Date.now() - d.getTime();
    const mins = Math.floor(diff/60000);
    if(mins<0) return 'åˆšåˆš';
    if(mins<1) return 'åˆšåˆš';
    if(mins<60) return mins+'åˆ†é’Ÿå‰';
    const hrs = Math.floor(mins/60);
    if(hrs<24) return hrs+'å°æ—¶å‰';
    return Math.floor(hrs/24)+'å¤©å‰';
  }catch(e){ return ''; }
}

function filterSessions(filter, el){
  sessFilter = filter;
  document.querySelectorAll('.sess-filter').forEach(x=>x.classList.remove('active'));
  if(el) el.classList.add('active');
  renderSessions(liveStatus?liveStatus.tasks:[]);
}

/* â•â• MORNING BRIEF (å¤©ä¸‹è¦é—») â•â• */
const CAT_META = {
  'æ”¿æ²»': {icon:'ğŸ›ï¸', color:'#6a9eff', desc:'å…¨çƒæ”¿æ²»åŠ¨æ€'},
  'å†›äº‹': {icon:'âš”ï¸',  color:'#ff5270', desc:'å†›äº‹ä¸å†²çª'},
  'ç»æµ': {icon:'ğŸ’¹',  color:'#2ecc8a', desc:'ç»æµä¸å¸‚åœº'},
  'AIå¤§æ¨¡å‹': {icon:'ğŸ¤–', color:'#a07aff', desc:'AIä¸å¤§æ¨¡å‹è¿›å±•'},
};
const DEFAULT_CATS = ['æ”¿æ²»','å†›äº‹','ç»æµ','AIå¤§æ¨¡å‹'];

// --- Subscription config ---
let subConfig = null;

async function loadSubConfig(){
  try{ subConfig = await fetchJ(API+'/morning-config'); }
  catch(e){ subConfig = { categories: DEFAULT_CATS.map(c=>({name:c,enabled:true})), keywords:[], custom_feeds:[], feishu_webhook:'' }; }
}

function renderSubConfig(){
  if(!subConfig) return;
  // Categories
  const catsEl = document.getElementById('sub-cats');
  const allCats = [...DEFAULT_CATS];
  (subConfig.categories||[]).forEach(c=>{ if(!allCats.includes(c.name)) allCats.push(c.name); });
  const enabledSet = new Set((subConfig.categories||[]).filter(c=>c.enabled).map(c=>c.name));
  catsEl.innerHTML = allCats.map(cat=>{
    const meta=CAT_META[cat]||{icon:'ğŸ“°',color:'var(--acc)',desc:cat};
    const on=enabledSet.has(cat);
    return `<div class="sub-cat ${on?'active':''}" onclick="toggleCat('${esc(cat)}')">
      <div class="sc-check">${on?'âœ“':''}</div>
      <span style="font-size:16px">${meta.icon}</span>
      <div><div class="sc-label">${esc(cat)}</div><div class="sc-count">${meta.desc}</div></div>
    </div>`;
  }).join('');
  // Keywords
  const kwEl = document.getElementById('sub-keywords');
  kwEl.innerHTML = (subConfig.keywords||[]).map((kw,i)=>`<span class="sub-kw">${esc(kw)}<span class="kw-del" onclick="removeKeyword(${i})">âœ•</span></span>`).join('');
  // Custom feeds
  const feedEl = document.getElementById('sub-feeds');
  feedEl.innerHTML = (subConfig.custom_feeds||[]).length
    ? (subConfig.custom_feeds||[]).map((f,i)=>`<div class="sub-feed">
        <span class="sf-name">${esc(f.name)}</span>
        <span class="sf-url" title="${esc(f.url)}">${esc(f.url)}</span>
        <span class="sf-cat">${esc(f.category)}</span>
        <span class="sf-del" onclick="removeFeed(${i})">âœ•</span>
      </div>`).join('')
    : '<div style="font-size:12px;color:var(--muted);padding:4px 0">æš‚æ— è‡ªå®šä¹‰æº</div>';
  // Feed category dropdown
  const sel = document.getElementById('new-feed-cat');
  sel.innerHTML = allCats.map(c=>`<option value="${c}">${c}</option>`).join('') + '<option value="__new__">+ æ–°åˆ†ç±»â€¦</option>';
  // Feishu webhook
  document.getElementById('feishu-webhook').value = subConfig.feishu_webhook||'';
}

function toggleSubConfig(){
  const el = document.getElementById('sub-config');
  if(el.style.display==='none'){
    el.style.display='block';
    loadSubConfig().then(()=>renderSubConfig());
  } else {
    el.style.display='none';
  }
}

function toggleCat(name){
  if(!subConfig) return;
  const cats = subConfig.categories||[];
  const existing = cats.find(c=>c.name===name);
  if(existing) existing.enabled = !existing.enabled;
  else cats.push({name, enabled:true});
  subConfig.categories = cats;
  renderSubConfig();
}

function addKeyword(){
  const inp = document.getElementById('new-kw');
  const kw = inp.value.trim();
  if(!kw) return;
  if(!subConfig.keywords) subConfig.keywords=[];
  if(!subConfig.keywords.includes(kw)) subConfig.keywords.push(kw);
  inp.value = '';
  renderSubConfig();
}

function removeKeyword(i){
  if(!subConfig||!subConfig.keywords) return;
  subConfig.keywords.splice(i,1);
  renderSubConfig();
}

function addFeed(){
  const name=document.getElementById('new-feed-name').value.trim();
  const url=document.getElementById('new-feed-url').value.trim();
  let cat=document.getElementById('new-feed-cat').value;
  if(!name||!url){toast('è¯·å¡«å†™æºåç§°å’ŒURL','err');return}
  if(cat==='__new__'){
    const nc=prompt('è¾“å…¥æ–°åˆ†ç±»åç§°ï¼š');
    if(!nc) return;
    cat=nc;
    // ensure category exists
    if(!subConfig.categories) subConfig.categories=[];
    if(!subConfig.categories.find(c=>c.name===cat)) subConfig.categories.push({name:cat,enabled:true});
  }
  if(!subConfig.custom_feeds) subConfig.custom_feeds=[];
  subConfig.custom_feeds.push({name,url,category:cat});
  document.getElementById('new-feed-name').value='';
  document.getElementById('new-feed-url').value='';
  renderSubConfig();
}

function removeFeed(i){
  if(!subConfig||!subConfig.custom_feeds) return;
  subConfig.custom_feeds.splice(i,1);
  renderSubConfig();
}

async function saveSubConfig(){
  subConfig.feishu_webhook = document.getElementById('feishu-webhook').value.trim();
  const st = document.getElementById('sub-status');
  st.style.display='block'; st.style.color='var(--acc)'; st.textContent='âŸ³ ä¿å­˜ä¸­â€¦';
  try{
    const r = await postJ(API+'/morning-config', subConfig);
    if(r.ok){ st.style.color='var(--ok)'; st.textContent='âœ… é…ç½®å·²ä¿å­˜'; toast('è®¢é˜…é…ç½®å·²ä¿å­˜','ok'); }
    else{ st.style.color='var(--danger)'; st.textContent='âŒ '+(r.error||'ä¿å­˜å¤±è´¥'); }
  }catch(e){ st.style.color='var(--danger)'; st.textContent='âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥'; }
  setTimeout(()=>st.style.display='none', 3000);
}

// --- News rendering ---
async function loadMorning(){
  const body = document.getElementById('mb-body');
  body.innerHTML = '<div class="mb-loading">âŸ³ åŠ è½½è¦é—»ä¸­â€¦</div>';
  try{
    const d = await fetchJ(API+'/morning-brief');
    await loadSubConfig();
    renderMorning(d);
  }catch(e){
    body.innerHTML = '<div class="mb-empty">âš ï¸ æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ã€Œç«‹å³é‡‡é›†ã€</div>';
  }
}

function renderMorning(d){
  const sub = document.getElementById('mb-subtitle');
  if(d.generated_at){
    const dateStr = d.date ? d.date.replace(/(\d{4})(\d{2})(\d{2})/,'$1å¹´$2æœˆ$3æ—¥') : '';
    sub.textContent = `${dateStr} | é‡‡é›†äº ${d.generated_at} | å…± ${Object.values(d.categories||{}).flat().length} æ¡è¦é—»`;
  }
  const body = document.getElementById('mb-body');
  const cats = d.categories||{};
  if(!Object.keys(cats).length){
    body.innerHTML='<div class="mb-empty">æš‚æ— æ•°æ®ï¼Œç‚¹å‡»å³ä¸Šè§’ã€Œç«‹å³é‡‡é›†ã€è·å–ä»Šæ—¥ç®€æŠ¥</div>';
    return;
  }
  // Filter by enabled categories
  const enabledSet = subConfig ? new Set((subConfig.categories||[]).filter(c=>c.enabled).map(c=>c.name)) : null;
  const userKws = (subConfig && subConfig.keywords||[]).map(k=>k.toLowerCase());

  body.innerHTML = `<div class="mb-cats">
    ${Object.entries(cats).map(([cat, items])=>{
      if(enabledSet && !enabledSet.has(cat)) return '';
      const meta = CAT_META[cat]||{icon:'ğŸ“°',color:'var(--acc)'};
      // Boost items matching user keywords
      const scored = items.map(item=>{
        const text = ((item.title||'')+(item.summary||'')).toLowerCase();
        const kwHits = userKws.filter(k=>text.includes(k)).length;
        return {...item, _kwHits: kwHits};
      }).sort((a,b)=>b._kwHits-a._kwHits);
      return `<div class="mb-cat">
        <div class="mb-cat-hdr">
          <span class="mb-cat-icon">${meta.icon}</span>
          <span class="mb-cat-name" style="color:${meta.color}">${esc(cat)}</span>
          <span class="mb-cat-cnt">${scored.length} æ¡</span>
        </div>
        <div class="mb-news-list">
          ${!scored.length ? '<div class="mb-empty" style="padding:16px">æš‚æ— æ–°é—»</div>' :
            scored.map(item => {
              const hasImg = item.image && item.image.startsWith('http');
              const kwBadge = item._kwHits ? `<span style="font-size:9px;padding:1px 5px;border-radius:999px;background:#a07aff22;color:#a07aff;border:1px solid #a07aff44;margin-left:4px">â­ å…³æ³¨</span>` : '';
              return `<div class="mb-card" onclick="window.open('${esc(item.link)}','_blank')">
                <div class="mb-img">
                  ${hasImg
                    ? `<img src="${esc(item.image)}" onerror="this.parentElement.textContent='${meta.icon}'" loading="lazy">`
                    : `<span>${meta.icon}</span>`}
                </div>
                <div class="mb-info">
                  <div class="mb-headline">${esc(item.title)}${kwBadge}</div>
                  <div class="mb-summary">${esc(item.summary||item.desc||'')}</div>
                  <div class="mb-meta">
                    <span class="mb-source">ğŸ“¡ ${esc(item.source||'')}</span>
                    ${item.pub_date ? `<span class="mb-time">${esc(item.pub_date.substring(0,16))}</span>` : ''}
                  </div>
                </div>
              </div>`;
            }).join('')}
        </div>
      </div>`;
    }).join('')}
  </div>`;
}

async function refreshNews(){
  const btn = document.getElementById('mb-refresh-btn');
  btn.disabled = true; btn.textContent = 'âŸ³ é‡‡é›†ä¸­â€¦';
  try{
    const r = await postJ(API+'/morning-brief/refresh', {});
    toast(r.message||'é‡‡é›†å·²è§¦å‘', 'ok', 5000);
    setTimeout(()=>loadMorning(), 45000);
  }catch(e){
    toast('è§¦å‘å¤±è´¥', 'err');
  }
  setTimeout(()=>{btn.disabled=false; btn.textContent='âŸ³ ç«‹å³é‡‡é›†';}, 5000);
}

/* â•â• OFFICIALS â•â• */
let officialsData = null;
let selectedOfficial = null;

async function loadOfficials(){
  try{
    officialsData = await fetchJ(API+'/officials-stats');
    renderOfficials(officialsData);
  }catch(e){
    document.getElementById('off-detail').innerHTML='<div class="od-empty">âš ï¸ æ— æ³•åŠ è½½ï¼Œè¯·ç¡®è®¤æœåŠ¡å™¨å·²å¯åŠ¨</div>';
  }
}

const MEDALS = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

function renderOfficials(data){
  if(!data||!data.officials) return;
  const offs = data.officials;
  const totals = data.totals||{};
  const maxTk = Math.max(...offs.map(o=>o.tokens_in+o.tokens_out+o.cache_read+o.cache_write),1);

  // æ´»è·ƒæç¤ºæ¡
  const alive = offs.filter(o=>(o.heartbeat||{}).status==='active');
  const actEl = document.getElementById('off-activity');
  if(alive.length){
    actEl.style.display='flex';
    actEl.innerHTML=`<span class="act-label">ğŸŸ¢ å½“å‰æ´»è·ƒï¼š</span>`
      +alive.map(o=>`<span class="act-dot alive">${o.emoji} ${o.role}</span>`).join('')
      +`<span style="color:var(--muted);font-size:11px;margin-left:auto">å…¶ä½™å®˜å‘˜å¾…å‘½</span>`;
  }

  // KPI è¡Œ
  document.getElementById('off-kpi').innerHTML=`
    <div class="kpi"><div class="kpi-v blue">${offs.length}</div><div class="kpi-l">åœ¨èŒå®˜å‘˜</div></div>
    <div class="kpi"><div class="kpi-v gold">${totals.tasks_done||0}</div><div class="kpi-l">ç´¯è®¡å®Œæˆæ—¨æ„</div></div>
    <div class="kpi"><div class="kpi-v ${(totals.cost_cny||0)>20?'warn':'green'}">Â¥${totals.cost_cny||0}</div><div class="kpi-l">ç´¯è®¡è´¹ç”¨ï¼ˆå«ç¼“å­˜ï¼‰</div></div>
    <div class="kpi"><div class="kpi-v" style="font-size:16px;padding-top:4px">${esc(data.top_official||'â€”')}</div><div class="kpi-l">åŠŸç»©æœ€é«˜</div></div>`;

  // å·¦ä¾§æ’è¡Œæ¦œ
  document.getElementById('off-ranklist').innerHTML=`
    <div class="orl-hdr">åŠŸç»©æ’è¡Œ</div>`
    +offs.map(o=>{
      const hb=o.heartbeat||{status:'idle'};
      return `<div class="orl-item${selectedOfficial===o.id?' selected':''}" onclick="selectOfficial('${o.id}',this)">
        <span class="orl-medal">${o.merit_rank<=3?MEDALS[o.merit_rank-1]:'#'+o.merit_rank}</span>
        <span class="orl-emoji">${o.emoji}</span>
        <span class="orl-name"><div class="orl-role">${esc(o.role)}</div><div class="orl-org">${esc(o.label)}</div></span>
        <span class="orl-score">${o.merit_score}åˆ†</span>
        <span class="orl-hbdot ${hb.status}"></span>
      </div>`;
    }).join('');

  // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
  if(!selectedOfficial && offs.length) selectOfficial(offs[0].id);
}

function selectOfficial(id, el){
  selectedOfficial = id;
  // é«˜äº®è¡Œ
  document.querySelectorAll('.orl-item').forEach(x=>x.classList.remove('selected'));
  if(el) el.classList.add('selected');
  // æ¸²æŸ“è¯¦æƒ…
  if(!officialsData) return;
  const o = officialsData.officials.find(x=>x.id===id);
  if(!o) return;
  const hb = o.heartbeat||{status:'idle',label:'âšª å¾…å‘½'};
  const totTk = o.tokens_in+o.tokens_out+o.cache_read+o.cache_write;
  const maxTk = Math.max(...officialsData.officials.map(x=>x.tokens_in+x.tokens_out+x.cache_read+x.cache_write),1);
  const costCls = o.cost_cny>10?'hi':o.cost_cny>3?'md':'lo';
  const edicts = o.participated_edicts||[];

  const tkBars = [
    {l:'è¾“å…¥', v:o.tokens_in,   color:'#6a9eff', max:maxTk},
    {l:'è¾“å‡º', v:o.tokens_out,  color:'#a07aff', max:maxTk},
    {l:'ç¼“å­˜è¯»', v:o.cache_read, color:'#2ecc8a', max:maxTk},
    {l:'ç¼“å­˜å†™', v:o.cache_write,color:'#f5c842', max:maxTk},
  ];

  document.getElementById('off-detail').innerHTML=`
    <!-- hero -->
    <div class="od-hero">
      <div class="od-emoji">${o.emoji}</div>
      <div>
        <div class="od-name">${esc(o.role)}</div>
        <div class="od-role">${esc(o.label)} Â· <span style="color:var(--acc)">${esc(o.model_short||o.model)}</span></div>
        <div class="od-rank-badge">ğŸ… ${esc(o.rank)} Â· åŠŸç»©åˆ† ${o.merit_score}</div>
      </div>
      <div class="od-hb">
        <div class="hb ${hb.status}" style="margin-bottom:4px">${esc(hb.label)}</div>
        ${o.last_active?`<div style="font-size:10px;color:var(--muted)">æ´»è·ƒ ${esc(o.last_active)}</div>`:''}
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${o.sessions} ä¸ªä¼šè¯ Â· ${o.messages} æ¡æ¶ˆæ¯</div>
      </div>
    </div>

    <!-- æ ¸å¿ƒåŠŸç»© -->
    <div class="od-section">
      <div class="od-sec-title">åŠŸç»©ç»Ÿè®¡</div>
      <div class="od-stats">
        <div class="ods"><div class="ods-v" style="color:var(--ok)">${o.tasks_done}</div><div class="ods-l">å®Œæˆæ—¨æ„</div></div>
        <div class="ods"><div class="ods-v" style="color:var(--warn)">${o.tasks_active}</div><div class="ods-l">æ‰§è¡Œä¸­</div></div>
        <div class="ods"><div class="ods-v" style="color:var(--acc)">${o.flow_participations}</div><div class="ods-l">æµè½¬å‚ä¸</div></div>
      </div>
    </div>

    <!-- Token æ¶ˆè€— -->
    <div class="od-section">
      <div class="od-sec-title">Token æ¶ˆè€—</div>
      ${tkBars.map(b=>`
      <div class="tbar">
        <div class="tbar-hdr"><span class="tbar-label">${b.l}</span><span class="tbar-val">${b.v.toLocaleString()}</span></div>
        <div class="tbar-track"><div class="tbar-fill" style="width:${b.max>0?Math.round(b.v/b.max*100):0}%;background:${b.color}"></div></div>
      </div>`).join('')}
    </div>

    <!-- è´¹ç”¨ -->
    <div class="od-section">
      <div class="od-sec-title">ç´¯è®¡è´¹ç”¨</div>
      <div class="od-cost-row">
        <div class="cost-chip ${costCls}"><b>Â¥${o.cost_cny}</b> äººæ°‘å¸</div>
        <div class="cost-chip ${costCls}"><b>$${o.cost_usd}</b> ç¾å…ƒ</div>
        <div class="cost-chip" style="font-size:11px;color:var(--muted)">æ€»è®¡ ${totTk.toLocaleString()} tokensï¼ˆå«ç¼“å­˜ï¼‰</div>
      </div>
    </div>

    <!-- å‚ä¸æ—¨æ„ -->
    <div class="od-section">
      <div class="od-sec-title">å‚ä¸æ—¨æ„ï¼ˆ${edicts.length} é“ï¼‰</div>
      ${!edicts.length
        ? '<div style="font-size:12px;color:var(--muted);padding:8px 0">æš‚æ— æ—¨æ„è®°å½•</div>'
        : `<div class="od-edict-list">${edicts.map(e=>`
          <div class="oe-item" onclick='openTask(${JSON.stringify(e.id)})'>
            <span class="oe-id">${esc(e.id)}</span>
            <span class="oe-title">${esc(e.title.substring(0,35))}</span>
            <span class="tag st-${e.state} oe-state">${STATE_LABEL[e.state]||e.state}</span>
          </div>`).join('')}</div>`}
    </div>`;
}

/* â•â• TASK ACTIONS â•â• */
let _confirmCb = null;
function confirmAction(taskId, action){
  const titles = {stop:'â¸ å«åœä»»åŠ¡', cancel:'ğŸš« å–æ¶ˆä»»åŠ¡'};
  const msgs = {stop:`ç¡®å®šè¦å«åœ <b>${esc(taskId)}</b> å—ï¼Ÿä»»åŠ¡å°†æš‚åœï¼Œå¯ç¨åæ¢å¤ã€‚`, cancel:`ç¡®å®šè¦å–æ¶ˆ <b>${esc(taskId)}</b> å—ï¼Ÿä»»åŠ¡å°†æ ‡è®°ä¸ºå·²å–æ¶ˆã€‚`};
  document.getElementById('confirm-title').innerHTML = titles[action]||action;
  document.getElementById('confirm-msg').innerHTML = msgs[action]||'';
  document.getElementById('confirm-reason').value = '';
  document.getElementById('confirm-ok').className = action==='cancel'?'btn btn-action btn-cancel':'btn btn-action btn-stop';
  document.getElementById('confirm-ok').textContent = action==='cancel'?'ç¡®è®¤å–æ¶ˆ':'ç¡®è®¤å«åœ';
  document.getElementById('confirm-bg').classList.add('open');
  _confirmCb = () => {
    const reason = document.getElementById('confirm-reason').value.trim();
    taskAction(taskId, action, reason);
  };
}
function closeConfirm(){ document.getElementById('confirm-bg').classList.remove('open'); _confirmCb=null; }
function doConfirm(){ if(_confirmCb) _confirmCb(); closeConfirm(); }

async function taskAction(taskId, action, reason){
  try{
    const r = await postJ(API+'/task-action', {taskId, action, reason: reason||''});
    if(r.ok){ toast(r.message,'ok'); loadAll(); /* close modal if open */ document.getElementById('modal-bg').classList.remove('open'); }
    else toast(r.error||'æ“ä½œå¤±è´¥','err');
  }catch(e){ toast('æœåŠ¡å™¨è¿æ¥å¤±è´¥','err'); }
}

/* â•â• ARCHIVE ACTIONS â•â• */
async function archiveTask(taskId){
  try{
    const r = await postJ(API+'/archive-task', {taskId, archived: true});
    if(r.ok){ toast(`ğŸ“¦ ${taskId} å·²å½’æ¡£`,'ok'); loadAll(); }
    else toast(r.error||'å½’æ¡£å¤±è´¥','err');
  }catch(e){ toast('æœåŠ¡å™¨è¿æ¥å¤±è´¥','err'); }
}
async function unarchiveTask(taskId){
  try{
    const r = await postJ(API+'/archive-task', {taskId, archived: false});
    if(r.ok){ toast(`ğŸ“¤ ${taskId} å·²å–æ¶ˆå½’æ¡£`,'ok'); loadAll(); }
    else toast(r.error||'å–æ¶ˆå½’æ¡£å¤±è´¥','err');
  }catch(e){ toast('æœåŠ¡å™¨è¿æ¥å¤±è´¥','err'); }
}
async function archiveAllDone(){
  if(!confirm('å°†æ‰€æœ‰å·²å®Œæˆ/å·²å–æ¶ˆçš„æ—¨æ„ç§»å…¥å½’æ¡£ï¼Ÿ')) return;
  try{
    const r = await postJ(API+'/archive-task', {archiveAllDone: true});
    if(r.ok){ toast(`ğŸ“¦ ${r.count||0} é“æ—¨æ„å·²å½’æ¡£`,'ok'); loadAll(); }
    else toast(r.error||'æ‰¹é‡å½’æ¡£å¤±è´¥','err');
  }catch(e){ toast('æœåŠ¡å™¨è¿æ¥å¤±è´¥','err'); }
}

/* â•â• TABS â•â• */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');activeTab=t.dataset.tab;
  document.getElementById('panel-'+activeTab).classList.add('active');
  if(['models','skills'].includes(activeTab))loadAgentConfig();
  if(activeTab==='officials')loadOfficials();
  if(activeTab==='morning')loadMorning();
  if(activeTab==='sessions')renderSessions(liveStatus?liveStatus.tasks:[]);
  if(activeTab==='memorials')renderMemorials();
  if(activeTab==='templates')renderTemplates();
}));

/* â•â• COUNTDOWN (5s) â•â• */
function startCd(){
  countdown=5;
  const el=document.getElementById('cd');
  const iv=setInterval(()=>{
    countdown--;el.textContent='âŸ³ '+countdown+'s';
    if(countdown<=0){clearInterval(iv);loadAll().then(()=>{el.textContent='';startCd()})}
  },1000);
}

/* â•â• KEY â•â• */
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.getElementById('modal-bg').classList.remove('open')});

/* â•â• COURT CEREMONY (ä¸Šæœä»ªå¼æ„Ÿ) â•â• */
function showCeremony(){
  const lastOpen = localStorage.getItem('openclaw_court_date');
  const today = new Date().toISOString().substring(0,10);
  const pref = JSON.parse(localStorage.getItem('openclaw_court_pref')||'{"enabled":true}');
  if(!pref.enabled || lastOpen === today) return;
  localStorage.setItem('openclaw_court_date', today);
  const el = document.getElementById('ceremony');
  el.style.display='flex';
  // Fill data from live status
  const tasks = liveStatus ? (liveStatus.tasks||[]) : [];
  const jjc = tasks.filter(t=>(t.id||'').startsWith('JJC-'));
  const pending = jjc.filter(t=>!['Done','Cancelled'].includes(t.state)).length;
  const done = jjc.filter(t=>t.state==='Done').length;
  const overdue = jjc.filter(t=>t.state!=='Done'&&t.state!=='Cancelled'&&t.eta&&new Date(t.eta.replace(' ','T'))<new Date()).length;
  document.getElementById('crm-l3').textContent = `å¾…åŠ ${pending} ä»¶ Â· å·²å®Œæˆ ${done} ä»¶` + (overdue?` Â· âš  è¶…æœŸ ${overdue} ä»¶`:'');
  // Date line
  const d = new Date();
  const dateStr = d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥ Â· '+['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]+'æ›œæ—¥';
  document.getElementById('crm-date').textContent = dateStr;
  // Trigger animations
  document.getElementById('crm-l1').classList.add('in');
  document.getElementById('crm-l2').classList.add('in');
  document.getElementById('crm-l3').classList.add('in');
  document.getElementById('crm-date').classList.add('in');
  // Auto dismiss after 3.5s
  window._crmTimer = setTimeout(()=>skipCeremony(), 3500);
}
function skipCeremony(){
  clearTimeout(window._crmTimer);
  const el = document.getElementById('ceremony');
  el.classList.add('out');
  setTimeout(()=>{el.style.display='none'}, 500);
}

/* â•â• MEMORIALS (å¥æŠ˜ç³»ç»Ÿ) â•â• */
function renderMemorials(){
  const tasks = liveStatus ? (liveStatus.tasks||[]) : [];
  const filter = (document.getElementById('mem-filter')||{}).value || 'all';
  // Only JJC edicts that are Done or Cancelled
  let mems = tasks.filter(t=>(t.id||'').startsWith('JJC-') && ['Done','Cancelled'].includes(t.state));
  if(filter!=='all') mems = mems.filter(t=>t.state===filter);
  document.getElementById('tb-mem').textContent = mems.length;

  const el = document.getElementById('mem-list');
  if(!mems.length){ el.innerHTML='<div class="mem-empty">æš‚æ— å¥æŠ˜ â€” ä»»åŠ¡å®Œæˆåè‡ªåŠ¨ç”Ÿæˆ</div>'; return; }

  el.innerHTML = mems.map(t=>{
    const fl = t.flow_log||[];
    const depts = [...new Set(fl.map(f=>f.from).concat(fl.map(f=>f.to)).filter(x=>x&&x!=='çš‡ä¸Š'))];
    const firstAt = fl.length ? (fl[0].at||'').substring(0,16).replace('T',' ') : '';
    const lastAt = fl.length ? (fl[fl.length-1].at||'').substring(0,16).replace('T',' ') : '';
    const stIcon = t.state==='Done'?'âœ…':'ğŸš«';
    return `<div class="mem-card" onclick='openMemorial(${JSON.stringify(JSON.stringify(t))})'>
      <div class="mem-icon">ğŸ“œ</div>
      <div class="mem-info">
        <div class="mem-title">${stIcon} ${esc(t.title||t.id)}</div>
        <div class="mem-sub">${esc(t.id)} Â· ${esc(t.org||'')} Â· æµè½¬ ${fl.length} æ­¥</div>
        <div class="mem-tags">${depts.slice(0,5).map(d=>`<span class="mem-tag">${esc(d)}</span>`).join('')}</div>
      </div>
      <div class="mem-right">
        <span class="mem-date">${esc(firstAt)}</span>
        ${lastAt!==firstAt?`<span class="mem-date">${esc(lastAt)}</span>`:''}
      </div>
    </div>`;
  }).join('');
}

function openMemorial(jsonStr){
  const t = JSON.parse(jsonStr);
  const fl = t.flow_log||[];
  const st = t.state||'Unknown';
  const stIcon = st==='Done'?'âœ…':st==='Cancelled'?'ğŸš«':'ğŸ”„';
  const depts = [...new Set(fl.map(f=>f.from).concat(fl.map(f=>f.to)).filter(x=>x&&x!=='çš‡ä¸Š'))];

  // Reconstruct phases from flow_log
  let originLog=[], planLog=[], reviewLog=[], execLog=[], resultLog=[];
  for(const f of fl){
    if(f.from==='çš‡ä¸Š') originLog.push(f);
    else if(f.to==='ä¸­ä¹¦çœ'||f.from==='ä¸­ä¹¦çœ') planLog.push(f);
    else if(f.to==='é—¨ä¸‹çœ'||f.from==='é—¨ä¸‹çœ') reviewLog.push(f);
    else if(f.remark&&(f.remark.includes('å®Œæˆ')||f.remark.includes('å›å¥'))) resultLog.push(f);
    else execLog.push(f);
  }

  const renderPhase = (title, icon, items)=>{
    if(!items.length) return '';
    return `<div style="margin-bottom:18px">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">${icon} ${title}</div>
      <div class="md-timeline">${items.map(f=>{
        const dotCls = f.remark&&f.remark.includes('âœ…')?'green':f.remark&&f.remark.includes('é©³')?'red':'';
        return `<div class="md-tl-item">
          <div class="md-tl-dot ${dotCls}"></div>
          <div style="display:flex;gap:6px;align-items:baseline">
            <span class="md-tl-from">${esc(f.from||'')}</span>
            <span class="md-tl-to">â†’ ${esc(f.to||'')}</span>
          </div>
          <div class="md-tl-remark">${esc(f.remark||'')}</div>
          <div class="md-tl-time">${esc((f.at||'').substring(0,19).replace('T',' '))}</div>
        </div>`;
      }).join('')}</div>
    </div>`;
  };

  document.getElementById('modal-body').innerHTML=`
    <div style="font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:4px">${esc(t.id)}</div>
    <div style="font-size:20px;font-weight:800;margin-bottom:6px">${stIcon} ${esc(t.title||t.id)}</div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px;flex-wrap:wrap">
      <span class="tag st-${st}">${STATE_LABEL[st]||st}</span>
      <span style="font-size:11px;color:var(--muted)">${esc(t.org||'')}</span>
      <span style="font-size:11px;color:var(--muted)">æµè½¬ ${fl.length} æ­¥</span>
      ${depts.map(d=>`<span class="mem-tag">${esc(d)}</span>`).join('')}
    </div>

    ${t.now?`<div style="background:var(--panel2);border:1px solid var(--line);border-radius:8px;padding:10px 14px;margin-bottom:18px;font-size:12px;color:var(--muted)">${esc(t.now)}</div>`:''}

    ${renderPhase('åœ£æ—¨åŸæ–‡', 'ğŸ‘‘', originLog)}
    ${renderPhase('ä¸­ä¹¦è§„åˆ’', 'ğŸ“‹', planLog)}
    ${renderPhase('é—¨ä¸‹å®¡è®®', 'ğŸ”', reviewLog)}
    ${renderPhase('å…­éƒ¨æ‰§è¡Œ', 'âš”ï¸', execLog)}
    ${renderPhase('æ±‡æ€»å›å¥', 'ğŸ“¨', resultLog)}

    ${t.output&&t.output!=='-'?`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--line)">
      <div style="font-size:11px;font-weight:600;margin-bottom:4px">ğŸ“¦ äº§å‡ºç‰©</div>
      <code style="font-size:11px;word-break:break-all">${esc(t.output)}</code>
    </div>`:''}

    <div style="display:flex;gap:8px;margin-top:16px;justify-content:flex-end">
      <button class="btn btn-g" onclick="exportMemorial(${JSON.stringify(JSON.stringify(t.id))})" style="font-size:12px;padding:6px 16px">ğŸ“‹ å¤åˆ¶å¥æŠ˜</button>
    </div>
  `;
  document.getElementById('modal-bg').classList.add('open');
}

function exportMemorial(taskIdJson){
  const taskId = JSON.parse(taskIdJson);
  const tasks = liveStatus ? (liveStatus.tasks||[]) : [];
  const t = tasks.find(x=>x.id===taskId);
  if(!t){ toast('æ‰¾ä¸åˆ°ä»»åŠ¡','err'); return; }
  const fl = t.flow_log||[];
  let md = `# ğŸ“œ å¥æŠ˜ Â· ${t.title}\n\n`;
  md += `- **ä»»åŠ¡ç¼–å·**: ${t.id}\n`;
  md += `- **çŠ¶æ€**: ${t.state}\n`;
  md += `- **è´Ÿè´£éƒ¨é—¨**: ${t.org}\n\n`;
  md += `## æµè½¬è®°å½•\n\n`;
  for(const f of fl){
    md += `- **${f.from}** â†’ **${f.to}**  \n  ${f.remark}  \n  _${(f.at||'').substring(0,19)}_\n\n`;
  }
  if(t.output && t.output!=='-') md += `## äº§å‡ºç‰©\n\n\`${t.output}\`\n`;
  navigator.clipboard.writeText(md).then(()=>toast('âœ… å¥æŠ˜å·²å¤åˆ¶ä¸º Markdown','ok')).catch(()=>toast('å¤åˆ¶å¤±è´¥','err'));
}

/* â•â• TEMPLATES (åœ£æ—¨æ¨¡æ¿åº“) â•â• */
const TEMPLATES = [
  {id:'tpl-weekly-report', cat:'æ—¥å¸¸åŠå…¬', icon:'ğŸ“', name:'å‘¨æŠ¥ç”Ÿæˆ',
   desc:'åŸºäºæœ¬å‘¨çœ‹æ¿æ•°æ®å’Œå„éƒ¨äº§å‡ºï¼Œè‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–å‘¨æŠ¥',
   depts:['æˆ·éƒ¨','ç¤¼éƒ¨'], est:'~10åˆ†é’Ÿ', cost:'Â¥0.5',
   params:[
     {key:'date_range', label:'æŠ¥å‘Šå‘¨æœŸ', type:'text', default:'æœ¬å‘¨', required:true},
     {key:'focus', label:'é‡ç‚¹å…³æ³¨ï¼ˆé€—å·åˆ†éš”ï¼‰', type:'text', default:'é¡¹ç›®è¿›å±•,ä¸‹å‘¨è®¡åˆ’'},
     {key:'format', label:'è¾“å‡ºæ ¼å¼', type:'select', options:['Markdown','é£ä¹¦æ–‡æ¡£'], default:'Markdown'}
   ],
   command:'ç”Ÿæˆ{date_range}çš„å‘¨æŠ¥ï¼Œé‡ç‚¹è¦†ç›–{focus}ï¼Œè¾“å‡ºä¸º{format}æ ¼å¼'},
  {id:'tpl-code-review', cat:'å·¥ç¨‹å¼€å‘', icon:'ğŸ”', name:'ä»£ç å®¡æŸ¥',
   desc:'å¯¹æŒ‡å®šä»£ç ä»“åº“/æ–‡ä»¶è¿›è¡Œè´¨é‡å®¡æŸ¥ï¼Œè¾“å‡ºé—®é¢˜æ¸…å•å’Œæ”¹è¿›å»ºè®®',
   depts:['å…µéƒ¨','åˆ‘éƒ¨'], est:'~20åˆ†é’Ÿ', cost:'Â¥2',
   params:[
     {key:'repo', label:'ä»“åº“/æ–‡ä»¶è·¯å¾„', type:'text', required:true},
     {key:'scope', label:'å®¡æŸ¥èŒƒå›´', type:'select', options:['å…¨é‡','å¢é‡(æœ€è¿‘commit)','æŒ‡å®šæ–‡ä»¶'], default:'å¢é‡(æœ€è¿‘commit)'},
     {key:'focus', label:'é‡ç‚¹å…³æ³¨ï¼ˆå¯é€‰ï¼‰', type:'text', default:'å®‰å…¨æ¼æ´,é”™è¯¯å¤„ç†,æ€§èƒ½'}
   ],
   command:'å¯¹ {repo} è¿›è¡Œä»£ç å®¡æŸ¥ï¼ŒèŒƒå›´ï¼š{scope}ï¼Œé‡ç‚¹å…³æ³¨ï¼š{focus}'},
  {id:'tpl-api-design', cat:'å·¥ç¨‹å¼€å‘', icon:'âš¡', name:'API è®¾è®¡ä¸å®ç°',
   desc:'ä»éœ€æ±‚æè¿°åˆ° RESTful API è®¾è®¡ã€å®ç°ã€æµ‹è¯•ä¸€æ¡é¾™',
   depts:['ä¸­ä¹¦çœ','å…µéƒ¨'], est:'~45åˆ†é’Ÿ', cost:'Â¥3',
   params:[
     {key:'requirement', label:'éœ€æ±‚æè¿°', type:'textarea', required:true},
     {key:'tech', label:'æŠ€æœ¯æ ˆ', type:'select', options:['Python/FastAPI','Node/Express','Go/Gin'], default:'Python/FastAPI'},
     {key:'auth', label:'é‰´æƒæ–¹å¼', type:'select', options:['JWT','API Key','æ— '], default:'JWT'}
   ],
   command:'è®¾è®¡å¹¶å®ç°ä¸€ä¸ª {tech} çš„ RESTful APIï¼š{requirement}ã€‚é‰´æƒæ–¹å¼ï¼š{auth}'},
  {id:'tpl-competitor', cat:'æ•°æ®åˆ†æ', icon:'ğŸ“Š', name:'ç«å“åˆ†æ',
   desc:'çˆ¬å–ç«å“ç½‘ç«™æ•°æ®ï¼Œåˆ†æå¯¹æ¯”ï¼Œç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Š',
   depts:['å…µéƒ¨','æˆ·éƒ¨','ç¤¼éƒ¨'], est:'~60åˆ†é’Ÿ', cost:'Â¥5',
   params:[
     {key:'targets', label:'ç«å“åç§°/URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰', type:'textarea', required:true},
     {key:'dimensions', label:'åˆ†æç»´åº¦', type:'text', default:'äº§å“åŠŸèƒ½,å®šä»·ç­–ç•¥,ç”¨æˆ·è¯„ä»·'},
     {key:'format', label:'è¾“å‡ºæ ¼å¼', type:'select', options:['MarkdownæŠ¥å‘Š','è¡¨æ ¼å¯¹æ¯”'], default:'MarkdownæŠ¥å‘Š'}
   ],
   command:'å¯¹ä»¥ä¸‹ç«å“è¿›è¡Œåˆ†æï¼š\n{targets}\n\nåˆ†æç»´åº¦ï¼š{dimensions}ï¼Œè¾“å‡ºæ ¼å¼ï¼š{format}'},
  {id:'tpl-data-report', cat:'æ•°æ®åˆ†æ', icon:'ğŸ“ˆ', name:'æ•°æ®æŠ¥å‘Š',
   desc:'å¯¹ç»™å®šæ•°æ®é›†è¿›è¡Œæ¸…æ´—ã€åˆ†æã€å¯è§†åŒ–ï¼Œè¾“å‡ºåˆ†ææŠ¥å‘Š',
   depts:['æˆ·éƒ¨','ç¤¼éƒ¨'], est:'~30åˆ†é’Ÿ', cost:'Â¥2',
   params:[
     {key:'data_source', label:'æ•°æ®æºæè¿°/è·¯å¾„', type:'text', required:true},
     {key:'questions', label:'åˆ†æé—®é¢˜ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰', type:'textarea'},
     {key:'viz', label:'æ˜¯å¦éœ€è¦å¯è§†åŒ–å›¾è¡¨', type:'select', options:['æ˜¯','å¦'], default:'æ˜¯'}
   ],
   command:'å¯¹æ•°æ® {data_source} è¿›è¡Œåˆ†æã€‚{questions}\néœ€è¦å¯è§†åŒ–ï¼š{viz}'},
  {id:'tpl-blog', cat:'å†…å®¹åˆ›ä½œ', icon:'âœï¸', name:'åšå®¢æ–‡ç« ',
   desc:'ç»™å®šä¸»é¢˜å’Œè¦æ±‚ï¼Œç”Ÿæˆé«˜è´¨é‡åšå®¢æ–‡ç« ',
   depts:['ç¤¼éƒ¨'], est:'~15åˆ†é’Ÿ', cost:'Â¥1',
   params:[
     {key:'topic', label:'æ–‡ç« ä¸»é¢˜', type:'text', required:true},
     {key:'audience', label:'ç›®æ ‡è¯»è€…', type:'text', default:'æŠ€æœ¯äººå‘˜'},
     {key:'length', label:'æœŸæœ›å­—æ•°', type:'select', options:['~1000å­—','~2000å­—','~3000å­—'], default:'~2000å­—'},
     {key:'style', label:'é£æ ¼', type:'select', options:['æŠ€æœ¯æ•™ç¨‹','è§‚ç‚¹è¯„è®º','æ¡ˆä¾‹åˆ†æ'], default:'æŠ€æœ¯æ•™ç¨‹'}
   ],
   command:'å†™ä¸€ç¯‡å…³äºã€Œ{topic}ã€çš„åšå®¢æ–‡ç« ï¼Œé¢å‘{audience}ï¼Œ{length}ï¼Œé£æ ¼ï¼š{style}'},
  {id:'tpl-deploy', cat:'å·¥ç¨‹å¼€å‘', icon:'ğŸš€', name:'éƒ¨ç½²æ–¹æ¡ˆ',
   desc:'ç”Ÿæˆå®Œæ•´çš„éƒ¨ç½²æ£€æŸ¥å•ã€Dockeré…ç½®ã€CI/CDæµç¨‹',
   depts:['å…µéƒ¨','å·¥éƒ¨'], est:'~25åˆ†é’Ÿ', cost:'Â¥2',
   params:[
     {key:'project', label:'é¡¹ç›®åç§°/æè¿°', type:'text', required:true},
     {key:'env', label:'éƒ¨ç½²ç¯å¢ƒ', type:'select', options:['Docker','K8s','VPS','Serverless'], default:'Docker'},
     {key:'ci', label:'CI/CD å·¥å…·', type:'select', options:['GitHub Actions','GitLab CI','æ— '], default:'GitHub Actions'}
   ],
   command:'ä¸ºé¡¹ç›®ã€Œ{project}ã€ç”Ÿæˆ{env}éƒ¨ç½²æ–¹æ¡ˆï¼ŒCI/CDä½¿ç”¨{ci}'},
  {id:'tpl-email', cat:'å†…å®¹åˆ›ä½œ', icon:'ğŸ“§', name:'é‚®ä»¶/é€šçŸ¥æ–‡æ¡ˆ',
   desc:'æ ¹æ®åœºæ™¯å’Œç›®çš„ï¼Œç”Ÿæˆä¸“ä¸šé‚®ä»¶æˆ–é€šçŸ¥æ–‡æ¡ˆ',
   depts:['ç¤¼éƒ¨'], est:'~5åˆ†é’Ÿ', cost:'Â¥0.3',
   params:[
     {key:'scenario', label:'ä½¿ç”¨åœºæ™¯', type:'select', options:['å•†åŠ¡é‚®ä»¶','äº§å“å‘å¸ƒ','å®¢æˆ·é€šçŸ¥','å†…éƒ¨å…¬å‘Š'], default:'å•†åŠ¡é‚®ä»¶'},
     {key:'purpose', label:'ç›®çš„/å†…å®¹', type:'textarea', required:true},
     {key:'tone', label:'è¯­è°ƒ', type:'select', options:['æ­£å¼','å‹å¥½','ç®€æ´'], default:'æ­£å¼'}
   ],
   command:'æ’°å†™ä¸€å°{scenario}ï¼Œ{tone}è¯­è°ƒã€‚å†…å®¹ï¼š{purpose}'},
  {id:'tpl-standup', cat:'æ—¥å¸¸åŠå…¬', icon:'ğŸ—“ï¸', name:'æ¯æ—¥ç«™ä¼šæ‘˜è¦',
   desc:'æ±‡æ€»å„éƒ¨ä»Šæ—¥è¿›å±•å’Œæ˜æ—¥è®¡åˆ’ï¼Œç”Ÿæˆç«™ä¼šæ‘˜è¦',
   depts:['å°šä¹¦çœ'], est:'~5åˆ†é’Ÿ', cost:'Â¥0.3',
   params:[
     {key:'range', label:'æ±‡æ€»èŒƒå›´', type:'select', options:['ä»Šå¤©','æœ€è¿‘24å°æ—¶','æ˜¨å¤©+ä»Šå¤©'], default:'ä»Šå¤©'}
   ],
   command:'æ±‡æ€»{range}å„éƒ¨å·¥ä½œè¿›å±•å’Œå¾…åŠï¼Œç”Ÿæˆç«™ä¼šæ‘˜è¦'}
];
const TPL_CATS = [
  {name:'å…¨éƒ¨', icon:'ğŸ“‹'},
  {name:'æ—¥å¸¸åŠå…¬', icon:'ğŸ’¼'},
  {name:'æ•°æ®åˆ†æ', icon:'ğŸ“Š'},
  {name:'å·¥ç¨‹å¼€å‘', icon:'âš™ï¸'},
  {name:'å†…å®¹åˆ›ä½œ', icon:'âœï¸'}
];
let tplCatFilter = 'å…¨éƒ¨';

function renderTemplates(){
  // categories
  document.getElementById('tpl-cats').innerHTML = TPL_CATS.map(c=>
    `<span class="tpl-cat${tplCatFilter===c.name?' active':''}" onclick="tplCatFilter='${c.name}';renderTemplates()">${c.icon} ${c.name}</span>`
  ).join('');

  let tpls = TEMPLATES;
  if(tplCatFilter!=='å…¨éƒ¨') tpls = tpls.filter(t=>t.cat===tplCatFilter);

  document.getElementById('tpl-grid').innerHTML = tpls.map(t=>`
    <div class="tpl-card">
      <div class="tpl-top">
        <span class="tpl-icon">${t.icon}</span>
        <span class="tpl-name">${esc(t.name)}</span>
      </div>
      <div class="tpl-desc">${esc(t.desc)}</div>
      <div class="tpl-footer">
        ${t.depts.map(d=>`<span class="tpl-dept">${esc(d)}</span>`).join('')}
        <span class="tpl-est">${esc(t.est)} Â· ${esc(t.cost)}</span>
        <button class="tpl-go" onclick="openTemplateForm('${t.id}')">ä¸‹æ—¨</button>
      </div>
    </div>
  `).join('');
}

function openTemplateForm(tplId){
  const t = TEMPLATES.find(x=>x.id===tplId);
  if(!t) return;
  document.getElementById('modal-body').innerHTML=`
    <div style="font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:4px">åœ£æ—¨æ¨¡æ¿</div>
    <div style="font-size:20px;font-weight:800;margin-bottom:6px">${t.icon} ${esc(t.name)}</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:18px">${esc(t.desc)}</div>
    <div style="display:flex;gap:6px;margin-bottom:18px;flex-wrap:wrap">${t.depts.map(d=>`<span class="tpl-dept">${esc(d)}</span>`).join('')}<span style="font-size:11px;color:var(--muted);margin-left:auto">${esc(t.est)} Â· ${esc(t.cost)}</span></div>
    <form class="tpl-form" onsubmit="executeTemplate(event,'${t.id}')">
      ${t.params.map(p=>`<div class="tpl-field">
        <label class="tpl-label">${esc(p.label)}${p.required?` <span style="color:#ff5270">*</span>`:''}</label>
        ${p.type==='textarea'
          ?`<textarea id="tpl-${p.key}" class="tpl-input" style="min-height:80px;resize:vertical" ${p.required?'required':''} placeholder="${esc(p.default||'')}">${esc(p.default||'')}</textarea>`
          :p.type==='select'
          ?`<select id="tpl-${p.key}" class="tpl-input">${(p.options||[]).map(o=>`<option${o===p.default?' selected':''}>${esc(o)}</option>`).join('')}</select>`
          :`<input id="tpl-${p.key}" class="tpl-input" type="text" value="${esc(p.default||'')}" ${p.required?'required':''}/>`
        }
      </div>`).join('')}
      <div id="tpl-preview" style="background:var(--panel2);border:1px solid var(--line);border-radius:8px;padding:12px;margin-bottom:14px;font-size:12px;color:var(--muted);display:none"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button type="button" class="btn btn-g" onclick="previewTemplate('${t.id}')" style="padding:8px 16px;font-size:12px">ğŸ‘ é¢„è§ˆæ—¨æ„</button>
        <button type="submit" class="tpl-go" style="padding:8px 20px;font-size:13px">ğŸ“œ ä¸‹æ—¨</button>
      </div>
    </form>
  `;
  document.getElementById('modal-bg').classList.add('open');
}

function buildCommand(tplId){
  const t = TEMPLATES.find(x=>x.id===tplId);
  if(!t) return '';
  let cmd = t.command;
  for(const p of t.params){
    const el = document.getElementById('tpl-'+p.key);
    const val = el ? el.value : (p.default||'');
    cmd = cmd.replace(new RegExp('\\{'+p.key+'\\}','g'), val);
  }
  return cmd;
}

function previewTemplate(tplId){
  const cmd = buildCommand(tplId);
  const el = document.getElementById('tpl-preview');
  el.style.display='block';
  el.innerHTML = `<div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:6px">ğŸ“œ å°†å‘é€ç»™ä¸­ä¹¦çœçš„æ—¨æ„ï¼š</div><div style="white-space:pre-wrap;line-height:1.6">${esc(cmd)}</div>`;
}

async function executeTemplate(e, tplId){
  e.preventDefault();
  const cmd = buildCommand(tplId);
  if(!cmd.trim()){ toast('è¯·å¡«å†™å¿…å¡«å‚æ•°','err'); return; }
  const t = TEMPLATES.find(x=>x.id===tplId);
  // Show the generated command in a confirmation
  if(!confirm(`ç¡®è®¤ä¸‹æ—¨ï¼Ÿ\n\n${cmd.substring(0,200)}${cmd.length>200?'â€¦':''}`)) return;
  toast(`ğŸ“œ æ—¨æ„å·²ç”Ÿæˆï¼Œè¯·å¤åˆ¶åˆ°é£ä¹¦å‘é€ç»™ä¸­ä¹¦çœ`, 'ok', 6000);
  // Copy to clipboard
  const full = cmd;
  navigator.clipboard.writeText(full).then(()=>toast('âœ… æ—¨æ„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿','ok')).catch(()=>{});
  closeModal();
}

/* â•â• INIT â•â• */
loadAll().then(()=>showCeremony());
startCd();
</script>
</body>
</html>
