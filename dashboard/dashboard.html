<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å†›æœºå¤„ Â· ä¸‰çœå…­éƒ¨æ€»æ§å°</title>
  <style>
    :root{
      --bg:#07090f;--panel:#0f1219;--panel2:#141824;--line:#1c2236;
      --text:#dde4f8;--muted:#5a6b92;--ok:#2ecc8a;--warn:#f5c842;--danger:#ff5270;
      --acc:#6a9eff;--acc2:#a07aff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:"PingFang SC",Inter,-apple-system,"Segoe UI",sans-serif;min-height:100vh}
    ::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#1e2538;border-radius:4px}

    .wrap{max-width:1400px;margin:0 auto;padding:16px}

    /* HEADER */
    .hdr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--line)}
    .logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,#6a9eff,#a07aff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .sub{font-size:11px;color:var(--muted)}
    .hdr-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{font-size:11px;padding:3px 9px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted)}
    .chip.ok{border-color:#2ecc8a44;color:var(--ok)}.chip.warn{border-color:#f5c84244;color:var(--warn)}.chip.err{border-color:#ff527044;color:var(--danger)}
    .btn-refresh{font-size:11px;padding:4px 10px;border:1px solid var(--acc);border-radius:6px;background:transparent;color:var(--acc);cursor:pointer}
    .btn-refresh:hover{background:#0a1228}
    #cd{font-size:11px;color:var(--muted)}

    /* TABS */
    .tabs{display:flex;gap:2px;margin-bottom:18px;border-bottom:1px solid var(--line);overflow-x:auto}
    .tab{font-size:13px;padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;color:var(--muted);border:1px solid transparent;border-bottom:none;white-space:nowrap;position:relative;bottom:-1px;transition:all .15s;user-select:none}
    .tab:hover{color:var(--text);background:var(--panel)}
    .tab.active{color:var(--text);background:var(--panel);border-color:var(--line);font-weight:600}
    .tbadge{font-size:10px;padding:1px 5px;border-radius:999px;background:#1a2040;color:var(--acc);margin-left:4px}
    .panel{display:none}.panel.active{display:block}

    /* â•â• æ—¨æ„çœ‹æ¿ â•â• */
    .edict-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px}
    .edict-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;cursor:pointer;transition:border-color .15s,transform .1s,box-shadow .15s}
    .edict-card:hover{border-color:var(--acc);transform:translateY(-2px);box-shadow:0 4px 20px rgba(106,158,255,.1)}

    /* pipeline strip on card */
    .ec-pipe{display:flex;align-items:center;gap:0;margin-bottom:14px;overflow-x:auto;padding-bottom:2px}
    .ep-node{display:flex;flex-direction:column;align-items:center;gap:1px;padding:5px 8px;border-radius:6px;flex-shrink:0;min-width:52px}
    .ep-node.done{background:#0a2018}
    .ep-node.active{background:#0f1a38;border:1px solid var(--acc)}
    .ep-node.pending{opacity:.3}
    .ep-icon{font-size:14px}
    .ep-name{font-size:9px;color:var(--muted);white-space:nowrap}
    .ep-node.done .ep-name{color:var(--ok)}
    .ep-node.active .ep-name{color:var(--acc);font-weight:700}
    .ep-arrow{font-size:10px;color:#1c2236;padding:0 1px;flex-shrink:0}

    .ec-id{font-size:10px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:5px}
    .ec-title{font-size:15px;font-weight:700;line-height:1.4;margin-bottom:10px;color:var(--text)}
    .ec-meta{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:8px}
    .tag{font-size:10px;padding:2px 7px;border-radius:4px;border:1px solid;display:inline-block;white-space:nowrap}

    /* state colors */
    .st-Inbox{border-color:#3a4a7a44;color:#7a9aff;background:#0a1028}
    .st-Zhongshu{border-color:#a07aff44;color:#a07aff;background:#110a28}
    .st-Menxia{border-color:#ff9a6a44;color:#ff9a6a;background:#280f0a}
    .st-Assigned,.st-Doing{border-color:#6a9eff44;color:#6a9eff;background:#0a1428}
    .st-Review{border-color:#f5c84244;color:#f5c842;background:#201a08}
    .st-Done{border-color:#2ecc8a44;color:var(--ok);background:#0a2018}
    .st-Blocked{border-color:#ff527044;color:var(--danger);background:#200a10}
    .st-Next{border-color:#4a9adf44;color:#4a9adf;background:#0a1424}

    /* dept colors */
    .dt-ä¸­ä¹¦çœ{border-color:#a07aff44;color:#a07aff;background:#1a0f38}
    .dt-é—¨ä¸‹çœ{border-color:#6a9eff44;color:#6a9eff;background:#0f1a38}
    .dt-å°šä¹¦çœ{border-color:#6aef9a44;color:#6aef9a;background:#0a2018}
    .dt-ç¤¼éƒ¨{border-color:#f5c84244;color:#f5c842;background:#201a08}
    .dt-æˆ·éƒ¨{border-color:#ff9a6a44;color:#ff9a6a;background:#28100a}
    .dt-å…µéƒ¨{border-color:#ff527044;color:#ff5270;background:#280a10}
    .dt-åˆ‘éƒ¨{border-color:#cc444444;color:#cc4444;background:#280808}
    .dt-å·¥éƒ¨{border-color:#44aaff44;color:#44aaff;background:#081828}

    .ec-footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px;flex-wrap:wrap;gap:6px}
    .hb{font-size:10px;padding:2px 7px;border-radius:999px;border:1px solid var(--line)}
    .hb.active{border-color:#2ecc8a44;color:var(--ok)}.hb.warn{border-color:#f5c84244;color:var(--warn)}.hb.stalled{border-color:#ff527044;color:var(--danger);animation:pulse 1.5s infinite}.hb.unknown{color:var(--muted)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

    /* â•â• TASK DETAIL MODAL â•â• */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;backdrop-filter:blur(3px);overflow-y:auto}
    .modal-bg.open{display:flex;align-items:flex-start;justify-content:center;padding:40px 16px}
    .modal{background:var(--panel);border:1px solid var(--line);border-radius:18px;width:100%;max-width:760px;padding:28px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .modal-close{position:absolute;top:16px;right:16px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:18px;color:var(--muted)}
    .modal-close:hover{background:var(--panel2);color:var(--text)}
    .modal-id{font-size:11px;color:var(--acc);font-weight:700;letter-spacing:.04em;margin-bottom:6px}
    .modal-title{font-size:22px;font-weight:800;line-height:1.3;margin-bottom:18px}

    /* full pipeline in modal */
    .m-pipe{display:flex;align-items:stretch;gap:0;overflow-x:auto;padding:16px;background:var(--panel2);border-radius:12px;margin-bottom:20px}
    .mp-stage{display:flex;align-items:center;flex-shrink:0}
    .mp-node{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 14px;border-radius:10px;min-width:80px;position:relative}
    .mp-node.done{background:#0a2018;border:1px solid #2ecc8a44}
    .mp-node.active{background:#0f1838;border:2px solid var(--acc);box-shadow:0 0 14px rgba(106,158,255,.2)}
    .mp-node.pending{opacity:.25;border:1px dashed var(--line)}
    .mp-icon{font-size:22px}
    .mp-dept{font-size:12px;font-weight:700;margin-top:2px}
    .mp-node.done .mp-dept{color:var(--ok)}
    .mp-node.active .mp-dept{color:var(--acc)}
    .mp-node.pending .mp-dept{color:var(--muted)}
    .mp-action{font-size:10px;color:var(--muted);margin-top:1px}
    .mp-node.active .mp-action{color:#6a9eff88}
    .mp-done-tick{position:absolute;top:-6px;right:-6px;width:16px;height:16px;background:var(--ok);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;color:#000;font-weight:700}
    .mp-arrow{color:#1c2236;font-size:18px;padding:0 6px;margin-top:-10px}

    /* current stage banner */
    .cur-stage{display:flex;align-items:center;gap:10px;padding:12px 16px;background:#0a1228;border:1px solid var(--acc);border-radius:10px;margin-bottom:18px}
    .cs-icon{font-size:24px}
    .cs-info .cs-dept{font-size:16px;font-weight:700;color:var(--acc)}
    .cs-info .cs-action{font-size:12px;color:var(--muted);margin-top:2px}
    .cs-hb{margin-left:auto}

    /* flow log */
    .m-section{margin-bottom:18px}
    .m-sec-label{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--line)}
    .fl-timeline{display:flex;flex-direction:column;gap:0;position:relative}
    .fl-timeline::before{content:'';position:absolute;left:60px;top:0;bottom:0;width:1px;background:var(--line)}
    .fl-item{display:flex;gap:0;position:relative;padding:8px 0}
    .fl-time{min-width:60px;font-size:10px;color:var(--muted);text-align:right;padding-right:14px;flex-shrink:0;padding-top:3px}
    .fl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:3px;position:relative;z-index:1}
    .fl-content{padding-left:12px;flex:1}
    .fl-who{font-size:12px;margin-bottom:2px}
    .fl-who .from{font-weight:700}
    .fl-who .to{font-weight:700}
    .fl-rem{font-size:11px;color:var(--muted);line-height:1.5}
    .fl-ok{color:var(--ok)}.fl-warn{color:var(--warn)}.fl-blue{color:var(--acc)}.fl-purple{color:var(--acc2)}

    /* meta rows */
    .m-rows{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .m-row{background:var(--panel2);border-radius:8px;padding:10px 12px}
    .mr-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
    .mr-val{font-size:13px;font-weight:600;word-break:break-all}

    /* â•â• çœéƒ¨è°ƒåº¦ tab â•â• */
    .dept-monitor{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px}
    .dm-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .dm-hdr{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--panel2);border-bottom:1px solid var(--line)}
    .dm-emoji{font-size:18px}.dm-name{font-size:14px;font-weight:700}.dm-cnt{font-size:11px;color:var(--muted);margin-left:auto}
    .dm-sessions{padding:8px}
    .ds-row{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:7px;font-size:12px;margin-bottom:3px;cursor:pointer}
    .ds-row:hover{background:var(--panel2)}
    .ds-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
    .ds-dot.active{background:var(--ok)}.ds-dot.warn{background:var(--warn)}.ds-dot.stalled{background:var(--danger);animation:pulse 1.2s infinite}.ds-dot.unknown{background:var(--muted)}
    .ds-id{color:var(--muted);font-size:10px;font-family:monospace;min-width:80px}
    .ds-state{margin-left:auto}.ds-hb{font-size:10px;color:var(--muted)}

    /* â•â• Model / Skills tabs â•â• */
    .model-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-bottom:18px}
    .mc-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
    .mc-top{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .mc-emoji{font-size:22px}
    .mc-name{font-size:15px;font-weight:700}.mc-role{font-size:11px;color:var(--muted)}
    .mc-cur{font-size:11px;color:var(--muted);margin-bottom:8px}.mc-cur b{color:var(--text)}
    .msel{width:100%;background:var(--panel2);border:1px solid var(--line);border-radius:7px;color:var(--text);padding:7px 10px;font-size:12px;outline:none;cursor:pointer}.msel:focus{border-color:var(--acc)}
    .mc-btns{display:flex;gap:6px;margin-top:8px}
    .btn{font-size:12px;padding:6px 14px;border-radius:7px;border:none;cursor:pointer;font-weight:600}
    .btn-p{background:var(--acc);color:#000}.btn-p:hover{filter:brightness(1.15)}.btn-p:disabled{background:#2a3a6a;color:var(--muted);cursor:not-allowed}
    .btn-g{background:transparent;border:1px solid var(--line);color:var(--muted)}.btn-g:hover{border-color:#2e3d6a;color:var(--text)}
    .mc-st{font-size:11px;margin-top:6px;padding:4px 8px;border-radius:5px;display:none}
    .mc-st.ok{display:block;background:#0a2018;color:var(--ok);border:1px solid #2ecc8a44}
    .mc-st.err{display:block;background:#200a10;color:var(--danger);border:1px solid #ff527044}
    .mc-st.pending{display:block;background:#0a1228;color:var(--acc);border:1px solid #6a9eff44}
    .cl-wrap{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
    .cl-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;margin-bottom:10px}
    .cl-row{display:flex;gap:10px;font-size:11px;padding:5px 0;border-bottom:1px solid var(--line)}.cl-row:last-child{border-bottom:none}
    .cl-t{color:var(--muted);min-width:115px}.cl-a{color:var(--acc);min-width:80px}.cl-c{color:var(--muted)}.cl-c b{color:var(--text)}

    .skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .sk-card{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .sk-hdr{display:flex;align-items:center;gap:9px;padding:11px 14px;background:var(--panel2);border-bottom:1px solid var(--line)}
    .sk-emoji{font-size:18px}.sk-name{font-size:14px;font-weight:700}.sk-cnt{font-size:11px;color:var(--muted);margin-left:auto}
    .sk-list{padding:10px}
    .sk-item{display:flex;gap:8px;padding:6px 8px;border-radius:7px;font-size:12px;margin-bottom:3px}.sk-item:hover{background:var(--panel2)}
    .si-name{font-weight:600;min-width:100px}.si-desc{color:var(--muted);flex:1;line-height:1.4}
    .sk-empty{font-size:12px;color:var(--muted);padding:12px;text-align:center;opacity:.6}

    /* TOAST */
    #toaster{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:300}
    .toast{font-size:13px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.4);animation:tin .2s;max-width:320px}
    .toast.ok{border-color:#2ecc8a55;background:#0a1a10}.toast.err{border-color:#ff527055;background:#200a10}
    @keyframes tin{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}

    /* MISC */
    .empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:13px}
    .sec-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:12px}
    code{font-size:11px;background:var(--panel2);padding:2px 6px;border-radius:4px;font-family:monospace}
  </style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="hdr">
    <div>
      <div class="logo">âš”ï¸ å†›æœºå¤„ Â· ä¸‰çœå…­éƒ¨æ€»æ§å°</div>
      <div class="sub">çš‡ä¸Šè§†è§’ Â· å®æ—¶æ—¨æ„è¿½è¸ª</div>
    </div>
    <div class="hdr-r">
      <span class="chip" id="chip-sync">âŸ³ åŒæ­¥ä¸­</span>
      <span class="chip" id="chip-tasks">â€” æ—¨æ„</span>
      <button class="btn-refresh" onclick="loadAll()">âŸ³ ç«‹å³åˆ·æ–°</button>
      <span id="cd"></span>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="edicts">ğŸ“œ æ—¨æ„çœ‹æ¿ <span class="tbadge" id="tb-e">0</span></div>
    <div class="tab" data-tab="monitor">ğŸ”­ çœéƒ¨è°ƒåº¦ <span class="tbadge" id="tb-m">0</span></div>
    <div class="tab" data-tab="models">âš™ï¸ æ¨¡å‹é…ç½®</div>
    <div class="tab" data-tab="skills">ğŸ› ï¸ æŠ€èƒ½é…ç½®</div>
  </div>

  <!-- â•â• æ—¨æ„çœ‹æ¿ â•â• -->
  <div class="panel active" id="panel-edicts">
    <div id="edict-grid" class="edict-grid"></div>
  </div>

  <!-- â•â• çœéƒ¨è°ƒåº¦ â•â• -->
  <div class="panel" id="panel-monitor">
    <div class="dept-monitor" id="dept-monitor"></div>
  </div>

  <!-- â•â• æ¨¡å‹é…ç½® â•â• -->
  <div class="panel" id="panel-models">
    <div class="sec-title" style="margin-bottom:14px">å„çœéƒ¨ Â· æ¨¡å‹é…ç½® <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:var(--muted)">â€” æ›´æ”¹åè‡ªåŠ¨é‡å¯ Gatewayï¼ˆçº¦5ç§’ï¼‰</span></div>
    <div class="model-grid" id="model-grid"></div>
    <div class="cl-wrap"><div class="cl-title">å˜æ›´è®°å½•</div><div id="cl-list"></div></div>
  </div>

  <!-- â•â• æŠ€èƒ½é…ç½® â•â• -->
  <div class="panel" id="panel-skills">
    <div class="sec-title" style="margin-bottom:14px">å„çœéƒ¨ Â· Skills é…ç½®</div>
    <div class="skills-grid" id="skills-grid"></div>
  </div>
</div>

<!-- TASK DETAIL MODAL -->
<div class="modal-bg" id="modal-bg" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-close" onclick="closeModal()">âœ•</div>
    <div id="modal-body"></div>
  </div>
</div>

<div id="toaster"></div>

<script>
/* â•â• CONFIG â•â• */
const API = 'http://127.0.0.1:7891/api';
let liveStatus=null, agentConfig=null, activeTab='edicts', countdown=5;

/* â•â• PIPELINE DEFINITION â•â• */
const PIPE = [
  {key:'Inbox',    dept:'çš‡ä¸Š',   icon:'ğŸ‘‘', action:'ä¸‹æ—¨'},
  {key:'Zhongshu', dept:'ä¸­ä¹¦çœ', icon:'ğŸ“œ', action:'è§„åˆ’'},
  {key:'Menxia',   dept:'é—¨ä¸‹çœ', icon:'ğŸ”', action:'å®¡è®®'},
  {key:'Assigned', dept:'å°šä¹¦çœ', icon:'ğŸ“®', action:'æ´¾å‘'},
  {key:'Doing',    dept:'å…­éƒ¨',   icon:'âš™ï¸', action:'æ‰§è¡Œ'},
  {key:'Review',   dept:'å°šä¹¦çœ', icon:'ğŸ”', action:'æ±‡æ€»'},
  {key:'Done',     dept:'å›å¥',   icon:'âœ…', action:'å®Œæˆ'},
];
const PIPE_STATE_IDX = {Inbox:0,Zhongshu:1,Menxia:2,Assigned:3,Doing:4,Review:5,Done:6,Blocked:4,Next:3};

/* â•â• DEPT COLORS â•â• */
const DEPT_COLOR = {'ä¸­ä¹¦çœ':'#a07aff','é—¨ä¸‹çœ':'#6a9eff','å°šä¹¦çœ':'#6aef9a','ç¤¼éƒ¨':'#f5c842','æˆ·éƒ¨':'#ff9a6a','å…µéƒ¨':'#ff5270','åˆ‘éƒ¨':'#cc4444','å·¥éƒ¨':'#44aaff','çš‡ä¸Š':'#ffd700','å›å¥':'#2ecc8a'};
function deptColor(d){return DEPT_COLOR[d]||'#6a9eff'}

/* â•â• UTILS â•â• */
const esc=s=>s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
async function fetchJ(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw Error(r.status);return r.json()}
async function postJ(u,d){const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});return r.json()}
function toast(msg,type='ok',ms=3000){const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;document.getElementById('toaster').appendChild(el);setTimeout(()=>el.remove(),ms)}
const STATE_LABEL={Inbox:'æ”¶ä»¶',Zhongshu:'ä¸­ä¹¦è§„åˆ’',Menxia:'é—¨ä¸‹å®¡è®®',Assigned:'å·²æ´¾å‘',Doing:'æ‰§è¡Œä¸­',Review:'å¾…å®¡æŸ¥',Done:'å·²å®Œæˆ',Blocked:'é˜»å¡',Next:'å¾…æ‰§è¡Œ'};

/* â•â• TASK CLASSIFICATION â•â• */
// çš‡ä¸Šçš„æ—¨æ„ï¼šJJC-* å¼€å¤´ï¼Œæœ‰çœŸå®æ ‡é¢˜
function isEdict(t){ return /^JJC-/i.test(t.id||'') }
// ç³»ç»Ÿä¼šè¯ï¼šOC-* / MC-* å¼€å¤´
function isSession(t){ return /^(OC-|MC-)/i.test(t.id||'') }

/* â•â• PIPE STATUS FOR A TASK â•â• */
function getPipeStatus(t){
  const stateIdx = PIPE_STATE_IDX[t.state] ?? 4;
  return PIPE.map((stage, i) => ({
    ...stage,
    status: i < stateIdx ? 'done' : i === stateIdx ? 'active' : 'pending'
  }));
}

/* â•â• CARD MINI PIPELINE â•â• */
function miniPipe(t){
  const stages = getPipeStatus(t);
  return `<div class="ec-pipe">
    ${stages.map((s,i) => `
      <div class="ep-node ${s.status}">
        <div class="ep-icon">${s.icon}</div>
        <div class="ep-name">${s.dept}</div>
      </div>
      ${i < stages.length-1 ? `<div class="ep-arrow">â€º</div>` : ''}
    `).join('')}
  </div>`;
}

/* â•â• EDICT CARDS â•â• */
function renderEdicts(tasks){
  const edicts = tasks.filter(isEdict).sort((a,b) => {
    const order = {Doing:0,Review:1,Assigned:2,Menxia:3,Zhongshu:4,Inbox:5,Blocked:6,Next:7,Done:8};
    return (order[a.state]??9) - (order[b.state]??9);
  });
  document.getElementById('tb-e').textContent = edicts.length;
  document.getElementById('chip-tasks').textContent = edicts.length + ' é“æ—¨æ„';
  const el = document.getElementById('edict-grid');
  if(!edicts.length){
    el.innerHTML='<div class="empty" style="grid-column:1/-1">æš‚æ— æ—¨æ„<br><small style="font-size:11px;margin-top:6px;display:block;color:var(--muted)">é€šè¿‡é£ä¹¦/Telegram å‘ä¸­ä¹¦çœå‘é€ä»»åŠ¡ï¼Œä»»åŠ¡IDæ ¼å¼ JJC-* å°†æ˜¾ç¤ºäºæ­¤</small></div>';
    return;
  }
  el.innerHTML = edicts.map(t => {
    const hb = t.heartbeat||{status:'unknown',label:'âšª'};
    const deptCls = 'dt-'+(t.org||'').replace(/\s/g,'');
    const stCls = 'st-'+(t.state||'');
    const isBlocked = t.block && t.block !== 'æ— ' && t.block !== '-';
    const curStage = PIPE.find((_,i) => getPipeStatus(t)[i].status === 'active');
    return `
    <div class="edict-card" onclick='openTask(${JSON.stringify(t.id)})'>
      ${miniPipe(t)}
      <div class="ec-id">${esc(t.id)}</div>
      <div class="ec-title">${esc(t.title||'(æ— æ ‡é¢˜)')}</div>
      <div class="ec-meta">
        <span class="tag ${stCls}">${STATE_LABEL[t.state]||t.state}</span>
        ${t.org ? `<span class="tag ${deptCls}">${esc(t.org)}</span>` : ''}
        ${curStage ? `<span style="font-size:11px;color:var(--muted)">å½“å‰: <b style="color:${deptColor(curStage.dept)}">${curStage.dept} Â· ${curStage.action}</b></span>` : ''}
      </div>
      ${t.now && t.now !== '-' ? `<div style="font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:6px">${esc(t.now.substring(0,80))}</div>` : ''}
      <div class="ec-footer">
        <span class="hb ${hb.status}">${esc(hb.label)}</span>
        ${isBlocked ? `<span class="tag" style="border-color:#ff527044;color:var(--danger);background:#200a10">ğŸš« ${esc(t.block)}</span>` : ''}
        ${t.eta && t.eta !== '-' ? `<span style="font-size:11px;color:var(--muted)">ğŸ“… ${esc(t.eta)}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

/* â•â• DEPT MONITOR â•â• */
function renderMonitor(tasks){
  const sessions = tasks.filter(isSession);
  document.getElementById('tb-m').textContent = sessions.length;
  const DEPTS = [
    {id:'zhongshu',label:'ä¸­ä¹¦çœ',emoji:'ğŸ“œ'},
    {id:'menxia',  label:'é—¨ä¸‹çœ',emoji:'ğŸ”'},
    {id:'shangshu',label:'å°šä¹¦çœ',emoji:'ğŸ“®'},
    {id:'hubu',    label:'æˆ·éƒ¨',  emoji:'ğŸ’°'},
    {id:'libu',    label:'ç¤¼éƒ¨',  emoji:'ğŸ“'},
    {id:'bingbu',  label:'å…µéƒ¨',  emoji:'âš”ï¸'},
    {id:'xingbu',  label:'åˆ‘éƒ¨',  emoji:'âš–ï¸'},
    {id:'gongbu',  label:'å·¥éƒ¨',  emoji:'ğŸ”§'},
  ];
  const byDept = {};
  sessions.forEach(t => {
    const org = t.org || 'å…¶ä»–';
    (byDept[org] || (byDept[org] = [])).push(t);
  });
  const el = document.getElementById('dept-monitor');
  el.innerHTML = DEPTS.map(d => {
    const items = byDept[d.label] || [];
    return `<div class="dm-card">
      <div class="dm-hdr">
        <span class="dm-emoji">${d.emoji}</span>
        <span class="dm-name">${d.label}</span>
        <span class="dm-cnt">${items.length} ä¼šè¯</span>
      </div>
      <div class="dm-sessions">
        ${!items.length ? '<div style="font-size:11px;color:var(--muted);padding:8px;opacity:.6">ç©ºé—²</div>' :
          items.slice(0,5).map(t => {
            const hb = t.heartbeat||{status:'unknown'};
            const shortId = t.id.replace(/^OC-[a-z]+-/,'').substring(0,8);
            return `<div class="ds-row" onclick='openTask(${JSON.stringify(t.id)})'>
              <div class="ds-dot ${hb.status}"></div>
              <span class="ds-id">${esc(shortId)}</span>
              <span style="flex:1;font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc((t.title||'').replace(/è¤šå‡¤å¤©\s*/,'').replace(/ä¼šè¯/,'').substring(0,20)||'ä¼šè¯')}</span>
              <span class="tag ds-state st-${t.state}" style="font-size:9px">${STATE_LABEL[t.state]||t.state}</span>
            </div>`
          }).join('')
        }
      </div>
    </div>`;
  }).join('');
}

/* â•â• TASK DETAIL MODAL â•â• */
function openTask(id){
  if(!liveStatus||!liveStatus.tasks)return;
  const t = liveStatus.tasks.find(x=>x.id===id);
  if(!t)return;
  const stages = getPipeStatus(t);
  const activeStage = stages.find(s=>s.status==='active');
  const hb = t.heartbeat||{status:'unknown',label:'âšª æ— æ•°æ®'};
  const flowLog = t.flow_log||[];

  document.getElementById('modal-body').innerHTML = `
    <div class="modal-id">${esc(t.id)}</div>
    <div class="modal-title">${esc(t.title||'(æ— æ ‡é¢˜)')}</div>

    <!-- å½“å‰é˜¶æ®µæ¨ªå¹… -->
    ${activeStage ? `
    <div class="cur-stage">
      <div class="cs-icon">${activeStage.icon}</div>
      <div class="cs-info">
        <div class="cs-dept" style="color:${deptColor(activeStage.dept)}">${activeStage.dept}</div>
        <div class="cs-action">å½“å‰é˜¶æ®µï¼š${activeStage.action}</div>
      </div>
      <span class="hb ${hb.status} cs-hb">${esc(hb.label)}</span>
    </div>` : ''}

    <!-- æµç¨‹ç®¡çº¿ -->
    <div class="m-pipe">
      ${stages.map((s,i) => `
        <div class="mp-stage">
          <div class="mp-node ${s.status}">
            ${s.status==='done' ? '<div class="mp-done-tick">âœ“</div>' : ''}
            <div class="mp-icon">${s.icon}</div>
            <div class="mp-dept" style="${s.status==='active'?'color:var(--acc)':s.status==='done'?'color:var(--ok)':''}">${s.dept}</div>
            <div class="mp-action">${s.action}</div>
          </div>
          ${i < stages.length-1 ? `<div class="mp-arrow" style="${s.status==='done'?'color:var(--ok);opacity:.6':''}">â†’</div>` : ''}
        </div>
      `).join('')}
    </div>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="m-section">
      <div class="m-rows">
        <div class="m-row"><div class="mr-label">çŠ¶æ€</div><div class="mr-val"><span class="tag st-${t.state}">${STATE_LABEL[t.state]||t.state}</span></div></div>
        <div class="m-row"><div class="mr-label">æ‰§è¡Œéƒ¨é—¨</div><div class="mr-val"><span class="tag dt-${(t.org||'').replace(/\s/g,'')}">${esc(t.org||'â€”')}</span></div></div>
        ${t.eta&&t.eta!=='-'?`<div class="m-row"><div class="mr-label">é¢„è®¡å®Œæˆ</div><div class="mr-val">${esc(t.eta)}</div></div>`:''}
        ${t.block&&t.block!=='æ— '&&t.block!=='-'?`<div class="m-row"><div class="mr-label" style="color:var(--danger)">é˜»å¡é¡¹</div><div class="mr-val" style="color:var(--danger)">${esc(t.block)}</div></div>`:''}
        ${t.now&&t.now!=='-'?`<div class="m-row" style="grid-column:1/-1"><div class="mr-label">å½“å‰è¿›å±•</div><div class="mr-val" style="font-weight:400;font-size:12px">${esc(t.now)}</div></div>`:''}
        ${t.ac?`<div class="m-row" style="grid-column:1/-1"><div class="mr-label">éªŒæ”¶æ ‡å‡†</div><div class="mr-val" style="font-weight:400;font-size:12px">${esc(t.ac)}</div></div>`:''}
      </div>
    </div>

    <!-- æµè½¬æ—¥å¿— -->
    ${flowLog.length ? `
    <div class="m-section">
      <div class="m-sec-label">æµè½¬æ—¥å¿—ï¼ˆ${flowLog.length} æ¡ï¼‰</div>
      <div class="fl-timeline">
        ${flowLog.map(fl => {
          const col = deptColor(fl.from||'');
          const isOk = (fl.remark||'').includes('âœ…')||fl.to==='çš‡ä¸Š';
          const dotCls = isOk ? 'fl-ok' : (fl.from==='çš‡ä¸Š'||fl.to==='çš‡ä¸Š') ? 'fl-purple' : 'fl-blue';
          return `<div class="fl-item">
            <div class="fl-time">${fl.at?fl.at.substring(11,16):''}</div>
            <div class="fl-dot" style="background:${col}"></div>
            <div class="fl-content">
              <div class="fl-who">
                <span class="from" style="color:${col}">${esc(fl.from||'')}</span>
                <span style="color:var(--muted)"> â†’ </span>
                <span class="to" style="color:${deptColor(fl.to||'')}">${esc(fl.to||'')}</span>
              </div>
              <div class="fl-rem ${dotCls}">${esc(fl.remark||'')}</div>
            </div>
          </div>`
        }).join('')}
      </div>
    </div>` : '<div style="font-size:12px;color:var(--muted);padding:8px 0">æš‚æ— æµè½¬è®°å½•ï¼ˆä»»åŠ¡å¯åŠ¨åè‡ªåŠ¨å¡«å……ï¼‰</div>'}

    <!-- äº§å‡ºç‰© -->
    ${t.output&&t.output!=='-'&&t.output!==''?`
    <div class="m-section">
      <div class="m-sec-label">äº§å‡ºç‰©</div>
      <code>${esc(t.output)}</code>
    </div>`:''}
  `;

  document.getElementById('modal-bg').classList.add('open');
}

function closeModal(e){
  if(e&&e.target!==document.getElementById('modal-bg')&&!e.target.classList.contains('modal-close'))return;
  document.getElementById('modal-bg').classList.remove('open');
}

/* â•â• MODEL CONFIG â•â• */
const KNOWN_MODELS=[
  {id:'anthropic/claude-sonnet-4-6',l:'Claude Sonnet 4.6',p:'Anthropic'},
  {id:'anthropic/claude-opus-4-5',l:'Claude Opus 4.5',p:'Anthropic'},
  {id:'anthropic/claude-haiku-3-5',l:'Claude Haiku 3.5',p:'Anthropic'},
  {id:'openai/gpt-4o',l:'GPT-4o',p:'OpenAI'},
  {id:'openai/gpt-4o-mini',l:'GPT-4o Mini',p:'OpenAI'},
  {id:'openai-codex/gpt-5.3-codex',l:'GPT-5.3 Codex',p:'OpenAI Codex'},
  {id:'google/gemini-2.0-flash',l:'Gemini 2.0 Flash',p:'Google'},
  {id:'google/gemini-2.5-pro',l:'Gemini 2.5 Pro',p:'Google'},
];
function renderModels(cfg){
  if(!cfg||!cfg.agents){document.getElementById('model-grid').innerHTML='<div class="empty" style="grid-column:1/-1">è¯·ç¡®ä¿æœ¬åœ°æœåŠ¡å™¨å·²å¯åŠ¨</div>';return}
  const opts=KNOWN_MODELS.map(m=>`<option value="${m.id}">${m.l} (${m.p})</option>`).join('');
  document.getElementById('model-grid').innerHTML=cfg.agents.map(ag=>`
    <div class="mc-card">
      <div class="mc-top"><span class="mc-emoji">${ag.emoji||'ğŸ›ï¸'}</span>
        <div><div class="mc-name">${esc(ag.label)} <span style="font-size:11px;color:var(--muted)">${esc(ag.id)}</span></div><div class="mc-role">${esc(ag.role)}</div></div>
      </div>
      <div class="mc-cur">å½“å‰: <b>${esc(ag.model)}</b></div>
      <select class="msel" id="sel-${ag.id}" onchange="onMC('${ag.id}')">${opts}</select>
      <div class="mc-btns"><button class="btn btn-p" id="btn-${ag.id}" onclick="applyModel('${ag.id}')" disabled>åº”ç”¨</button><button class="btn btn-g" onclick="resetMC('${ag.id}')">é‡ç½®</button></div>
      <div class="mc-st" id="mcs-${ag.id}"></div>
    </div>`).join('');
  cfg.agents.forEach(ag=>{const s=document.getElementById('sel-'+ag.id);if(s)s.value=ag.model});
}
function onMC(id){const s=document.getElementById('sel-'+id),b=document.getElementById('btn-'+id),ag=agentConfig&&agentConfig.agents?agentConfig.agents.find(a=>a.id===id):null;if(!ag||!s)return;b.disabled=s.value===ag.model}
function resetMC(id){const s=document.getElementById('sel-'+id),b=document.getElementById('btn-'+id),ag=agentConfig&&agentConfig.agents?agentConfig.agents.find(a=>a.id===id):null;if(!ag||!s)return;s.value=ag.model;b.disabled=true}
async function applyModel(id){
  const s=document.getElementById('sel-'+id),b=document.getElementById('btn-'+id),st=document.getElementById('mcs-'+id);
  if(!s||!b)return;b.disabled=true;st.className='mc-st pending';st.textContent='âŸ³ æäº¤ä¸­â€¦';
  try{const r=await postJ(API+'/set-model',{agentId:id,model:s.value});
    if(r.ok){st.className='mc-st ok';st.textContent='âœ… å·²æäº¤ï¼ŒGateway é‡å¯ä¸­ï¼ˆçº¦5ç§’ï¼‰';toast(id+'æ¨¡å‹å·²æ›´æ”¹','ok');setTimeout(()=>loadAgentConfig(),5500)}
    else{st.className='mc-st err';st.textContent='âŒ '+( r.error||'é”™è¯¯');b.disabled=false}
  }catch(e){st.className='mc-st err';st.textContent='âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨';b.disabled=false}
}
function renderCL(log){
  const el=document.getElementById('cl-list');
  if(!log||!log.length){el.innerHTML='<div style="font-size:12px;color:var(--muted);padding:8px 0">æš‚æ— å˜æ›´</div>';return}
  el.innerHTML=[...log].reverse().slice(0,15).map(e=>`<div class="cl-row"><span class="cl-t">${esc((e.at||'').substring(0,16).replace('T',' '))}</span><span class="cl-a">${esc(e.agentId||'')}</span><span class="cl-c"><b>${esc(e.oldModel||'')}</b> â†’ <b>${esc(e.newModel||'')}</b></span></div>`).join('')
}

/* â•â• SKILLS â•â• */
function renderSkills(cfg){
  if(!cfg||!cfg.agents){document.getElementById('skills-grid').innerHTML='<div class="empty">æ— æ³•åŠ è½½</div>';return}
  document.getElementById('skills-grid').innerHTML=cfg.agents.map(ag=>`
    <div class="sk-card"><div class="sk-hdr"><span class="sk-emoji">${ag.emoji||'ğŸ›ï¸'}</span><span class="sk-name">${esc(ag.label)}</span><span class="sk-cnt">${(ag.skills||[]).length} æŠ€èƒ½</span></div>
    <div class="sk-list">${!(ag.skills||[]).length?'<div class="sk-empty">æš‚æ—  Skills</div>':(ag.skills||[]).map(sk=>`<div class="sk-item"><span class="si-name">ğŸ“¦ ${esc(sk.name)}</span><span class="si-desc">${esc(sk.description||'æ— æè¿°')}</span></div>`).join('')}</div></div>`).join('')
}

/* â•â• DATA LOADING â•â• */
async function loadLive(){
  try{
    liveStatus=await fetchJ(API+'/live-status');
    const tasks=liveStatus.tasks||[];
    const sync=liveStatus.syncStatus||{};
    const cs=document.getElementById('chip-sync');
    cs.textContent=sync.ok?'âœ… åŒæ­¥æ­£å¸¸':'âš ï¸ åŒæ­¥å¼‚å¸¸';
    cs.className='chip '+(sync.ok?'ok':'warn');
    renderEdicts(tasks);
    renderMonitor(tasks);
  }catch(e){
    document.getElementById('chip-sync').textContent='âŒ æœåŠ¡å™¨æœªå¯åŠ¨';
    document.getElementById('chip-sync').className='chip err';
  }
}
async function loadAgentConfig(){
  try{
    agentConfig=await fetchJ(API+'/agent-config');
    renderModels(agentConfig);
    renderSkills(agentConfig);
    const log=await fetchJ(API+'/model-change-log').catch(()=>[]);
    renderCL(log);
  }catch(e){
    document.getElementById('model-grid').innerHTML='<div class="empty" style="grid-column:1/-1">âš ï¸ è¯·å…ˆå¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼š<code>python3 dashboard/server.py</code></div>';
  }
}
async function loadAll(){await loadLive();if(['models','skills'].includes(activeTab))await loadAgentConfig()}

/* â•â• TABS â•â• */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');activeTab=t.dataset.tab;
  document.getElementById('panel-'+activeTab).classList.add('active');
  if(['models','skills'].includes(activeTab))loadAgentConfig();
}));

/* â•â• COUNTDOWN (5s) â•â• */
function startCd(){
  countdown=5;
  const el=document.getElementById('cd');
  const iv=setInterval(()=>{
    countdown--;el.textContent='âŸ³ '+countdown+'s';
    if(countdown<=0){clearInterval(iv);loadAll().then(()=>{el.textContent='';startCd()})}
  },1000);
}

/* â•â• KEY â•â• */
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.getElementById('modal-bg').classList.remove('open')});

/* â•â• INIT â•â• */
loadAll();
startCd();
</script>
</body>
</html>
